
# W-068, W-069, W-070: View: Create Responsive Navigation System with Sidebar, Site Nav Pulldown, Breadcrumb

## Overview

Design and implement a unified navigation system for the jPulse Framework consisting of:
- W-068: Responsive sidebar navigation
- W-069: Site navigation pulldown and hamburger menu
- W-070: Breadcrumb navigation

## Architecture Decision: Configuration-Based Navigation

### Core Concept
- Navigation structure defined in `webapp/view/jpulse-navigation.tmpl` template
- Site override via `site/webapp/view/jpulse-navigation.tmpl`
- Tab structures also defined in `jpulse-navigation.tmpl` for consistency
- Auto-initialization in `jpulse-footer.tmpl`
- Full Handlebars support with `{{#if}}` conditionals for dynamic navigation
- No JavaScript required from site developers (unless using SPAs)

### Navigation Data Structure

Defined in `webapp/view/jpulse-navigation.tmpl`:

```javascript
window.jPulseSiteNavigation = {
    {{#if user.authenticated}}
    admin: {
        label: '{{i18n.navigation.admin}}',  // i18n resolved server-side
        url: '/admin/',
        role: 'admin',  // Role-based visibility
        icon: '‚öôÔ∏è',  // Optional: emoji or filename (e.g., 'config.svg')
        pages: {
            dashboard: {
                label: '{{i18n.navigation.admin.dashboard}}',
                url: '/admin/',
                icon: '‚öôÔ∏è'
            },
            config: {
                label: '{{i18n.navigation.admin.config}}',
                url: '/admin/config.shtml',
                icon: 'assets/admin/icons/config.svg'
            },
            users: {
                label: '{{i18n.navigation.admin.users}}',
                url: '/admin/users.shtml',
                icon: 'assets/admin/icons/users.svg'
            }
        }
    },
    {{/if}}
    jPulseDocs: {
        label: '{{i18n.navigation.jpulseDocs}}',
        url: '/jpulse-docs/',
        icon: 'üìñ',
        pages: {}  // Dynamically loaded via registerPages() for SPA
    }
};
```

**Key Features**:
- **Full Handlebars support**: Use `{{#if}}`, `{{#each}}`, `{{i18n.*}}` for dynamic navigation
- **Conditional visibility**: Use `{{#if user.authenticated}}` for auth-based sections
- **Plain text support**: Simple sites can use plain strings
- **Unlimited nesting**: Recursive `pages` structure (no max depth needed in app.conf)
- **Role-based visibility**: Optional `role` property hides items from unauthorized users
- **Optional icons**: Emoji, image file, or omit

### Icon Handling

**Three icon types supported**:

1. **Emoji**: Single character (e.g., `icon: 'üì¶'` or `icon: 'üîÑ'`)
   - Rendered directly inline
   - Scales with font size

2. **Image file**: Known extensions (.jpg, .png, .svg, .gif)
   - Example: `icon: 'docs-icon.svg'`
   - Resolved via PathResolver (supports site override)
   - Looks in `static/images/` or `static/icons/`
   - Sized to 16√ó16px (or scaled to font size)

3. **None**: Omit icon property
   - No icon displayed

### Auto-Initialization Pattern

**In `jpulse-footer.tmpl`** (after header HTML, before closing body):

```html
<!-- Include navigation structure definition -->
{{file.include "jpulse-navigation.tmpl"}}

<!-- Site Navigation Initialization -->
<script>
jPulse.dom.ready(() => {
    jPulse.UI.navigation.init({
        currentUrl: '{{url.pathname}}',
        userRoles: {{json user.roles}},
        navigation: window.jPulseSiteNavigation
    });
});
</script>
```

**Navigation structure passed from template**: `jpulse-navigation.tmpl` defines `window.jPulseSiteNavigation` with full Handlebars support for conditional rendering.

### SPA Dynamic Pages Registration

For SPAs that load navigation structure dynamically (e.g., markdown docs, websocket demos):

**In page JavaScript** (e.g., `jpulse-docs/index.shtml`):

```javascript
jPulse.dom.ready(() => {
    // Register dynamic pages for this navigation section
    jPulse.UI.navigation.registerPages('jPulseDocs', async () => {
        const response = await fetch('/api/1/markdown/jpulse/');
        const data = await response.json();
        // Return structure matching app.conf pages format
        return {
            overview: { label: 'Overview', url: '/jpulse-docs/' },
            installation: { label: 'Installation', url: '/jpulse-docs/installation' },
            gettingStarted: { label: 'Getting Started', url: '/jpulse-docs/getting-started' },
            // ... dynamically generated from data.files
        };
    });
});
```

**Or use helper for markdown conversion**:

```javascript
jPulse.dom.ready(() => {
    jPulse.UI.navigation.registerPages('jPulseDocs', async () => {
        const response = await fetch('/api/1/markdown/jpulse/');
        const data = await response.json();
        return jPulse.UI.navigation.helpers.convertMarkdownFilesToPages(data.files);
    });
});
```

**Performance**: Registration only activates when current URL starts with the section's URL.

### Page Includes

**Standard pages** (no sidebar):
```html
{{file.include "jpulse-header.tmpl"}}
<!-- page content -->
{{file.include "jpulse-footer.tmpl"}}
```

**Pages with sidebar**:
```html
{{file.include "jpulse-header.tmpl"}}
<!-- page content -->
{{file.include "jpulse-footer.tmpl" showSidebar=true sidebarContext="jPulseDocs"}}
```

## W-068: Responsive Sidebar

### Sidebar Strategy

**Conditional Sidebar (jpulse.net style)**:
- Control via `{{file.include "jpulse-footer.tmpl" showSidebar=true sidebarContext="jPulseDocs"}}`
- Different pages control sidebar visibility
- Performance: No sidebar overhead on pages that don't need it

**Always-On Sidebar Sites**:
- Include sidebar in all pages via template override
- Single navigation structure from `app.conf`
- Dynamic pages loaded via `registerPages()` for SPAs

### Content Behavior Options
- **Reflow**: Main content shifts right, sidebar pushes content
- **Overlay**: Sidebar covers part of main content
- **Auto** (default): Overlay on mobile (<768px), reflow on desktop (‚â•768px)

### Configuration
- CSS classes: `jp-sidebar-reflow`, `jp-sidebar-overlay`, `jp-sidebar-auto`
- Configurable via options object or CSS class override

### Sidebar Structure
- Renders navigation hierarchy recursively (unlimited depth)
- Follows `app.conf` view.navigation structure
- Supports dynamic page expansion for SPAs
- Role-based item visibility

## W-069: Site Navigation Pulldown & Hamburger

### Desktop Experience
- **Trigger**: Hover over site icon and app name in header
- **1st level**: Dropdown panel shows top-level navigation items (from `app.conf`)
- **2nd+ levels**: Hover over item with sub-pages ‚Üí submenu appears to the right
- **Recursive**: Unlimited nesting supported (follows `app.conf` structure)
- **Smooth animations**: CSS transitions for dropdown reveal
- **Keyboard navigation**: Arrow keys and Enter support

### Mobile Experience (<768px)
- **Hamburger menu** consolidates:
  - Site navigation sections
  - User menu (login/profile/logout)
  - Optional: Sidebar content (if on page with sidebar)
- **Touch-friendly**: Larger tap targets, adequate spacing
- **Slide-in animation**: Smooth panel transition
- **Backdrop overlay**: Semi-transparent overlay when menu open

### URL Matching for Active States
- **Exact match**: `/admin/config.shtml` matches navigation item
- **Parent fallback**: `/admin/foo.shtml` not in nav ‚Üí highlights parent `/admin/`
- **Breadcrumb trail**: Shows path through navigation hierarchy
- **No regex needed**: Simple "starts with" matching

### Role-Based Visibility
- Items with `role` property check user roles
- Hidden if user lacks required role
- CSS class: `jp-nav-role-{rolename}`
- Default hidden, shown via CSS when role present

### No Home Duplication
- Header already has logo and app name linking to home
- Site navigation focuses on content sections
- Cleaner UX without redundancy

## W-070: Breadcrumb Navigation

### Auto-Generation
- **Based on**: Navigation hierarchy from `app.conf` + current URL
- **Starting point**: Home (icon + app name in header)
- **URL matching**:
  - Exact match: `/admin/config.shtml` ‚Üí Home > Admin > Config
  - Parent fallback: `/admin/foo.shtml` not in nav ‚Üí Home > Admin > (current page)
  - Deep nesting: Follows navigation hierarchy recursively

### Display Format
- **Separator**: `>` or custom icon
- **Clickable**: All items except current page are links
- **Current page**: Non-link, styled differently
- **Responsive**: Collapse on mobile (show only parent + current)

### Position
- **Fixed location**: Between header and main content (industry standard)
- **Rationale**:
  - Don't make me think - one consistent location across all jPulse sites
  - Standard web convention - users expect breadcrumbs here
  - No configuration complexity needed
- **Implementation**: Render in `jpulse-breadcrumb.tmpl` or append to `jpulse-header.tmpl`
- **Mobile**: Smaller font, truncate with ellipsis if needed: `Home > ... > Current Page`

### i18n Integration
- Labels already resolved by `view.load` controller
- Consistent with navigation structure
- Falls back to URL segment if no nav match

### Configuration
- **Simple boolean toggle**: `appConfig.view.pageDecoration.showBreadcrumbs`
- **No position config**: Fixed position eliminates complexity
- Auto-rendered in header area (below site nav)
- No manual configuration per page needed

## Implementation Benefits

### Developer Experience
- **Simple**: Navigation structure in familiar `app.conf` location
- **Discoverable**: No hidden configuration files
- **Override-friendly**: Site overrides via `site/webapp/app.conf`
- **No JavaScript required**: Works out of the box for static sites
- **SPA support**: Optional `registerPages()` for dynamic content

### Technical Advantages
- **Single source of truth**: `jpulse-navigation.tmpl` for both site nav and tab structures
- **Full Handlebars power**: Use `{{#if}}`, `{{#each}}`, `{{i18n.*}}` for dynamic navigation
- **Conditional rendering**: Auth-based sections with `{{#if user.authenticated}}`
- **Extensible**: Recursive structure supports unlimited nesting
- **Performance**: Static navigation renders fast, dynamic loads only when needed
- **Role-based**: Built-in visibility control via `role` property
- **Icon support**: Emoji or image files with site override

### Integration Points
- **Existing SPA systems**: `/jpulse-docs/`, `/hello-websocket/` use `registerPages()`
- **Tab navigation**: Tab structures defined in `jpulse-navigation.tmpl` using `window.jPulseTabsNavigation`
- **Role-based access**: Integrated with existing auth system
- **Mobile responsive**: Unified hamburger menu for all navigation
- **Auto-detect active tab**: `jPulse.UI.tabs.register()` auto-detects from URL

## Key Design Principles

1. **Don't Make Me Think**: Navigation structure in single template (`jpulse-navigation.tmpl`)
2. **Performance First**: Dynamic content only when on SPA URLs
3. **Flexible**: Supports MPA, SPA, conditional sidebar, always-on sidebar, full Handlebars conditionals
4. **No Hardcoding**: URL patterns detected, not hardcoded
5. **Unified Structure**: Site nav and tabs in same template for consistency
6. **Recursive from Start**: No artificial depth limits

## Implementation Phases

### Phase 1: W-069-A (Site Nav Dropdown - Desktop)
**Goal**: Replace need for complex tab navigation with clean dropdown

**Deliverables**:
1. Create `webapp/view/jpulse-navigation.tmpl` for navigation structure
2. Implement `jPulse.UI.navigation` in `jpulse-common.js`
3. Add initialization to `jpulse-footer.tmpl`
4. CSS styling in `jpulse-common.css`
5. Icon rendering (emoji + image file support)
6. Role-based visibility
7. Recursive menu rendering (unlimited depth)
8. Unit tests + integration tests

**Files Modified**:
- `webapp/view/jpulse-navigation.tmpl` (new - navigation structure)
- `webapp/view/jpulse-footer.tmpl` (add nav init)
- `webapp/view/jpulse-common.js` (add jPulse.UI.navigation)
- `webapp/view/jpulse-common.css` (add nav styles)
- `webapp/tests/unit/utils/jpulse-ui-navigation.test.js` (new)

**Estimate**: 6-8 hours

### Phase 2: W-069-B (Mobile Hamburger Menu)
**Goal**: Mobile-responsive navigation

**Deliverables**:
1. Hamburger icon in header (<768px)
2. Slide-in menu panel
3. Backdrop overlay
4. Consolidate site nav + user menu
5. Touch-friendly spacing
6. Smooth animations

**Estimate**: 3-4 hours

### Phase 3: W-070 (Breadcrumbs)
**Goal**: Auto-generated breadcrumb navigation

**Deliverables**:
1. URL path parsing
2. Navigation hierarchy matching
3. Parent fallback logic
4. Breadcrumb rendering
5. Mobile collapse behavior

**Estimate**: 2-3 hours

### Phase 4: W-068 (Sidebar Navigation)
**Goal**: Optional left sidebar

**Deliverables**:
1. Sidebar rendering from navigation structure
2. Per-page control via include params
3. Reflow/overlay/auto modes
4. Integration with hamburger menu
5. SPA `registerPages()` support

**Estimate**: 4-6 hours

## Testing Strategy

### Unit Tests
- Navigation structure parsing
- Icon type detection (emoji vs file)
- Role visibility logic
- URL matching (exact + parent fallback)
- Recursive rendering
- Helper functions

### Integration Tests
- Navigation renders from `app.conf`
- i18n placeholders resolved
- Role-based items hidden/shown
- SPA `registerPages()` integration
- Mobile responsive behavior
- Keyboard navigation

### Manual Testing
- Desktop hover behavior
- Mobile hamburger menu
- Various screen sizes
- Role-based scenarios
- SPA page navigation
- Site override testing
