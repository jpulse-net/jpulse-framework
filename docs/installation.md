# jPulse Framework / Docs / Site Installation Guide v0.6.9

This guide covers creating and setting up jPulse sites for development and production environments.

> **Framework Development**: See [Framework Development Installation](dev/installation.md) for contributing to jPulse itself.

## Prerequisites

### Required
- **Node.js 18+** - JavaScript runtime
- **npm** - Package manager
- **MongoDB 4.4+** - Database (required for user management, configuration, and logging)

### Optional
- **nginx** - Web server (for production deployment)

## System Setup

### Node.js Installation (Red Hat Ecosystem)

For Red Hat Enterprise Linux, CentOS Stream, Rocky Linux, and Fedora systems:

```bash
# Install curl if not already installed
sudo dnf install -y curl

# Add NodeSource repository for Node.js 20.x LTS
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -

# Install Node.js and npm
sudo dnf install -y nodejs

# Verify installation
node --version  # Should show v20.x.x
npm --version   # Should show 10.x.x or higher
```

> **Why NodeSource?** The NodeSource repository provides the latest LTS versions with security updates and integrates well with Red Hat package management for production environments.

### MongoDB Installation (Red Hat Ecosystem)

MongoDB is required for user management, configuration, and logging:

```bash
# Create MongoDB repository file
sudo cat > /etc/yum.repos.d/mongodb-org-7.0.repo << 'EOF'
[mongodb-org-7.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/9/mongodb-org/7.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-7.0.asc
EOF

# Install MongoDB
sudo dnf install -y mongodb-org

# Start and enable MongoDB
sudo systemctl start mongod
sudo systemctl enable mongod

# Verify MongoDB is running
sudo systemctl status mongod
```

> **Note**: For production deployments, the `jpulse-setup` process will generate automated MongoDB setup scripts that create the necessary users and databases.

## Site Installation

### 1. Authentication Setup (Private Repository)

Currently, the jPulse Framework is in a private repository. You'll need a GitHub Personal Access Token:

1. Create a GitHub Personal Access Token with `read:packages` scope
2. Configure npm for GitHub Packages:

```bash
export GITHUB_TOKEN=your_github_token
echo "@peterthoeny:registry=https://npm.pkg.github.com" >> ~/.npmrc
echo "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" >> ~/.npmrc
```

> **Note**: Once the repository becomes public, authentication will not be required and you can omit this step 1.

### 2. Create New Site and Configure Site
```bash
# Install framework globally (run as root for production servers)
sudo npm install -g @peterthoeny/jpulse-framework
# else for service account/sysadmin user account:
#    npm install -g @peterthoeny/jpulse-framework

mkdir my-jpulse-site && cd my-jpulse-site
npx jpulse-setup
npm install
```

### 3. Start Development Server
```bash
# Start the development server
npm start
```

The application will be available at `http://localhost:8080`

### 4. Update Framework (When Needed)
```bash
# Update to latest framework version
npm run update

# Or manually:
npm update @peterthoeny/jpulse-framework
npx jpulse-sync
```

## Database Setup

### Development (Local)
For development, you only need a basic MongoDB installation:

**Red Hat/CentOS/Fedora:**
```bash
# Add MongoDB repository
sudo tee /etc/yum.repos.d/mongodb-org-4.4.repo << EOF
[mongodb-org-4.4]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/8/mongodb-org/4.4/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-4.4.asc
EOF

# Install MongoDB
sudo dnf install -y mongodb-org

# Start MongoDB service
sudo systemctl start mongod
sudo systemctl enable mongod
```

**Ubuntu/Debian:**
```bash
# Install MongoDB
sudo apt update
sudo apt install mongodb

# Start MongoDB service
sudo systemctl start mongodb
sudo systemctl enable mongodb
```

**macOS (using Homebrew):**
```bash
# Install MongoDB
brew tap mongodb/brew
brew install mongodb-community

# Start MongoDB service
brew services start mongodb/brew/mongodb-community
```

**Windows:**
1. Download MongoDB Community Server from [mongodb.com](https://www.mongodb.com/try/download/community)
2. Run the installer with default settings
3. MongoDB will start automatically as a Windows service

### Production (Automated)
For production deployment, use the automated setup generated by `jpulse-setup`:

#### Step 1: Configure Environment
```bash
# Copy environment template and customize
cp deploy/env.tmpl .env
# Edit .env with your actual passwords and settings
```

#### Step 2: Setup Database
```bash
# Load environment variables and run MongoDB setup
source .env
./deploy/mongodb-setup.sh
```

The `mongodb-setup.sh` script automatically:
- Creates MongoDB admin user (if not exists)
- Creates application database and user
- Sets up proper authentication and permissions
- Validates existing setup to avoid conflicts
- Provides safety checks and clear error messages

#### Step 3: Verify Database Setup
```bash
# Test database connection
mongosh $DB_NAME -u $DB_USER -p --eval "db.runCommand('ping')"
```

> **Important**: The database setup script must be run BEFORE starting the application in production mode.

> **See**: `deploy/README.md` for complete production deployment guide

### Manual Production Setup
For custom MongoDB configurations, see [Deployment Guide](deployment.md) for detailed manual setup instructions.

## Process Management

### Development Server Options

**Option 1: Simple Node.js (Recommended for beginners)**
```bash
npm start
```

**Option 2: PM2 with file watching (Recommended for active development)**
```bash
# Start with PM2 development configuration
pm2 start deploy/ecosystem.dev.config.js

# View logs
pm2 logs

# Stop when done
pm2 stop all
```

The PM2 development configuration includes:
- Automatic file watching and restart
- Debug mode support (`--inspect`)
- Local log files in `./logs/`
- Single instance (no clustering)

### Production Process Management

For production deployment, use the PM2 production configuration:

```bash
# After setting up environment and database
pm2 start deploy/ecosystem.prod.config.js

# Save PM2 configuration for auto-restart
pm2 save

# Setup PM2 to start on system boot
pm2 startup
```

The PM2 production configuration includes:
- Cluster mode with configurable instances
- System-level logging (`/var/log/jpulse/`)
- Memory monitoring and restart policies
- Health checks and graceful shutdown

> **Application User**: The deployment scripts support both creating a new dedicated `jpulse` user or using an existing admin/service account user. The `install-system.sh` script will prompt you to choose.

> **Note**: The number of PM2 instances is configured during `jpulse-setup` and can be adjusted in `deploy/ecosystem.prod.config.js`

## Web Server Configuration

### nginx + Apache Coexistence

For servers already running Apache, jPulse can be configured to run nginx alongside Apache using domain-based routing:

#### Architecture
- **Apache**: Handles existing domains on ports 80/443
- **nginx**: Runs on alternative ports (8080/8443) for jPulse
- **Apache Proxy**: Routes jPulse domain requests to nginx

#### Setup Process

1. **Configure nginx for alternative ports:**
   ```bash
   # nginx listens on 8080/8443 instead of 80/443
   # This is automatically configured by jpulse-setup
   ```

2. **Create Apache virtual host for your jPulse domain:**
   ```bash
   # Example for jpulse.net domain
   sudo cat > /etc/httpd/conf.d/jpulse-net.conf << 'EOF'
   <VirtualHost *:80>
       ServerName jpulse.net
       ServerAlias www.jpulse.net
       RewriteEngine On
       RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
   </VirtualHost>

   <VirtualHost *:443>
       ServerName jpulse.net
       ServerAlias www.jpulse.net

       SSLEngine on
       SSLCertificateFile /etc/letsencrypt/live/jpulse.net/fullchain.pem
       SSLCertificateKeyFile /etc/letsencrypt/live/jpulse.net/privkey.pem

       ProxyPreserveHost On
       ProxyPass / http://127.0.0.1:8080/
       ProxyPassReverse / http://127.0.0.1:8080/

       ProxyAddHeaders On
       RequestHeader set X-Forwarded-Proto "https"
       RequestHeader set X-Real-IP %{REMOTE_ADDR}s
   </VirtualHost>
   EOF

   # Test and restart Apache
   sudo httpd -t
   sudo systemctl restart httpd
   ```

3. **SSL Certificate Setup:**
   ```bash
   # Get SSL certificates using Apache (since it's already on ports 80/443)
   sudo certbot --apache -d jpulse.net -d www.jpulse.net
   ```

#### Benefits
- ✅ **No port conflicts**: Both services coexist peacefully
- ✅ **Standard ports**: jPulse accessible on standard 80/443
- ✅ **Existing sites unaffected**: Apache continues serving other domains
- ✅ **Performance**: nginx optimized for Node.js proxying

#### Request Flow
```
Internet → Apache (80/443) → nginx (8080/8443) → jPulse App (8081) → MongoDB
```

## Site Configuration

### Configuration Structure
jPulse uses a layered configuration system:

1. **Framework defaults**: `webapp/app.conf` (managed by framework)
2. **Site overrides**: `site/webapp/app.conf` (your customizations)

The `jpulse-setup` command automatically generates `site/webapp/app.conf` based on your deployment type.

### Development Configuration
For development deployment, `site/webapp/app.conf` contains minimal overrides:

```javascript
{
    app: {
        name: 'My Site Name',
        shortName: 'My Site',
        siteId: 'my-site-id'
    },

    deployment: {
        mode: 'dev'  // Uses framework defaults for dev
    },

    middleware: {
        session: {
            secret: 'your-session-secret'
        }
    }
    // Framework provides: port 8080, database jp-dev, etc.
}
```

### Production Configuration
For production deployment, `site/webapp/app.conf` includes environment variable references:

```javascript
{
    app: {
        name: 'My Site Name',
        shortName: 'My Site',
        siteId: 'my-site-id'
    },

    deployment: {
        mode: 'prod'  // Uses framework defaults for prod
    },

    middleware: {
        session: {
            secret: '%ENV:SESSION_SECRET%',
            cookie: {
                secure: true,
                maxAge: 3600000
            }
        }
    },

    database: {
        mode: 'standalone',
        standalone: {
            options: {
                authSource: '%DB_NAME%',
                auth: {
                    username: '%ENV:DB_USER%',
                    password: '%ENV:DB_PASS%'
                }
            }
        }
    }
}
```

> **Key Concept**: Site configuration only needs to override framework defaults. The framework provides sensible defaults for ports, database names, and other settings based on `deployment.mode`.

## Site Customization

Your site structure is automatically created by `jpulse-setup`. To add custom functionality:
- **Controllers**: Create `site/webapp/controller/[name].js`
- **Views**: Create `site/webapp/view/[path]/[name].shtml`
- **Models**: Create `site/webapp/model/[name].js`
- **Assets**: Place in `site/webapp/static/[path]/`

### Verify Customizations
Restart the server and check that your customizations are loaded:

```bash
npm start
# Your site overrides will automatically take priority
```

## Troubleshooting

### Common Issues

**Port already in use:**
```bash
# Find process using port 8080
lsof -i :8080

# Kill the process or change port in app.conf
```

**MongoDB connection failed:**
- Verify MongoDB is running: `sudo systemctl status mongod`
- Check connection settings in `site/webapp/app.conf`
- Ensure database name doesn't contain invalid characters
- Check MongoDB logs: `sudo journalctl -u mongod`

**Database setup script issues:**
```bash
# If mongodb-setup.sh fails, check environment variables
echo "DB_NAME: $DB_NAME"
echo "DB_USER: $DB_USER"
echo "DB_ADMIN_USER: $DB_ADMIN_USER"

# Verify MongoDB is accessible
mongosh admin --eval "db.runCommand('ping')"

# Check if users already exist
mongosh admin --eval "db.getUsers()"
```

**PM2 process issues:**
```bash
# Check PM2 status
pm2 status

# View application logs
pm2 logs

# Restart application
pm2 restart all

# If PM2 config fails, check file paths
ls -la deploy/ecosystem.*.config.js
```

**Permission errors:**
```bash
# Fix npm permissions (Unix/macOS)
sudo chown -R $(whoami) ~/.npm

# Or use npm's built-in fix
npm config set prefix ~/.npm-global
```

**Test failures:**
- Ensure no other jPulse instances are running
- Clear any test databases: `npm run test:cleanup`
- Check Node.js version: `node --version` (should be 18+)

### Getting Help

- Check the [troubleshooting guide](troubleshooting.md) for common issues
- Review [getting started tutorial](getting-started.md) for next steps
- See [deployment guide](deployment.md) for production setup

---

*Next: [Getting Started Guide](getting-started.md)*
