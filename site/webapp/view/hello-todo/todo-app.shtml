<!DOCTYPE html>
<!--
 * @name            jPulse Framework / Site / WebApp / View / Hello To-Do
 * @tagline         Demo To-Do MVC Application for Learning
 * @description     Complete Model-View-Controller example with MongoDB integration
 * @file            site/webapp/view/hello-todo/index.shtml
 * @version         1.6.8
 * @release         2026-02-05
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 1.7, Claude Sonnet 4
-->
<html {{appConfig.system.htmlAttrs}}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello To-Do MVC Demo - {{app.site.shortName}}</title>
    {{file.include "jpulse-header.tmpl"}}
    <style>
        .local-todo-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .local-todo-form input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--jp-theme-border-color, #ddd);
            border-radius: 4px;
            font-size: 16px;
            background: var(--jp-theme-bg-primary, #ffffff);
            color: var(--jp-theme-text-primary, #333);
        }

        .local-todo-form button {
            padding: 12px 20px;
            background: var(--jp-theme-color-primary, #007bff);
            color: var(--jp-theme-text-inverse, #ffffff);
            border: 1px solid var(--jp-theme-color-primary, #007bff);
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .local-todo-form button:hover {
            background: var(--jp-theme-color-primary-hover, #0056b3);
        }

        .local-todo-form button:disabled {
            background: var(--jp-theme-color-secondary, #6c757d);
            cursor: not-allowed;
        }

        .local-todo-list {
            list-style: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .local-todo-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--jp-theme-border-color, #dee2e6);
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--jp-theme-bg-primary, #ffffff);
            transition: all 0.2s ease;
        }

        .local-todo-item:hover {
            box-shadow: var(--jp-theme-shadow-sm, 0 2px 8px rgba(0,0,0,0.1));
        }

        .local-todo-item.completed {
            background: var(--jp-theme-bg-secondary, #f8f9fa);
            opacity: 0.7;
        }

        .local-todo-checkbox {
            margin-right: 15px;
            transform: scale(1.3);
            cursor: pointer;
        }

        .local-todo-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .local-todo-title {
            font-size: 16px;
            margin: 0 0 5px 0;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .local-todo-title.completed {
            text-decoration: line-through;
            color: var(--jp-theme-text-muted, #6c757d);
            opacity: 0.8;
        }

        .local-todo-meta {
            font-size: 12px;
            color: var(--jp-theme-text-muted, #6c757d);
        }

        .local-todo-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--jp-theme-text-secondary, #6c757d);
        }

        .local-todo-loading.jp-hidden {
            display: none;
            margin-left: 10px;
            /* vertical-align: middle; */
        }

        @media (max-width: 600px) {
            .local-todo-form {
                flex-direction: column;
            }

            .local-todo-stats {
                flex-direction: column;
                gap: 10px;
            }

            .local-todo-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .local-todo-delete {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="jp-main">
        <div class="jp-container-1000">
            <div class="jp-page-header">
                <h1>üìã To-Do MVC Demo</h1>
            </div>

            <!-- Sub-navigation -->
            <nav class="jp-btn-nav-group">
                <a href="/hello-todo/" class="jp-btn jp-btn-outline">üìñ Overview</a>
                <span class="jp-btn-nav-arrow">‚Üí</span>
                <a href="/hello-todo/todo-app.shtml" class="jp-btn jp-btn-outline jp-btn-active">‚úÖ To-Do App</a>
                <span class="jp-btn-nav-arrow">‚Üí</span>
                <a href="/hello-todo/code-examples.shtml" class="jp-btn jp-btn-outline">üíª Code Examples</a>
                <span class="jp-btn-nav-arrow">‚Üí</span>
                <a href="/hello-todo/architecture.shtml" class="jp-btn jp-btn-outline">üèóÔ∏è Architecture</a>
            </nav>

            <!-- Educational Info Box -->
            <div class="jp-info-box">
                <h3>üéì Learning: Complete Model-View-Controller Pattern</h3>
                <p>This demonstrates a full MVC trio with MongoDB integration. Perfect for understanding jPulse Framework patterns!</p>

                <div class="jp-mt-15 jp-mb-15">
                    <strong>What you're seeing:</strong>
                    <ul class="jp-mt-15">
                        <li><strong>Model:</strong> <code>site/webapp/model/helloTodo.js</code> - Database schema, validation, CRUD operations</li>
                        <li><strong>Controller:</strong> <code>site/webapp/controller/helloTodo.js</code> - REST API endpoints (GET, POST, PUT, DELETE)</li>
                        <li><strong>View:</strong> <code>site/webapp/view/hello-todo/index.shtml</code> - This interactive UI</li>
                    </ul>
                </div>

                <div class="jp-help-text">
                    <strong>üöÄ Clone for Your Own MVC:</strong>
                    <ol class="jp-mt-15 jp-text-left">
                        <li>Copy the three files above and rename them (e.g., <code>myApp.js</code>)</li>
                        <li>Change the collection name in the model (e.g., <code>myApps</code>)</li>
                        <li>Update the API endpoints in the controller (e.g., <code>/api/1/my-app</code>)</li>
                        <li>Customize the view for your data structure</li>
                        <li>Add your new route to the navigation</li>
                    </ol>
                </div>
            </div>

            <!-- User Context Display -->
            {{#if user.isAuthenticated}}
            <div class="jp-card">
                <h3>üëã Hello {{user.firstName}} {{user.lastName}}!</h3>
                <p>Your to-dos will be tagged with your username: <strong>{{user.username}}</strong></p>
            </div>
            {{else}}
            <div class="jp-card">
                <h3>üë§ Guest Mode</h3>
                <p>You're using the demo as a guest. <a href="/auth/login.shtml">Sign in</a> to personalize your to-dos!</p>
            </div>
            {{/if}}

            <!-- To-Do Statistics -->
            <div class="jp-stats-grid jp-hidden" id="todoStats">
                <div class="jp-stat-card">
                    <div class="jp-stat-number" id="totalCount">0</div>
                    <div class="jp-stat-label">Total</div>
                </div>
                <div class="jp-stat-card">
                    <div class="jp-stat-number" id="completedCount">0</div>
                    <div class="jp-stat-label">‚úÖ Completed</div>
                </div>
                <div class="jp-stat-card">
                    <div class="jp-stat-number" id="pendingCount">0</div>
                    <div class="jp-stat-label">‚¨ú Pending</div>
                </div>
            </div>

            <!-- Add To-do Form -->
            <div class="jp-card">
                <h3>‚ûï Add New To-Do</h3>
                <form class="local-todo-form" id="todoForm">
                    <input type="text"
                           id="todoTitle"
                           class="jp-form-input"
                           placeholder="What needs to be done?"
                           maxlength="200"
                           required>
                    <button type="submit" id="addButton" class="jp-btn jp-btn-primary">Add To-Do</button>
                </form>
            </div>

            <!-- To-do List -->
            <div class="jp-card">
                <h3>üìã All To-Dos <span id="loadingSpinner" class="local-todo-loading jp-hidden"><img src="/images/icons/spinner-16.gif" alt="" width="16" height="16" /></span></h3>
                <p class="jp-help-text">üí° <strong>Tip:</strong> Click the checkbox to mark a to-do as completed. Click the ‚úï button to delete it.</p>
                <div class="local-todo-empty jp-hidden" id="emptyMessage">
                    <p>üéâ No to-dos yet! Add one above to get started.</p>
                </div>
                <ul class="local-todo-list" id="todoList"></ul>
            </div>

            <!-- Navigation -->
            <div class="jp-btn-nav-group">
                <a href="/" class="jp-btn jp-btn-outline">üè† Home</a>
                <span class="jp-btn-nav-arrow">‚Üí</span>
                <a href="/hello/" class="jp-btn jp-btn-outline">üåê Hello World Site Demos</a>
                <span class="jp-btn-nav-arrow">‚Üí</span>
                <a href="/hello-todo/" class="jp-btn jp-btn-active">üìã To-Do MVC Demo</a>
            </div>
        </div>
    </div>

    <script>
        // Hello Todo MVC Demo - Client-side JavaScript
        class HelloTodoApp {
            constructor() {
                this.todos = [];
                this.loading = false;
                this.init();
            }

            async init() {
                this.bindEvents();
                await this.loadTodos();
            }

            bindEvents() {
                const form = document.getElementById('todoForm');
                form.addEventListener('submit', (e) => this.handleAddTodo(e));
            }

            async loadTodos() {
                try {
                    this.setLoading(true);
                    const response = await jPulse.api.call('/api/1/helloTodo', {
                        method: 'GET'
                    });

                    if (response.success) {
                        this.todos = response.data || [];
                        this.updateStats(response.stats || { total: 0, completed: 0, pending: 0 });
                        this.renderTodos();
                    } else {
                        throw new Error(response.message || 'Failed to load to-dos');
                    }
                } catch (error) {
                    console.error('Error loading to-dos:', error);
                    jPulse.UI.toast.error('Failed to load to-dos: ' + error.message);
                } finally {
                    this.setLoading(false);
                }
            }

            async handleAddTodo(e) {
                e.preventDefault();
                console.log('üöÄ Form submitted - handleAddTodo called');

                const titleInput = document.getElementById('todoTitle');
                const title = titleInput.value.trim();
                console.log('üìù To-do title:', title);

                if (!title) {
                    jPulse.UI.toast.error('Please enter a to-do title');
                    return;
                }

                try {
                    const addButton = document.getElementById('addButton');
                    addButton.disabled = true;
                    addButton.textContent = 'Adding...';
                    console.log('üîÑ Sending POST request to API...');
                    console.log('üîç API Call Details:', {
                        url: '/api/1/helloTodo',
                        method: 'POST',
                        data: {
                            title: title,
                            userFirstName: '{{user.firstName}}',
                            userLastName: '{{user.lastName}}'
                        }
                    });

                    const response = await jPulse.api.call('/api/1/helloTodo', {
                        method: 'POST',
                        body: {
                            title: title,
                            userFirstName: '{{user.firstName}}',
                            userLastName: '{{user.lastName}}'
                        }
                    });
                    console.log('üì° API Response:', response);

                    if (response.success) {
                        titleInput.value = '';
                        jPulse.UI.toast.success('To-do added successfully!');
                        await this.loadTodos(); // Reload to get updated stats
                    } else {
                        throw new Error(response.message || 'Failed to add to-do');
                    }
                } catch (error) {
                    console.error('Error adding to-do:', error);
                    jPulse.UI.toast.error('Failed to add to-do: ' + error.message);
                } finally {
                    const addButton = document.getElementById('addButton');
                    addButton.disabled = false;
                    addButton.textContent = 'Add To-Do';
                }
            }

            async toggleTodo(todoId) {
                try {
                    const response = await jPulse.api.call(`/api/1/helloTodo/${todoId}/toggle`, {
                        method: 'PUT'
                    });

                    if (response.success) {
                        // Update local state
                        const todoIndex = this.todos.findIndex(t => t._id === todoId);
                        if (todoIndex !== -1) {
                            this.todos[todoIndex] = response.data;
                            this.renderTodos();
                            await this.loadTodos(); // Reload to get updated stats
                        }
                    } else {
                        throw new Error(response.message || 'Failed to update to-do');
                    }
                } catch (error) {
                    console.error('Error toggling to-do:', error);
                    jPulse.UI.toast.error(error.message || 'Failed to update to-do');
                }
            }

            async deleteTodo(todoId) {
                const result = await jPulse.UI.confirmDialog({
                    message: 'Are you sure you want to delete this to-do?',
                    buttons: ['Cancel', 'Delete']
                });

                if (!result.confirmed) {
                    return;
                }

                try {
                    const response = await jPulse.api.call(`/api/1/helloTodo/${todoId}`, {
                        method: 'DELETE'
                    });

                    if (response.success) {
                        jPulse.UI.toast.success('To-do deleted successfully!');
                        await this.loadTodos(); // Reload to get updated list and stats
                    } else {
                        throw new Error(response.message || 'Failed to delete to-do');
                    }
                } catch (error) {
                    console.error('Error deleting to-do:', error);
                    jPulse.UI.toast.error(error.message || 'Failed to delete to-do');
                }
            }

            setLoading(loading) {
                this.loading = loading;
                const loadingSpinner = document.getElementById('loadingSpinner');
                const todoList = document.getElementById('todoList');
                const emptyMessage = document.getElementById('emptyMessage');

                todoList.style.display = 'block';
                if (loading) {
                    emptyMessage.classList.add('jp-hidden');
                    loadingSpinner.classList.remove('jp-hidden');
                } else {
                    loadingSpinner.classList.add('jp-hidden');
                }
            }

            updateStats(stats) {
                const totalElement = document.getElementById('totalCount');
                const completedElement = document.getElementById('completedCount');
                const pendingElement = document.getElementById('pendingCount');

                totalElement.textContent = stats.total;
                completedElement.textContent = stats.completed;
                pendingElement.textContent = stats.pending;

                // Add color classes (theme-aware)
                totalElement.className = 'jp-stat-number';
                completedElement.className = 'jp-stat-number jp-text-success';
                pendingElement.className = 'jp-stat-number jp-text-warning';

                const statsContainer = document.getElementById('todoStats');
                if (stats.total > 0) {
                    statsContainer.classList.remove('jp-hidden');
                } else {
                    statsContainer.classList.add('jp-hidden');
                }
            }

            renderTodos() {
                const todoList = document.getElementById('todoList');
                const emptyMessage = document.getElementById('emptyMessage');

                if (this.todos.length === 0) {
                    todoList.innerHTML = '';
                    emptyMessage.classList.remove('jp-hidden');
                    return;
                }

                emptyMessage.classList.add('jp-hidden');

                todoList.innerHTML = this.todos.map(todo => {
                    const createdDate = jPulse.date.formatLocalDate(todo.createdAt);
                    const userName = todo.userFirstName && todo.userLastName
                        ? `${todo.userFirstName} ${todo.userLastName}`
                        : todo.username;

                    return `
                        <li class="local-todo-item ${todo.completed ? 'completed' : ''}">
                            <input type="checkbox"
                                   class="local-todo-checkbox"
                                   ${todo.completed ? 'checked' : ''}
                                   onchange="todoApp.toggleTodo('${todo._id}')">
                            <div class="local-todo-content">
                                <div class="local-todo-title ${todo.completed ? 'completed' : ''}">${this.escapeHtml(todo.title)}</div>
                                <div class="local-todo-meta">
                                    Created by ${this.escapeHtml(userName)} on ${createdDate}
                                </div>
                            </div>
                            <button class="jp-btn jp-btn-danger jp-btn-sm" onclick="todoApp.deleteTodo('${todo._id}')">
                                ‚úï Delete
                            </button>
                        </li>
                    `;
                }).join('');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the app when the page loads
        let todoApp;
        jPulse.dom.ready(() => {
            todoApp = new HelloTodoApp();
        });
    </script>

    {{file.include "jpulse-footer.tmpl"}}
</body>
</html>
