// Architecture component, site/webapp/view/hello-websocket/templates/architecture.tmpl
/**
 * @name            jPulse Framework / Site / WebApp / View / Hello WebSocket / Templates / Architecture
 * @tagline         Architecture component of the WebSocket demo
 * @description     This component describes the architecture of the WebSocket demo
 * @file            site/webapp/view/hello-websocket/templates/architecture.tmpl
 * @version         1.6.2
 * @release         2026-01-30
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 1.7, Claude Sonnet 4
 */

window.helloWebSocketViews = window.helloWebSocketViews || {};

window.helloWebSocketViews.Architecture = {
    template: `
<div class="jp-card">
    <h2 class="jp-card-dialog-heading">ğŸ—ï¸ WebSocket Architecture</h2>

    <p>Understanding how the jPulse Framework WebSocket system works under the hood.</p>

    <!-- Overview -->
    <div class="jp-info-box">
        <h3>ğŸ¯ Architecture Goals</h3>
        <ul class="jp-list">
            <li><strong>Namespace Isolation</strong> - Multiple independent WebSocket channels</li>
            <li><strong>Enterprise Features</strong> - Auto-reconnect, health monitoring, statistics</li>
            <li><strong>Security</strong> - Optional authentication and role-based access</li>
            <li><strong>Scalability</strong> - Redis pub/sub for multi-server deployments</li>
            <li><strong>Developer Experience</strong> - Clean APIs, automatic handling of edge cases</li>
        </ul>
    </div>

    <!-- System Diagram -->
    <div class="jp-card jp-mt-30">
        <h3>ğŸ“Š System Overview</h3>

        <pre class="local-panel-pre local-panel-pre-lg local-panel-pre-compact">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT (Browser)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Vue Component                                                  â”‚
â”‚  â”œâ”€ jPulse.ws.connect('/api/1/ws/my-app')                       â”‚
â”‚  â”œâ”€ .onMessage((data) => { ... })                               â”‚
â”‚  â”œâ”€ .onStatusChange((status) => { ... })                        â”‚
â”‚  â””â”€ .send({ type: 'action', ... })                              â”‚
â”‚                                                                 â”‚
â”‚  WebSocket Client (jpulse-common.js)                            â”‚
â”‚  â”œâ”€ Connection management                                       â”‚
â”‚  â”œâ”€ Auto-reconnect with backoff                                 â”‚
â”‚  â”œâ”€ Persistent client UUID                                      â”‚
â”‚  â”œâ”€ Ping/pong health checks                                     â”‚
â”‚  â””â”€ Status tracking                                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ WebSocket Protocol (ws:// or wss://)
                 â”‚ Persistent bidirectional connection
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       SERVER (Node.js)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  HTTP Server (Express.js)                                       â”‚
â”‚  â””â”€ Upgrade request â†’ WebSocket                                 â”‚
â”‚                                                                 â”‚
â”‚  WebSocket Controller (webapp/controller/websocket.js)          â”‚
â”‚  â”œâ”€ Namespace registry                                          â”‚
â”‚  â”œâ”€ Client connection tracking                                  â”‚
â”‚  â”œâ”€ Authentication & authorization                              â”‚
â”‚  â”œâ”€ Message routing                                             â”‚
â”‚  â”œâ”€ Ping/pong health monitoring                                 â”‚
â”‚  â””â”€ Statistics & activity logging                               â”‚
â”‚                                                                 â”‚
â”‚  Your Controller (site/webapp/controller/myController.js)       â”‚
â”‚  â”œâ”€ Register namespace                                          â”‚
â”‚  â”œâ”€ onConnect handler                                           â”‚
â”‚  â”œâ”€ onMessage handler                                           â”‚
â”‚  â”œâ”€ onDisconnect handler                                        â”‚
â”‚  â””â”€ Broadcast methods                                           â”‚
â”‚                                                                 â”‚
â”‚  [Optional] Redis Pub/Sub                                       â”‚
â”‚  â””â”€ Coordinate across multiple server instances                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
    </div>

    <!-- Connection Lifecycle -->
    <div class="jp-card jp-mt-30">
        <h3>ğŸ”„ Connection Lifecycle</h3>

        <div class="local-panel">
            <h4 class="jp-m-0">1ï¸âƒ£ Initial Connection</h4>
            <ol class="jp-list">
                <li>Client generates or retrieves persistent UUID from localStorage</li>
                <li>Client initiates WebSocket connection: <code>ws://host/api/1/ws/my-app?uuid=xxx</code></li>
                <li>Server validates authentication (if required)</li>
                <li>Server stores client in namespace registry</li>
                <li><code>onConnect</code> handler called with clientId and user</li>
                <li>Client receives <code>status: 'connected'</code></li>
            </ol>
        </div>

        <div class="local-panel">
            <h4 class="jp-m-0">2ï¸âƒ£ Message Exchange</h4>
            <ol class="jp-list">
                <li>Client sends: <code>ws.send({type: 'action', data: ...})</code></li>
                <li>Server receives and validates message format</li>
                <li><code>onMessage</code> handler called with clientId, data, and user</li>
                <li>Handler processes and optionally broadcasts to other clients</li>
                <li>Clients receive: <code>{success: true, data: {...}, username: 'john'}</code></li>
            </ol>
        </div>

        <div class="local-panel">
            <h4 class="jp-m-0">3ï¸âƒ£ Health Monitoring</h4>
            <p class="jp-mt-15 jp-mb-0">Bidirectional ping/pong keeps connection alive:</p>
            <ul class="jp-list">
                <li><strong>Client â†’ Server:</strong> Ping every 30s, expect pong within 5s</li>
                <li><strong>Server â†’ Client:</strong> Ping every 30s, expect pong within 5s</li>
                <li>If no pong received, connection considered dead and terminated</li>
            </ul>
        </div>

        <div class="local-panel">
            <h4 class="jp-m-0">4ï¸âƒ£ Disconnection & Reconnection</h4>
            <ol class="jp-list">
                <li>Connection drops (network issue, server restart, etc.)</li>
                <li>Client detects disconnection: <code>status: 'reconnecting'</code></li>
                <li>Progressive backoff: 5s â†’ 10s â†’ 15s â†’ ... â†’ 30s (max)</li>
                <li>Client attempts reconnection (up to 10 times by default)</li>
                <li>On success: <code>status: 'connected'</code> + same client UUID</li>
                <li>On failure: <code>status: 'disconnected'</code> (manual reload needed)</li>
            </ol>
        </div>
    </div>

    <!-- Namespace System -->
    <div class="jp-card jp-mt-30">
        <h3>ğŸ—‚ï¸ Namespace Isolation</h3>
        <p>Multiple independent channels on a single WebSocket server:</p>

        <div class="local-panel">
            <pre class="local-panel-pre local-panel-pre-md jp-m-0"><code>// Each namespace is completely isolated
/api/1/ws/chat           â† Chat messages
/api/1/ws/notifications  â† System notifications
/api/1/ws/dashboard      â† Live metrics
/api/1/ws/game           â† Game state updates

// Different authentication requirements
/api/1/ws/public-chat         requireAuth: false
/api/1/ws/admin-dashboard     requireAuth: true, requireRoles: ['admin']</code></pre>
        </div>

        <p class="jp-mt-15">
            <strong>Benefits:</strong>
        </p>
        <ul class="jp-list">
            <li>Separate concerns (chat vs notifications vs dashboards)</li>
            <li>Independent authentication requirements</li>
            <li>Granular statistics and monitoring per namespace</li>
            <li>Easy to add/remove features without affecting others</li>
        </ul>
    </div>

    <!-- Message Flow Patterns -->
    <div class="jp-card jp-mt-30">
        <h3>ğŸ“¬ Message Flow Patterns</h3>

        <div class="local-panel">
            <h4 class="jp-m-0">Pattern 1: Broadcast to All</h4>
            <pre class="local-panel-pre local-panel-pre-compact jp-mt-15"><code>// Server broadcasts message to all connected clients in namespace
wsHandle.broadcast({
    type: 'notification',
    message: 'New feature released!'
});

// All clients receive it
ws.onMessage((data) => {
    if (data.type === 'notification') {
        showNotification(data.message);
    }
});</code></pre>
        </div>

        <div class="local-panel">
            <h4 class="jp-m-0">Pattern 2: Send to Specific Client</h4>
            <pre class="local-panel-pre local-panel-pre-compact jp-mt-15"><code>// Server sends to one specific client
wsHandle.sendToClient(clientId, {
    type: 'private-message',
    message: 'Just for you!'
});

// Only that client receives it</code></pre>
        </div>

        <div class="local-panel">
            <h4 class="jp-m-0">Pattern 3: REST API + WebSocket Hybrid</h4>
            <pre class="local-panel-pre local-panel-pre-compact jp-mt-15"><code>// Client calls REST API
const response = await jPulse.api.post('/api/1/todos', { title });

// Server processes via REST endpoint
static async apiCreate(req, res) {
    const todo = await TodoModel.create(req.body);

    // Broadcast via WebSocket
    wsHandle.broadcast({ type: 'todo-created', todo });

    // Return REST response
    res.json({ success: true, data: todo });
}

// All clients receive WebSocket notification
ws.onMessage((data) => {
    if (data.type === 'todo-created') {
        addTodoToList(data.todo);
    }
});</code></pre>
        </div>
    </div>

    <!-- Security -->
    <div class="jp-card jp-mt-30">
        <h3>ğŸ”’ Authentication & Authorization</h3>

        <div class="local-panel">
            <h4 class="jp-m-0">Session-Based Authentication</h4>
            <ol class="jp-list">
                <li>Client authenticates via standard login (sets session cookie)</li>
                <li>WebSocket upgrade request includes session cookie</li>
                <li>Server parses session during upgrade using Express session middleware</li>
                <li>If <code>requireAuth: true</code>, server validates user is logged in</li>
                <li>If <code>requireRoles: ['admin']</code>, server checks user has required role</li>
                <li>Connection rejected if authentication/authorization fails</li>
            </ol>

            <pre class="local-panel-pre local-panel-pre-compact jp-mt-15"><code>// Register namespace with authentication
WebSocketController.registerNamespace('/api/1/ws/admin-panel', {
    requireAuth: true,              // Must be logged in
    requireRoles: ['admin', 'root'], // Must have admin or root role

    onConnect: (clientId, user) => {
        // user object is guaranteed to exist here
        console.log(\`Admin \${user.username} connected\`);
    }
});</code></pre>
        </div>

        <div class="local-panel">
            <h4 class="jp-m-0">Username Tracking</h4>
            <p class="jp-mt-15 jp-mb-0">
                All messages automatically include <code>username</code> field:
            </p>
            <ul class="jp-list">
                <li>Authenticated user: <code>username: 'john_doe'</code></li>
                <li>Anonymous user: <code>username: ''</code> (empty string)</li>
                <li>System messages: <code>username: ''</code></li>
            </ul>
        </div>
    </div>

    <!-- Monitoring -->
    <div class="jp-card jp-mt-30">
        <h3>ğŸ“Š Monitoring & Statistics</h3>
        <p>Built-in monitoring for production operations:</p>

        <div class="local-panel">
            <h4 class="jp-m-0">Admin Dashboard</h4>
            <p class="jp-mt-15 jp-mb-0">
                View real-time statistics at <a href="/admin/websocket-stats.shtml" target="_blank">/admin/websocket-stats.shtml</a>
            </p>
            <ul class="jp-list">
                <li>Global uptime and total messages</li>
                <li>Per-namespace statistics (clients, messages, activity)</li>
                <li>Status indicators (active/idle/stale)</li>
                <li>Activity log (last 100 messages)</li>
            </ul>
        </div>

        <div class="local-panel">
            <h4 class="jp-m-0">Programmatic Access</h4>
            <pre class="local-panel-pre local-panel-pre-compact jp-mt-15"><code>// Get global statistics
const stats = WebSocketController.getStats();
// { uptime, totalMessages, namespaces: [...], activityLog: [...] }

// Get namespace-specific statistics
const nsStats = wsHandle.getStats();
// { clients, messages, lastActivity, activeUsers, ... }</code></pre>
        </div>
    </div>

    <!-- Scalability -->
    <div class="jp-card jp-mt-30">
        <h3>âš¡ Scalability: Multi-Server Support</h3>
        <p>Redis pub/sub enables WebSocket coordination across multiple servers:</p>

        <div class="local-panel">
            <pre class="local-panel-pre local-panel-pre-compact jp-m-0"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server 1    â”‚       â”‚  Server 2    â”‚       â”‚  Server 3    â”‚
â”‚  Client A    â”‚       â”‚  Client B    â”‚       â”‚  Client C    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚                      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Redis Pub/Sub   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client A broadcasts â†’ Server 1 publishes to Redis â†’ All servers receive
â†’ Server 2 sends to Client B, Server 3 sends to Client C</code></pre>

            <p class="jp-mt-15 jp-mb-0">
                <strong>Setup:</strong> Enable Redis in <code>app.conf</code> and the framework
                automatically coordinates broadcasts across all server instances.
            </p>
        </div>
    </div>

    <!-- Performance Best Practices -->
    <div class="jp-output jp-output-info jp-mt-30">
        <h3>âš¡ Performance Best Practices</h3>
        <ul class="jp-list">
            <li><strong>Throttle high-frequency events</strong> (mouse, scroll) to 50-100ms</li>
            <li><strong>Keep messages small</strong> - send only necessary data</li>
            <li><strong>Use message types</strong> for efficient routing and handling</li>
            <li><strong>Don't block handlers</strong> - use async/await for I/O operations</li>
            <li><strong>Clean up on disconnect</strong> - remove references to prevent memory leaks</li>
            <li><strong>Monitor statistics</strong> - watch for unusual patterns or high traffic</li>
        </ul>
    </div>

    <!-- Next Steps -->
    <div class="jp-output jp-output-warning jp-mt-30">
        <h3>ğŸš€ Next Steps</h3>
        <ol class="jp-list">
            <li>Try the <strong>Emoji Cursor</strong> and <strong>Collaborative Todo</strong> demos</li>
            <li>Review the <strong>Code Examples</strong> tab for implementation patterns</li>
            <li>Read the <a href="/jpulse-docs/websockets" target="_blank">complete WebSocket documentation</a></li>
            <li>Build your own real-time feature using these patterns</li>
            <li>Monitor your WebSocket namespaces at <a href="/admin/websocket-stats.shtml" target="_blank">/admin/websocket-stats</a> (requires admin role)</li>
        </ol>
    </div>
</div>
`

    // No props needed - static content only
};

// EOF site/webapp/view/hello-websocket/templates/architecture.tmpl
