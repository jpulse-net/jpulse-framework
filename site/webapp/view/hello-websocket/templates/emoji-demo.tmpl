// Emoji demo component, site/webapp/view/hello-websocket/templates/emoji-demo.tmpl
/**
 * @name            jPulse Framework / Site / WebApp / View / Hello WebSocket / Templates / Emoji Demo
 * @tagline         Emoji cursor demo component of the WebSocket demo
 * @description     This component is a emoji cursor app to demo the WebSocket features
 * @file            site/webapp/view/hello-websocket/templates/emoji-demo.tmpl
 * @version         1.6.1
 * @release         2026-01-28
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 1.7, Claude Sonnet 4
 */

window.helloWebSocketViews = window.helloWebSocketViews || {};

window.helloWebSocketViews.EmojiDemo = {
    data() {
        return {
            emojiWs: null,
            emojiStatus: 'disconnected',
            selectedEmoji: 'â¤ï¸',
            availableEmojis: ['â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ‘', 'ðŸŽ‰', 'ðŸ”¥', 'ðŸš€', 'âœ¨'],
            otherUsers: new Map(), // clientId -> {username, emoji, x, y}
            userCount: 0,
            _lastMouseSend: 0
        };
    },
    computed: {
        otherUsersArray() {
            // Convert Map to array, including clientId in each object
            return Array.from(this.otherUsers.entries()).map(([clientId, user]) => ({
                ...user,
                clientId
            }));
        }
    },
    methods: {
        connectEmojiWs() {
            if (this.emojiWs) return;

            this.emojiWs = jPulse.ws.connect('/api/1/ws/hello-emoji')
                .onMessage((data, message) => {
                    if (data) {
                        this.handleEmojiMessage(data);
                    } else {
                        console.error('Emoji WS error:', message.error);
                    }
                })
                .onStatusChange((status, oldStatus) => {
                    this.emojiStatus = status;
                });

            // Send initial emoji selection
            setTimeout(() => {
                if (this.emojiWs && this.emojiWs.isConnected()) {
                    this.emojiWs.send({
                        type: 'emoji-select',
                        emoji: this.selectedEmoji
                    });
                }
            }, 100);
        },

        disconnectEmojiWs() {
            if (this.emojiWs) {
                this.emojiWs.disconnect();
                this.emojiWs = null;
                this.emojiStatus = 'disconnected';
                this.otherUsers.clear();
            }
        },

        handleEmojiMessage(data) {
            if (data.type === 'welcome') {
                this.userCount = data.userCount || 1;
            } else if (data.type === 'user-emoji') {
                // Another user selected an emoji
                if (data.clientId && data.username) {
                    const existing = this.otherUsers.get(data.clientId) || {};
                    this.otherUsers.set(data.clientId, {
                        ...existing,
                        username: data.username,
                        emoji: data.emoji
                    });
                }
            } else if (data.type === 'cursor') {
                // Another user moved their cursor
                if (data.clientId && data.username) {
                    this.otherUsers.set(data.clientId, {
                        username: data.username,
                        emoji: data.emoji,
                        x: data.x,
                        y: data.y
                    });
                }
            } else if (data.type === 'user-left') {
                // Another user disconnected
                if (data.clientId) {
                    this.otherUsers.delete(data.clientId);
                }
                this.userCount = data.userCount || 0;
            }
        },

        selectEmoji(emoji) {
            this.selectedEmoji = emoji;
            if (this.emojiWs && this.emojiWs.isConnected()) {
                this.emojiWs.send({
                    type: 'emoji-select',
                    emoji: emoji
                });
            }
        },

        handleMouseMove(event) {
            if (!this.emojiWs || !this.emojiWs.isConnected()) return;

            const rect = event.currentTarget.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;

            // Throttle: only send if enough time has passed
            const now = Date.now();
            if (!this._lastMouseSend || now - this._lastMouseSend > 50) {
                this._lastMouseSend = now;
                this.emojiWs.send({
                    type: 'cursor-move',
                    emoji: this.selectedEmoji,
                    x: Math.round(x * 10) / 10,
                    y: Math.round(y * 10) / 10
                });
            }
        }
    },
    template: `
<div class="jp-card">
    <h2>ðŸ˜Š Emoji Cursor Demo</h2>

    <div class="jp-info-box">
        <h3>ðŸŽ¯ What This Demonstrates</h3>
        <p>Real-time cursor position tracking across multiple users. Move your mouse in the colored area below and watch other users' emojis move too!</p>

        <ul class="jp-list">
            <li><strong>Ephemeral tracking</strong> - No database, pure real-time broadcast</li>
            <li><strong>Position throttling</strong> - Updates every 50ms (not every pixel)</li>
            <li><strong>User presence</strong> - See who's connected right now</li>
            <li><strong>Smooth animations</strong> - CSS transitions for fluid movement</li>
        </ul>
    </div>

    <!-- Connection Status & Controls -->
    <div class="local-controls-row">
        <button v-if="!emojiWs"
                @click="connectEmojiWs"
                class="jp-btn jp-btn-primary">
            ðŸ”Œ Connect to Emoji Demo
        </button>

        <button v-if="emojiWs"
                @click="disconnectEmojiWs"
                class="jp-btn jp-btn-danger">
            ðŸ”Œ Disconnect
        </button>

        <div :class="['local-connection-status', emojiStatus]">
            <span :class="['local-status-dot', emojiStatus]"></span>
            <span>{{ emojiStatus.charAt(0).toUpperCase() + emojiStatus.slice(1) }}</span>
        </div>

        <div v-if="emojiWs && emojiStatus === 'connected'" class="jp-help-text jp-m-0">
            ðŸ‘¥ <strong>{{ userCount }}</strong> {{ userCount === 1 ? 'user' : 'users' }} online
        </div>
    </div>

    <!-- Emoji Selector -->
    <div v-if="emojiWs" class="jp-card">
        <h3>Select Your Emoji</h3>
        <div class="local-emoji-selector">
            <button v-for="emoji in availableEmojis"
                    :key="emoji"
                    @click="selectEmoji(emoji)"
                    :class="['local-emoji-btn', { selected: selectedEmoji === emoji }]"
                    :title="'Select ' + emoji">
                {{ emoji }}
            </button>
        </div>
        <p class="jp-help-text jp-mt-15 jp-mb-0">
            ðŸ’¡ Your selected emoji: <span class="local-emoji-selected">{{ selectedEmoji }}</span>
        </p>
    </div>

    <!-- Emoji Cursor Area -->
    <div v-if="emojiWs && emojiStatus === 'connected'" class="jp-card">
        <h3>Move Your Mouse Here!</h3>
        <p class="jp-help-text">See your emoji follow your cursor. Open another browser window to see other users!</p>

        <div class="local-emoji-area"
             @mousemove="handleMouseMove">

            <!-- Other users' cursors -->
            <div v-for="user in otherUsersArray"
                 :key="user.clientId || user.username"
                 class="local-emoji-cursor"
                 :style="{
                     left: user.x + '%',
                     top: user.y + '%'
                 }">
                {{ user.emoji }}
                <span class="username">{{ user.username || 'guest' }}</span>
            </div>

            <!-- Empty state -->
            <div v-if="otherUsersArray.length === 0" class="local-emoji-empty-state">
                <div class="local-emoji-empty-icon">ðŸ‘‹</div>
                <div class="local-emoji-empty-title">Move your mouse!</div>
                <div class="local-emoji-empty-subtitle">Open another browser window to see multiplayer magic âœ¨</div>
            </div>
        </div>
    </div>

    <!-- Instructions when not connected -->
    <div v-if="!emojiWs || emojiStatus !== 'connected'" class="jp-output jp-output-warning">
        <h3>ðŸ‘† Click "Connect" to Start</h3>
        <p>Once connected:</p>
        <ol class="jp-mt-15">
            <li>Select your favorite emoji</li>
            <li>Move your mouse in the colored area</li>
            <li>Open another browser window (or ask a friend!)</li>
            <li>Watch everyone's emojis move in real-time!</li>
        </ol>
    </div>

    <!-- Technical Details -->
    <div class="jp-card jp-mt-30">
        <h3>ðŸ”§ Technical Details</h3>

        <div class="local-tech-grid">
            <div>
                <h4 class="local-tech-label">Namespace</h4>
                <code class="local-tech-chip">/api/1/ws/hello-emoji</code>
            </div>

            <div>
                <h4 class="local-tech-label">Authentication</h4>
                <span class="local-tech-chip">Public (no auth required)</span>
            </div>

            <div>
                <h4 class="local-tech-label">Update Frequency</h4>
                <span class="local-tech-chip">20 msgs/second (50ms throttle)</span>
            </div>

            <div>
                <h4 class="local-tech-label">Persistence</h4>
                <span class="local-tech-chip">None (ephemeral)</span>
            </div>
        </div>

        <div class="local-panel">
            <h4 class="jp-m-0">Message Flow:</h4>
            <ol class="jp-mt-15">
                <li>Mouse moves â†’ throttled to 50ms intervals</li>
                <li>Client sends: <code>{type: 'cursor-move', emoji, x, y}</code></li>
                <li>Server broadcasts to all connected clients</li>
                <li>Other clients update their UI with your position</li>
            </ol>
        </div>
    </div>

    <div class="jp-output jp-output-info jp-mt-30">
        <h3>ðŸ’¡ Why Throttle?</h3>
        <p>
            Mouse events fire <strong>hundreds of times per second</strong>. Sending every single event
            would overwhelm the server and network. By throttling to 50ms (20 updates/second), we get
            smooth tracking while keeping bandwidth reasonable. This is a best practice for any
            real-time position tracking system!
        </p>
    </div>

    <div class="jp-output jp-output-warning jp-mt-30">
        <h3>ðŸŽ“ Learning Takeaways</h3>
        <ul class="jp-list">
            <li>WebSocket enables instant, bidirectional communication</li>
            <li>Throttling is essential for high-frequency events</li>
            <li>Ephemeral data doesn't need a database</li>
            <li>User presence is tracked automatically by the framework</li>
        </ul>
    </div>
</div>
`

};

// EOF Emoji demo component, site/webapp/view/hello-websocket/templates/emoji-demo.tmpl
