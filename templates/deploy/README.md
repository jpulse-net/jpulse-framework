# Deployment Guide - %SITE_NAME%, based on jPulse Framework v0.7.0

Generated by jpulse-setup on %GENERATION_DATE%

## Quick Start

### Development Deployment
```bash
# 1. Install dependencies
npm install

# 2. Start with PM2 (recommended)
pm2 start deploy/ecosystem.dev.config.js

# 3. Or start directly
npm run dev

# 4. Access your site
open http://localhost:%APP_PORT%
```

### Production Deployment

#### Prerequisites
- Red Hat Enterprise Linux 8+ (RHEL, Rocky Linux, CentOS, Fedora)
- Root access for system installation
- Domain name configured (DNS pointing to server)

#### Step 1: System Installation (Run as root)
```bash
# Install system packages and services
sudo ./deploy/install-system.sh
```

#### Step 2: Application Deployment (Run as jpulse user)
```bash
# Switch to application user
sudo -u jpulse -i

# Deploy application to /opt/jpulse/
cd /opt/jpulse
# ... copy your application files here ...

# Configure environment
cp deploy/env.tmpl .env
# Edit .env with your settings
```

#### Step 3: Database Setup (Run as jpulse user)
```bash
# Load environment variables
source .env

# Setup MongoDB
./deploy/mongodb-setup.sh
```

#### Step 4: Web Server Configuration (Run as root)
```bash
# Configure nginx
sudo cp deploy/nginx.prod.conf /etc/nginx/sites-available/%SITE_ID%
sudo ln -s /etc/nginx/sites-available/%SITE_ID% /etc/nginx/sites-enabled/

# Test and reload nginx
sudo nginx -t
sudo systemctl reload nginx
```

#### Step 5: Start Application (Run as jpulse user)
```bash
# Start with PM2
pm2 start deploy/ecosystem.prod.config.js

# Save PM2 configuration
pm2 save

# Setup PM2 startup (run as root)
sudo pm2 startup
```

## Configuration Files

### Application Configuration
- `site/webapp/app.conf` - Main application configuration
- `.env` - Environment variables (copy from `deploy/env.tmpl`)

### Deployment Scripts
- `deploy/install-system.sh` - System installation (run as root)
- `deploy/mongodb-setup.sh` - Database setup (run as jpulse user)

### Process Management
- `deploy/ecosystem.dev.config.js` - Development PM2 configuration
- `deploy/ecosystem.prod.config.js` - Production PM2 configuration (%PM2_INSTANCES% instances)

### Web Server
- `deploy/nginx.prod.conf` - Production nginx configuration with SSL

## Environment Variables

Copy `deploy/env.tmpl` to `.env` and customize:

```bash
# Required Variables
NODE_ENV=production
PORT=%APP_PORT%
DB_NAME=%DB_NAME%
DB_USER=%DB_USER%
DB_PASS=your_secure_password
DB_ADMIN_USER=%DB_ADMIN_USER%
DB_ADMIN_PASS=your_admin_password
SESSION_SECRET=%SESSION_SECRET%
```

## SSL Certificate Setup

### Option 1: Let's Encrypt (Recommended)
```bash
# Install certbot
sudo dnf install certbot python3-certbot-nginx

# Obtain certificate
sudo certbot --nginx -d %DOMAIN_NAME%

# Auto-renewal (already configured in system installation)
```

### Option 2: Custom Certificate
```bash
# Update nginx configuration with your certificate paths
# Edit deploy/nginx.prod.conf:
ssl_certificate /path/to/your/certificate.crt;
ssl_certificate_key /path/to/your/private.key;
```

## Monitoring and Maintenance

### PM2 Management
```bash
# Check application status
pm2 status

# View logs
pm2 logs %SITE_ID%-prod

# Restart application
pm2 restart %SITE_ID%-prod

# Monitor resources
pm2 monit
```

### Database Maintenance
```bash
# Connect to MongoDB
mongosh %DB_NAME% -u %DB_USER% -p

# Backup database
mongodump --host localhost --db %DB_NAME% --out /backup/$(date +%Y%m%d)

# Check database status
mongosh admin -u %DB_ADMIN_USER% -p --eval "db.runCommand('serverStatus')"
```

### Log Management
```bash
# Application logs
tail -f /var/log/jpulse/combined.log

# nginx logs
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# MongoDB logs
sudo tail -f /var/log/mongodb/mongod.log
```

## Troubleshooting

### Application Issues
```bash
# Check PM2 status
pm2 status

# View detailed logs
pm2 logs %SITE_ID%-prod --lines 100

# Restart application
pm2 restart %SITE_ID%-prod

# Check application configuration
node -e "console.log(JSON.stringify(require('./.jpulse/app.json'), null, 2))"
```

### Database Issues
```bash
# Check MongoDB status
sudo systemctl status mongod

# Check MongoDB logs
sudo tail -f /var/log/mongodb/mongod.log

# Test database connection
mongosh %DB_NAME% -u %DB_USER% -p --eval "db.runCommand('ping')"

# Re-run database setup
source .env && ./deploy/mongodb-setup.sh
```

### Web Server Issues
```bash
# Check nginx status
sudo systemctl status nginx

# Test nginx configuration
sudo nginx -t

# Check nginx logs
sudo tail -f /var/log/nginx/error.log

# Reload nginx configuration
sudo systemctl reload nginx
```

### Firewall Issues
```bash
# Check firewall status
sudo firewall-cmd --list-all

# Open required ports
sudo firewall-cmd --permanent --add-port=%APP_PORT%/tcp
sudo firewall-cmd --reload

# Test port connectivity
curl -I http://localhost:%APP_PORT%
```

## Security Considerations

### File Permissions
```bash
# Application files
sudo chown -R jpulse:jpulse /opt/jpulse
sudo chmod -R 755 /opt/jpulse

# Log files
sudo chown -R jpulse:jpulse /var/log/jpulse
sudo chmod -R 644 /var/log/jpulse
```

### Database Security
- MongoDB authentication is enabled by default
- Application user has minimal required permissions
- Admin user is separate from application user
- Regular password rotation recommended

### Web Server Security
- HTTPS enforced (HTTP redirects to HTTPS)
- Security headers configured
- Rate limiting enabled
- Static file serving optimized
- Sensitive files blocked

## Performance Optimization

### PM2 Cluster Mode
- Production uses %PM2_INSTANCES% instances
- Automatic load balancing
- Zero-downtime deployments
- Memory monitoring and restart

### nginx Optimization
- Gzip compression enabled
- Static file caching (1 year)
- Connection keep-alive
- Rate limiting by endpoint type

### Database Optimization
- Connection pooling configured
- Appropriate timeouts set
- Indexes should be added based on usage patterns

## Backup Strategy

### Automated Backups
```bash
# Create backup script
cat > /opt/jpulse/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/jpulse"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# Database backup
mongodump --host localhost --db %DB_NAME% --out $BACKUP_DIR/db_$DATE

# Application backup
tar -czf $BACKUP_DIR/app_$DATE.tar.gz -C /opt/jpulse --exclude=node_modules .

# Keep only last 7 days
find $BACKUP_DIR -name "*_*.tar.gz" -mtime +7 -delete
find $BACKUP_DIR -name "db_*" -mtime +7 -exec rm -rf {} \;
EOF

chmod +x /opt/jpulse/backup.sh

# Schedule daily backups
echo "0 2 * * * /opt/jpulse/backup.sh" | crontab -
```

## Support

- **Framework Documentation**: [jPulse Framework Docs](https://github.com/peterthoeny/jpulse-framework/tree/main/docs)
- **Site Customization**: [Site Development Guide](https://github.com/peterthoeny/jpulse-framework/blob/main/docs/site-customization.md)
- **Framework Issues**: [GitHub Issues](https://github.com/peterthoeny/jpulse-framework/issues)

---

*This deployment guide was generated by jpulse-setup v%FRAMEWORK_VERSION% for %SITE_NAME%*

<!--
 @name            jPulse Framework / Deploy / Deployment Guide
 @tagline         Site-specific deployment guide for sites based on jPulse Framework
 @description     Generated deployment README for sites created with jpulse-setup
 @site            %SITE_NAME%
 @generated       %GENERATION_DATE%
 @file            templates/deploy/README.md
 @version         0.6.7
 @release         2025-09-13
 @repository      https://github.com/peterthoeny/jpulse-framework
 @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 @license         AGPL v3, see LICENSE file
 @genai           99%, Cursor 1.2, Claude Sonnet 4
-->
