/**
 * @name            jPulse Framework / WebApp / Configuration
 * @tagline         WebApp for jPulse Framework
 * @description     This is the configuration file for the jPulse Framework WebApp
 * @file            webapp/app.conf
 * @version         1.3.18
 * @release         2025-12-18
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           10%, Cursor 2.0, Claude Sonnet 4.5
 */

// Below configuration is available in the global appConfig object.
// The structure matches the file structure with controllers, views, etc.
// NOTE: DO NOT CHANGE ANYTHING BELOW, but override site-specific settings in site/webapp/app.conf
{
    app: {
        jPulse: {       // framework metadata - DO NOT CHANGE
            name:       'jPulse Framework',
            shortName:  'jPulse',
            version:    '1.3.18',
            release:    '2025-12-18'
        },
        site: {         // Override app.jPulse with app.site in site/webapp/app.conf - DO NOT CHANGE
            name:       'My jPulse Framework Site',
            shortName:  'My jPulse Site',
            copyright:  'Â© 1970 My Company',
            version:    '0.1.0',
            release:    '1970-01-01'
        }
    },
    system: {           // System metadata, set during bootstrap - DO NOT CHANGE
        projectRoot:    '',     // '/path/to/jpulse-framework', set by app.js
        appDir:         '',     // '/path/to/jpulse-framework/webapp', set by app.js
        siteDir:        '',     // '/path/to/jpulse-framework/site/webapp', set by app.js
        port:           0,      // 8080, set by app.js (script arg, env var, or config below)
        hostname:       '',     // 'app-012.ca.example.com', set by app.js (hostname)
        serverName:     '',     // 'app-012', set by app.js (hostname without domain)
        serverId:       0,      // 12, set by app.js (number extracted from serverName)
        pm2Id:          0,      // 1, set by app.js (PM2 instance ID)
        pid:            0,      // 12345, set by app.js (process ID)
        instanceName:   '',     // 'app-012:0:12345', set by app.js (serverName:pm2Id:pid)
        instanceId:     '',     // '012:0:12345', set by app.js (serverId:pm2Id:pid)
        docTypes:       []      // ['config', 'user', ...], set by LogController
    },
    deployment: {
        mode:           'dev',
        dev: {
            name:       'development',
            db:         'jp-dev',
            port:       8080
        },
        prod: {
            name:       'production',
            db:         'jp-prod',
            port:       8081
        }
    },
    database: {
        mode:           'standalone',
        standalone: {
            url:        'mongodb://localhost:27017/%DB%', // %DB% is deployment[mode].db
            options: {
                // Authentication (override in site/webapp/app.conf when needed)
                //authSource: '%DB%', // %DB% is deployment[mode].db
                //auth: {
                //    username: 'FIXME',
                //    password: 'FIXME'
                //},
                serverSelectionTimeoutMS: 5000,
                socketTimeoutMS:        45000,
                connectTimeoutMS:       20000,
                maxPoolSize:            10,
                minPoolSize:            1,
                maxIdleTimeMS:          30000
            }
        },
        replicaSet: {
            servers: [
                'app-001.ca.example.com:20017',
                'app-002.ca.example.com:20017',
                'app-003.ca.example.com:20017'
            ],
            url:        'mongodb://%SERVERS%/%DB%?replicaSet=app-rs', // %SERVERS% is replicaSet.servers
            options: {
                // Authentication (override in site/webapp/app.conf when needed)
                //authSource: '%DB%', // %DB% is deployment[mode].db
                //auth: {
                //    username: 'FIXME',
                //    password: 'FIXME'
                //},
                serverSelectionTimeoutMS: 5000,
                socketTimeoutMS:        45000,
                connectTimeoutMS:       20000,
                maxPoolSize:            10,
                minPoolSize:            1,
                maxIdleTimeMS:          30000
            }
        }
    },
    redis: {
        // W-076: Redis infrastructure for multi-instance and multi-server scalability
        // Supports both single-instance Redis and Redis Cluster configurations
        // Redis is required for:
        // - Multi-instance PM2 clusters
        // - Multi-server load-balanced deployments
        // - Cross-instance WebSocket communication
        // - Shared session management
        enabled:                    true,       // Enable for multi-instance and multi-server scalability
        mode:                       'single',   // 'single' (default), or 'cluster'

        // Single Redis instance configuration
        single: {
            host:                   'localhost',
            port:                   6379,
            password:               '',         // Optional authentication
            db:                     0,          // Redis database number (0-15)
            connectTimeout:         10000,      // Connection timeout in ms
            lazyConnect:            true,       // Connect on first command
            retryDelayOnFailover:   100,        // Retry delay in ms
            maxRetriesPerRequest:   3           // Max retries per request
        },

        // Redis Cluster configuration (for production scalability)
        cluster: {
            nodes: [
                { host: 'localhost', port: 7000 },
                { host: 'localhost', port: 7001 },
                { host: 'localhost', port: 7002 },
                { host: 'localhost', port: 7003 },
                { host: 'localhost', port: 7004 },
                { host: 'localhost', port: 7005 }
            ],
            password:               '',     // Optional cluster authentication
            redisOptions: {
                connectTimeout:     10000,  // Connection timeout in ms
                lazyConnect:        true    // Connect on first command
            },
            enableOfflineQueue:     false,  // Do not queue commands when cluster unavailable
            retryDelayOnFailover:   100,    // Retry delay in ms
            maxRetriesPerRequest:   3
        },

        // Graceful fallback configuration
        fallback: {
            sessions:       'memory'        // 'memory' or 'mongodb' for session fallback
        },

        // Connection pools for different services
        connections: {
            session: {
                keyPrefix:  'sess:',        // Session key prefix
                ttl:        86400           // Session TTL in seconds (24 hours)
            },
            websocket: {
                keyPrefix:  'ws:',          // WebSocket key prefix
                ttl:        300             // WebSocket tracking TTL (5 minutes)
            },
            broadcast: {
                keyPrefix:  'bc:',          // Broadcast key prefix
                ttl:        60              // Broadcast message TTL (1 minute)
            },
            metrics: {
                keyPrefix:  'metrics:',     // Metrics key prefix
                ttl:        30,             // Instance metrics TTL (30 seconds)
                instanceTtl: 120            // Instance registration TTL in seconds (2 minutes)
            }
        }
    },
    middleware: {
        cors: {
            origin:         '*',
            methods:        'GET,HEAD,PUT,PATCH,POST,DELETE',
            preflightContinue:      false,
            optionsSuccessStatus:   204
        },
        setHeaders: {
            // Select from availableHeaders to set:
            headers: ['Content-Security-Policy', 'Report-To'],
            availableHeaders: {
                // Enforce Content-Security-Policy (CSP):
                'Content-Security-Policy':
                    "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; report-to default",
                // Or: Only report CSP violations:
                'Content-Security-Policy-Report-Only':
                    "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; report-to default",
                // Report CSP violations to logs:
                'Report-To':
                    '{"group":"default","max_age":31536000,"endpoints":[{"url":"/api/1/log/report/csp"}]}'
            }
        },
        bodyParser: {
            urlencoded: {
                extended:   true,
                limit:      '10mb'
            },
            json: {
                limit:      '10mb'
            }
        },
        session: {
            secret:             'FIXME',
            resave:             false,
            saveUninitialized:  false,
            touchAfter:         24 * 3600,  // 24 hours in seconds
            cookie: {
                secure:         false,
                maxAge:         3600000
            }
        }
    },
    utils: {
        common: {
            sanitizeHtml: {
                allowedTags: [
                    'p', 'br', 'strong', 'em', 'b', 'i', 'u',
                    'ul', 'ol', 'li',
                    'a', 'code', 'pre',
                    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                    'blockquote', 'hr'
                ],
                allowedAttributes: {
                    a: ['href', 'title', 'target'],
                    img: ['src', 'alt', 'title']
                }
            }
        },
        i18n: {
            default: 'en',
            cache: {
                enabled:        true,
                checkInterval:  10      // 10 min between checks
            }
        }
    },
    model: {
        user: {
            passwordPolicy: {
                minLength:      8
            }
        }
    },
    controller: {
        auth: {
            mode:               'internal',
            disableLogin:       false,  // see also view.auth.hideLogin, controller.user.disableSignup
            internal: {
            },
            ldap: {
                url:            'ldap://localhost:389',
                baseDN:         'dc=example,dc=com',
                bindPass:       'FIXME',
                tls: false,
                tlsOptions: {
                    rejectUnauthorized: false,
                    ca:         []
                }
            },
            oauth2: {
                clientID:       'FIXME',
                clientSecret:   'FIXME',
                redirectURI:    'http://localhost:3000/oauth2/callback'
            }
        },
        config: {
            defaultDocName:     'global'
        },
        log: {
            maxMsgLength:       256
        },
        handlebar: {
            contextFilter: {
                withoutAuth:    [ 'appConfig.system', 'appConfig.deployment', 'appConfig.database',
                                  'appConfig.redis', 'appConfig.middleware', 'appConfig.model',
                                  'appConfig.controller' ],
                withAuth:       [ 'appConfig.**.port', 'appConfig.**.password', 'appConfig.database',
                                  'appConfig.redis', 'appConfig.middleware', 'appConfig.model',
                                  'appConfig.controller' ]
            },
            maxIncludeDepth:    10,
            cacheIncludes: {
                enabled:        true,
                checkInterval:  10      // 10 min between checks
            }
        },
        health: {
            requiredRoles: {
                status:         [ '_public', 'user' ],    // open to all
                metrics:        [ 'admin', 'root' ]
            },
            broadcastInterval:  20,     // seconds
            cacheInterval:      10,     // seconds - cache expensive calls
            instanceTTL:        60,     // seconds (3x broadcast interval)
            omitStatusLogs:     false
        },
        markdown: {
            cache: {
                enabled:        true,
                checkInterval:  10      // 10 min between checks
            },
            titleCaseFix: {     // fix 'Title Case' in _extractTitle() substitution
                Api:            'API',
                CHANGELOG:      'Version History',
                Css:            'CSS',
                Faq:            'FAQ',
                Html:           'HTML',
                Javascript:     'JavaScript',
                Jpulse:         'jPulse',
                Mfa:            'MFA',
                Mpa:            'MPA',
                Mvc:            'MVC',
                Spa:            'SPA',
                Sql:            'SQL',
                Ui:             'UI',
                Vs:             'vs.'
            }
        },
        user: {
            adminRoles:         [ 'admin', 'root' ],
            disableSignup:      false,  // see also view.auth.hideSignup, controller.auth.disableLogin
        },
        view: {
            defaultTemplate:    'index.shtml',
            cacheTemplates: {
                enabled:        true,
                checkInterval:  10      // 10 min between checks
            }
        },
        websocket: {
            pingInterval:             30000,    // ping interval in ms
            pongTimeout:              5000,     // 5 seconds to respond
            reconnectBaseInterval:    5000,     // start with 5 seconds (unused - for future use)
            reconnectMaxInterval:     30000,    // max 30 seconds (unused - for future use)
            instanceRegistryInterval: 30000,    // 30 seconds (unused - for future use)
            statusTimeouts: {                   // WebSocket namespace status timeouts
                inactive:             1800000,  // 30 minutes - mark as red if inactive
                warning:              300000,   // 5 minutes - mark as yellow if inactive
            },
            activityLogMaxSize:       100,      // Maximum activity log entries to keep
        }
    },
    view: {
        // Note: Site navigation is defined in webapp/view/jpulse-navigation.tmpl

        pageDecoration: {
            headerHeight:           35,
            siteNavigation: {
                enabled:             true,   // enable site nav pull-down menu
                openDelay:           300,    // ms delay before opening site nav pull-down menu
                closeDelay:          500,    // ms delay before closing site nav pull-down menu
                submenuCloseDelay:   600,    // ms delay before closing submenus
                menuPaddingLeft:     16,     // px left padding for dropdown alignment with logo
                mobileBreakpoint:    768,    // px screen width for mobile hamburger menu
                animationDuration:   200,    // ms CSS transition duration for site nav menu
            },
            breadcrumbs: {
                enabled:             true,   // enable breadcrumbs at top of page
            },
            sidebar: {
                enabled:             false,  // FIXME W-068: enable sidebar on the left
            }
        },
        mainContainer: {
            maxWidth:               1200,   // max width of the content area
            minMarginLeftRight:     20      // min margin left & right for narrow content area
        },
        toastMessage: {                     // non-blocking slide-down message system
            minWidth:               200,
            maxWidth:               800,
            minMarginLeftRight:     20,     // min margin left & right for narrow container
            duration: {                     // duration by type in ms
                info:               3000,
                warning:            5000,
                error:              6000,
                success:            3000,
            }
        },
        admin: {
            systemStatus: {
                refreshInterval:    10,     // seconds
                refreshInBackground: true   // refresh also when page is out of focus
            }
        },
        auth: {
            hideSignup:             false,  // see also controller.auth.disableSignup
            hideLogin:              false,  // see also controller.auth.disableLogin
        }
    }
}

// EOF webapp/app.conf
