<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / Admin / Config
 * @tagline         Site configuration management interface
 * @description     Edit site configuration, for administrators
 * @file            webapp/view/admin/config.shtml
 * @version         1.6.16
 * @release         2026-02-12
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 1.7, Claude Sonnet 4
-->
<html {{appConfig.system.htmlAttrs}}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{i18n.view.admin.config.title}} - {{app.site.shortName}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific styles only - schema form styles are in jpulse-common.css */
        .local-config-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .local-form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--jp-theme-border-color, #eee);
        }

        .local-form-actions .jp-btn {
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .local-form-actions {
                flex-direction: column;
                align-items: center;
            }

            .local-form-actions .jp-btn {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    {{#component "adminCards.config" order=10}}
        {{!-- This card is automatically included in the admin dashboard at admin/index.shtml --}}
        <a href="/admin/config.shtml" class="jp-card-dashboard jp-icon-btn">
            <div class="jp-icon-container">{{components.jpIcons.configSvg size="64"}}</div>
            <h3 class="jp-card-title">{{i18n.view.admin.index.siteConfig}}</h3>
            <p class="jp-card-description">{{i18n.view.admin.index.siteConfigDesc}}</p>
        </a>
    {{/component}}

    <div class="jp-main">
        <div class="jp-container-1000">
          {{#if user.isAdmin}}
            <div class="jp-page-header">
                <h1>{{components.jpIcons.configSvg size="26"}} {{i18n.view.admin.config.title}}</h1>
                <span class="jp-subtitle">{{i18n.view.admin.config.subtitle}}</span>
            </div>

            <form id="configForm" class="local-config-form" data-current-user-roles="{{#each user.roles}}{{this}}{{#unless @last}},{{/unless}}{{/each}}">
                <!-- Tab Navigation and Panels (W-148 Phase 4: unified schema-driven) -->
                <div id="config-tabs" class="jp-tabs"></div>
                <div id="config-all-panels"></div>

                <!-- Form Actions (shown below all tab panels) -->
                <div class="local-form-actions">
                    <button type="button" id="cancelBtn" class="jp-btn jp-btn-secondary">{{i18n.view.admin.config.cancel}}</button>
                    <button type="submit" id="saveBtn" class="jp-btn jp-btn-primary">{{i18n.view.admin.config.saveChanges}}</button>
                </div>
            </form>

          {{else}}
            <div class="jp-error-box">
                <p>{{i18n.view.admin.accessDenied}}</p>
            </div>
          {{/if}}
        </div>
    </div>

    <script>
        // Password visibility toggle function
        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.nextElementSibling;

            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'ðŸ™ˆ';
                button.title = 'Hide password';
            } else {
                field.type = 'password';
                button.textContent = 'ðŸ‘ï¸';
                button.title = 'Show password';
            }
        }

        // Dirty form state (declared outside jPulse.dom.ready for beforeunload access)
        let isDirty = false;

        // Warn user when navigating away with unsaved changes
        window.addEventListener('beforeunload', (event) => {
            if (isDirty) {
                event.preventDefault();
                // Modern browsers ignore custom messages and show their own generic prompt
                // Setting returnValue to any truthy value triggers the dialog
                event.returnValue = true;
                return true;
            }
        });

        // Site configuration management (W-148 Phase 4: unified schema-driven tabs and panels)
        jPulse.dom.ready(() => {
            const configForm = document.getElementById('configForm');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            let originalDirtySnapshot = '';
            let dirtyTrackingReady = false;
            let configSchema = null;

            // Password toggle: delegated so dynamically rendered password fields work
            configForm.addEventListener('click', (e) => {
                const btn = e.target.closest('.jp-password-toggle');
                if (btn) {
                    const inputId = btn.getAttribute('data-password-for');
                    if (inputId) togglePasswordVisibility(inputId);
                }
            });

            // Schema action buttons (data-action / data-callback): delegated for schema type: 'button' fields
            const actionHandlers = { testEmail: handleTestEmail };
            configForm.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-action], button[data-callback]');
                if (!btn) return;
                const callbackName = btn.getAttribute('data-callback');
                const action = btn.getAttribute('data-action');
                if (callbackName && typeof window[callbackName] === 'function') {
                    window[callbackName].call(btn);
                    return;
                }
                if (action && actionHandlers[action]) {
                    actionHandlers[action](btn);
                }
            });

            loadConfig();

            async function loadConfig() {
                try {
                    const result = await jPulse.api.call('/api/1/config/_default?includeSchema=1&_=' + Date.now());
                    if (result.success && result.data) {
                        configSchema = (result.schema && (result.schema.schema || result.schema)) || null;
                        if (configSchema && typeof configSchema === 'object' && configSchema.data && typeof configSchema.data === 'object') {
                            jPulse.UI.tabs.renderTabsAndPanelsFromSchema(
                                'config-tabs',
                                'config-all-panels',
                                configSchema,
                                result.data
                            );
                        }
                        populateForm(result.data);
                        if (jPulse.UI.input && jPulse.UI.input.initAll) {
                            jPulse.UI.input.initAll(configForm);
                        }

                        setTimeout(() => {
                            originalDirtySnapshot = localSerializeDirtySnapshot();
                            dirtyTrackingReady = true;
                            isDirty = false;
                            updateButtonStates();
                        }, 0);
                        setTimeout(() => {
                            if (!isDirty) {
                                originalDirtySnapshot = localSerializeDirtySnapshot();
                                dirtyTrackingReady = true;
                                updateButtonStates();
                            }
                        }, 300);
                    } else {
                        jPulse.UI.toast.error(`{{i18n.view.admin.config.loadFailed}}`);
                    }
                } catch (error) {
                    jPulse.UI.toast.error(`{{i18n.view.admin.config.loadError}}`);
                }
            }

            async function handleTestEmail(btn) {
                const adminEmailEl = configForm.querySelector('[data-path="email.adminEmail"]');
                const adminEmail = adminEmailEl ? adminEmailEl.value.trim() : '';
                if (!adminEmail) {
                    jPulse.UI.toast.error(`{{i18n.view.admin.config.testEmailNoRecipient}}`);
                    if (adminEmailEl) adminEmailEl.focus();
                    return;
                }
                const formData = getFormData();
                const emailConfig = formData.data.email;
                try {
                    if (btn) {
                        btn.classList.add('jp-btn-loading');
                        btn.disabled = true;
                    }
                    const result = await jPulse.api.call('/api/1/email/send', {
                        method: 'POST',
                        body: {
                            to: adminEmail,
                            subject: 'Test Email from {{app.site.name}}',
                            message: `This is a test email from {{app.site.name}} at {{url.hostname}}.\n\nConfiguration:\n- SMTP Server: ${emailConfig.smtpServer}\n- SMTP Port: ${emailConfig.smtpPort || 25}\n\nSent by: {{user.username}}`,
                            emailConfig: emailConfig
                        }
                    });
                    if (result.success) {
                        jPulse.UI.toast.success(`{{i18n.view.admin.config.testEmailSuccess}}`);
                    } else {
                        jPulse.UI.toast.error(result.error || `{{i18n.view.admin.config.testEmailFailed}}`);
                    }
                } catch (error) {
                    jPulse.UI.toast.error(`{{i18n.view.admin.config.testEmailError}}`);
                } finally {
                    if (btn) {
                        btn.classList.remove('jp-btn-loading');
                        btn.disabled = false;
                    }
                }
            }

            function localGetDirtySnapshot() {
                const snapshot = {};
                configForm.querySelectorAll('.jp-edit-field').forEach((el) => {
                    const key = el.id || el.name || (el.dataset.block && el.dataset.field ? 'ext.' + el.dataset.block + '.' + el.dataset.field : null);
                    if (!key) return;
                    if (el.type === 'checkbox') {
                        snapshot[key] = el.checked ? 'true' : 'false';
                        return;
                    }
                    snapshot[key] = el.value;
                });
                return snapshot;
            }

            function localSerializeDirtySnapshot() {
                return JSON.stringify(localGetDirtySnapshot());
            }

            function populateForm(config) {
                jPulse.UI.input.setFormData(configForm, config.data || {}, configSchema);
            }

            function getFormData() {
                return jPulse.UI.input.getFormData(configForm, configSchema);
            }

            function checkDirty() {
                if (!dirtyTrackingReady) return;
                isDirty = localSerializeDirtySnapshot() !== originalDirtySnapshot;
                updateButtonStates();
            }

            function updateButtonStates() {
                saveBtn.disabled = !isDirty;
                // Cancel button should always be enabled to allow navigation back to admin
            }

            // Dirty tracking: use delegation so dynamically added extension-panel fields are included.
            configForm.addEventListener('input', (e) => {
                if (e.target.matches && e.target.matches('.jp-edit-field')) checkDirty();
            });
            configForm.addEventListener('change', (e) => {
                if (e.target.matches && e.target.matches('.jp-edit-field')) checkDirty();
            });

            // Save configuration
            configForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!isDirty) return;

                const formData = getFormData();
                const roles = formData.data.general.roles;
                const adminRoles = formData.data.general.adminRoles;

                // Validate roles: match data-pattern (lowercase, digits, dash, underscore)
                const rolePattern = /^[a-z0-9_-]+$/;
                const invalidRoles = [...roles, ...adminRoles].filter(r => !rolePattern.test(r));
                if (invalidRoles.length > 0) {
                    const unique = [...new Set(invalidRoles)];
                    jPulse.UI.toast.error(`{{i18n.view.admin.config.general.rolesInvalidChars}}`.replace('%ROLES%', unique.join(', ')));
                    const rolesEl = configForm.querySelector('[data-path="general.roles"]');
                    if (rolesEl) rolesEl.focus();
                    return;
                }

                // W-147: Validate adminRoles âŠ† roles
                const notSubset = adminRoles.filter(r => !roles.includes(r));
                if (notSubset.length > 0) {
                    jPulse.UI.toast.error(`{{i18n.view.admin.config.general.adminRolesSubset}}`);
                    const adminRolesEl = configForm.querySelector('[data-path="general.adminRoles"]');
                    if (adminRolesEl) adminRolesEl.focus();
                    return;
                }

                // W-147: Self-lockout â€“ current user must keep at least one of their roles in admin roles
                const currentUserRolesStr = (configForm.dataset.currentUserRoles || '').trim();
                const currentUserRoles = currentUserRolesStr ? currentUserRolesStr.split(',').map(s => s.trim().toLowerCase()).filter(Boolean) : [];
                const userAdminRoles = currentUserRoles.filter(r => adminRoles.includes(r));
                if (currentUserRoles.length > 0 && userAdminRoles.length === 0) {
                    jPulse.UI.toast.error(`{{i18n.view.admin.config.general.selfLockout}}`);
                    const adminRolesEl = configForm.querySelector('[data-path="general.adminRoles"]');
                    if (adminRolesEl) adminRolesEl.focus();
                    return;
                }

                // Validate required fields (schema-driven ids: use data-path)
                const adminEmailEl = configForm.querySelector('[data-path="email.adminEmail"]');
                const adminEmail = adminEmailEl ? adminEmailEl.value.trim() : '';
                if (!adminEmail) {
                    jPulse.UI.toast.error(`{{i18n.view.admin.config.adminEmailRequired}}`);
                    if (adminEmailEl) adminEmailEl.focus();
                    return;
                }

                try {
                    saveBtn.classList.add('jp-btn-loading');
                    saveBtn.disabled = true;

                    const result = await jPulse.api.call('/api/1/config/_default', {
                        method: 'PUT',
                        body: formData
                    });

                    if (result.success) {
                        isDirty = false;
                        // Redirect immediately with deferred success toast
                        jPulse.url.redirect('/admin/', {
                            toasts: [{ toastType: 'success', message: `{{i18n.view.admin.config.saveSuccess}}` }]
                        });
                    } else {
                        jPulse.UI.toast.error(result.error || `{{i18n.view.admin.config.saveFailed}}`);
                    }
                } catch (error) {
                    jPulse.UI.toast.error(`{{i18n.view.admin.config.saveError}}`);
                } finally {
                    saveBtn.classList.remove('jp-btn-loading');
                    saveBtn.disabled = false;
                }
            });

            // Cancel changes
            cancelBtn.addEventListener('click', async () => {
                if (isDirty) {
                    const result = await jPulse.UI.confirmDialog({
                        title: `{{i18n.view.admin.config.discardChangesTitle}}`,
                        message: `{{i18n.view.admin.config.discardChangesMessage}}`,
                        buttons: [`{{i18n.view.admin.config.backToEdit}}`, `{{i18n.view.admin.config.discardChanges}}`]
                    });
                    if (result.button === `{{i18n.view.admin.config.backToEdit}}`) {
                        return;
                    }
                }
                isDirty = false; // Prevent beforeunload from triggering
                window.location.href = '/admin/';
            });

            // Clear error states on input (delegated so dynamically rendered fields work)
            configForm.addEventListener('input', (e) => {
                if (e.target.matches('.jp-form-input, .jp-form-textarea')) e.target.classList.remove('jp-field-error');
            });
            configForm.addEventListener('change', (e) => {
                if (e.target.matches('.jp-form-input, .jp-form-textarea')) e.target.classList.remove('jp-field-error');
            });
        });
    </script>

    {{file.include "jpulse-footer.tmpl"}}
</body>
</html>
