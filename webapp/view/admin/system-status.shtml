<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / Admin / System Status
 * @tagline         Admin system status interface
 * @description     System monitoring and health dashboard for site administrators
 * @file            webapp/view/admin/system-status.shtml
 * @version         1.3.4
 * @release         2025-12-02
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 1.7, Claude Sonnet 4
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{i18n.view.admin.systemStatus.title}} - {{app.site.shortName}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific styles only - common styles are in jpulse-common.css */

        /* Page-specific styles only - status/metrics styles moved to jpulse-common.css */

        .local-refresh-info {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    {{#component "adminCards.systemStatus" order=40}}
        {{!-- This card is automatically included in the admin dashboard at admin/index.shtml --}}
        <a href="/admin/system-status.shtml" class="jp-card-dashboard jp-icon-btn">
            <div class="jp-icon-container">{{components.jpIcons.systemStatusSvg size="64"}}</div>
            <h3 class="jp-card-title">{{i18n.view.admin.index.systemStatus}}</h3>
            <p class="jp-card-description">{{i18n.view.admin.index.systemStatusDesc}}</p>
        </a>
    {{/component}}

    <div class="jp-main">
        <div class="jp-container-1200">
          {{#if user.isAdmin}}
            <div class="jp-page-header">
                <h1>{{components.jpIcons.systemStatusSvg size="26"}} {{i18n.view.admin.systemStatus.title}}</h1>
                <span class="jp-subtitle">{{i18n.view.admin.systemStatus.subtitle}}</span>
            </div>

            <!-- Error State -->
            <div id="errorState" class="jp-alert jp-alert-danger" style="display: none;">
                <strong>{{i18n.view.admin.systemStatus.errorTitle}}</strong>
                <span id="errorMessage">{{i18n.view.admin.systemStatus.errorMessage}}</span>
            </div>

            <!-- Status Content -->
            <div id="statusContent" style="display: none;">

                <!-- 1. Overall Cluster Health -->
                <div class="jp-card" style="margin-bottom: 30px;">
                    <div id="clusterHealthGrid" class="jp-stats-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- 2. Server Summary Cards -->
                <h2>{{i18n.view.admin.systemStatus.serverSummariesTitle}}</h2>
                <div id="serverSummariesGrid" class="jp-status-grid">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- 3. Detailed Server Tabs -->
                <h2>{{i18n.view.admin.systemStatus.serverDetailsTitle}}</h2>
                <!-- Tab Navigation -->
                <div id="serverTabs" class="jp-tabs">
                </div>
                <!-- Tab Content Panels -->
                <div id="serverTabContent" class="jp-tabs-panels">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Refresh Information -->
                <div class="local-refresh-info">
                    <i class="jp-icon jp-icon-info"></i>
                    {{i18n.view.admin.systemStatus.refreshInfo}}
                    <br/>
                    <strong>{{i18n.view.admin.systemStatus.apiEndpoints}}</strong>
                    <a href="/api/1/health/status" target="_blank">/api/1/health/status</a> |
                    <a href="/api/1/health/metrics" target="_blank">/api/1/health/metrics</a>
                </div>
            </div>

          {{else}}
            <div class="jp-error-box">
                <p>{{i18n.view.admin.accessDenied}}</p>
            </div>
          {{/if}}
        </div>
    </div>

    {{file.include "jpulse-footer.tmpl"}}

    <script>
        // System Status Page JavaScript (Cluster-Aware)
        const app = {
            elements: {},
            data: null,
            timers: {
                refresh: null
            },
            config: {
                refreshIntervalMs: ({{appConfig.view.admin.systemStatus.refreshInterval}} || 30) * 1000,
                refreshInBackground: {{appConfig.view.admin.systemStatus.refreshInBackground}} || false
            },

            initialize() {
                this.cacheDOMElements();
                this.initWindowFocusHandling();
            },

            cacheDOMElements() {
                this.elements.loadingState = document.getElementById('loadingState');
                this.elements.errorState = document.getElementById('errorState');
                this.elements.errorMessage = document.getElementById('errorMessage');
                this.elements.statusContent = document.getElementById('statusContent');
                this.elements.clusterHealthGrid = document.getElementById('clusterHealthGrid');
                this.elements.serverSummariesGrid = document.getElementById('serverSummariesGrid');
                this.elements.serverTabContent = document.getElementById('serverTabContent');
            },

            initWindowFocusHandling() {
                jPulse.UI.windowFocus.register((hasFocus) => {
                    if (hasFocus) {
                        this.startAutoRefresh();
                    } else {
                        this.stopAutoRefresh();
                    }
                });
                this.startAutoRefresh();
            },

            startAutoRefresh() {
                if (this.timers.refresh) {
                    clearInterval(this.timers.refresh);
                }
                this.timers.refresh = setInterval(() => this.loadStatus(), this.config.refreshIntervalMs);
                this.loadStatus();
            },

            stopAutoRefresh() {
                if (this.timers.refresh && !this.config.refreshInBackground) {
                    clearInterval(this.timers.refresh);
                    this.timers.refresh = null;
                }
            },

            async loadStatus() {
                try {
                    this.showLoading(true);
                    this.hideError();

                    const response = await fetch('/api/1/health/metrics?mode=cluster');
                    const result = await response.json();

                    if (!result.success || !result.data) {
                        throw new Error(result.error || 'API returned an invalid response');
                    }

                    this.data = result.data;
                    this.render();
                    this.showContent();

                } catch (error) {
                    console.error('Failed to load status:', error);
                    this.showError(error.message);
                } finally {
                    this.showLoading(false);
                }
            },

            render() {
                this.renderClusterHealth();
                this.renderServerSummaries();
                this.renderServerDetails();
            },

            renderClusterHealth() {
                if (!this.data) return;
                const stats = this.data.statistics || {};

                const cards = [
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.totalServers}}`, value: this.data.servers?.length || 0 },
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.totalInstances}}`, value: stats.totalInstances || 0 },
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.running}}`, value: stats.runningProcesses || 0 },
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.stopped}}`, value: stats.stoppedProcesses || 0 },
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.errored}}`, value: stats.erroredProcesses || 0 },
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.wsConnections}}`, value: stats.totalWebSocketConnections || 0 },
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.wsMessages}}`, value: stats.totalWebSocketMessages || 0 },
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.wsNamespaces}}`, value: stats.totalWebSocketNamespaces || 0 }
                ];

                this.elements.clusterHealthGrid.innerHTML = cards.map(card => `
                    <div class="jp-stat-card">
                        <div class="jp-stat-number">${card.value}</div>
                        <div class="jp-stat-label">${card.label}</div>
                    </div>
                `).join('');
            },

            renderServerSummaries() {
                this.elements.serverSummariesGrid.innerHTML = ''; // Clear previous
                if (!this.data || !this.data.servers || this.data.servers.length === 0) {
                    this.elements.serverSummariesGrid.innerHTML = '<p>{{i18n.view.admin.systemStatus.serverSummaries.noServers}}</p>';
                    return;
                }

                this.data.servers.forEach((server, index) => {
                    const serverId = `server-summary-${server.serverId || index}`;
                    const card = document.createElement('div');
                    card.className = 'jp-card jp-status-card';
                    card.innerHTML = `
                        <div class="jp-status-header">
                            <h3 class="jp-status-title">Server ${server.serverId}</h3>
                            <div class="jp-status-indicator" id="${serverId}-indicator"></div>
                        </div>
                        <div id="${serverId}-metrics"></div>
                    `;
                    this.elements.serverSummariesGrid.appendChild(card);

                    const loadAvg = server.loadAverage ? server.loadAverage[0] : 0;
                    const memPercentage = server.totalMemory ? Math.round(((server.totalMemory - server.freeMemory) / server.totalMemory) * 100) : 0;

                    const rows = [
                        [`{{i18n.view.admin.systemStatus.serverSummaries.serverName}}`, server.serverName],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.ipAddress}}`, server.ip],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.cpus}}`, server.cpus],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.instances}}`, server.instances?.length || 0],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.loadAverage}}`, loadAvg.toFixed(2)],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.memoryPercentage}}`, `${memPercentage}%`],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.systemUptime}}`, server.uptimeFormatted || `{{i18n.view.admin.systemStatus.unknown}}`],
                    ];
                    document.getElementById(`${serverId}-metrics`).innerHTML = this.generateMetricRows(rows);

                    let status = 'ok';
                    if (memPercentage > 90 || loadAvg > 4.0) status = 'error';
                    else if (memPercentage > 75 || loadAvg > 2.0) status = 'warning';
                    this.updateCardStatus(card, document.getElementById(`${serverId}-indicator`), status);
                });
            },

            renderServerDetails() {
                this.elements.serverTabContent.innerHTML = '';

                if (!this.data || !this.data.servers || !this.data.servers.length === 0) return;

                const tabsConfig = [];

                this.data.servers.forEach((server, index) => {

                    // Add tab to the config
                    const serverId = server.serverId || index;
                    tabsConfig.push({
                        id: `server-nav-${serverId}`,
                        label: `{{i18n.view.admin.systemStatus.serverTabContent.tabLabel}}`.replace('%SERVERID%', serverId),
                        panelId: `server-panel-${serverId}`
                    });

                    // Create Tab Panel
                    const panel = document.createElement('div');
                    panel.id = `server-panel-${serverId}`;
                    panel.className = 'jp-tab-panel';
                    const unknown = `{{i18n.view.admin.systemStatus.unknown}}`;
                    const notApplicable = `{{i18n.view.admin.systemStatus.notApplicable}}`;

                    const pm2InstanceDetails = (server.instances || []).sort((a, b) => {
                        return a.instanceId.localeCompare(b.instanceId);
                    }).map(inst => `
                        <tr>
                            <td>${inst.pm2ProcessName ?? notApplicable}</td>
                            <td>${inst.instanceId ?? notApplicable}</td>
                            <td>${inst.pid}</td>
                            <td><span class="jp-badge jp-badge-${inst.status === 'online' ? 'success' : 'danger'}">${inst.status || notApplicable}</span></td>
                            <td>${inst.restarts ?? notApplicable}</td>
                            <td>${inst.cpu ? `${inst.cpu}%` : unknown}</td>
                            <td>${inst.memory ? `${inst.memory.used} MB` : unknown}</td>
                            <td>${inst.uptimeFormatted || unknown}</td>
                        </tr>
                    `).join('');

                    const wsStats = (server.instances || []).reduce((acc, inst) => {
                        acc.localConnections += inst.websockets?.localConnections || 0;
                        acc.localMessages += inst.websockets?.localMessages || 0;
                        return acc;
                    }, { localConnections: 0, localMessages: 0 });

                    panel.innerHTML = `<div class="jp-card">
                        <div class="jp-status-grid" style="gap: 1.5rem; margin-bottom: 2rem;">
                            <div class="jp-card">
                                <h4 class="jp-status-title">{{i18n.view.admin.systemStatus.serverTabContent.systemInfo}}</h4>
                                ${this.generateMetricRows([
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.serverName}}`, server.serverName],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.ipAddress}}`, server.ip || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.platform}}`, `${server.platform} (${server.arch})`],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.cpus}}`, server.cpus],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.nodeVersion}}`, server.nodeVersion],
                                ])}
                            </div>
                            <div class="jp-card">
                                <h4 class="jp-status-title">{{i18n.view.admin.systemStatus.serverTabContent.performance}}</h4>
                                ${this.generateMetricRows([
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.oneMinute}}`, server.loadAverage?.[0]?.toFixed(2) || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.fiveMinutes}}`, server.loadAverage?.[1]?.toFixed(2) || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.fifteenMinutes}}`, server.loadAverage?.[2]?.toFixed(2) || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.freeMemory}}`, this.formatBytes((server.freeMemory || 0) * 1024 * 1024)],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.totalMemory}}`, this.formatBytes((server.totalMemory || 0) * 1024 * 1024)],
                                ])}
                            </div>
                            <div class="jp-card">
                                <h4 class="jp-status-title">{{i18n.view.admin.systemStatus.serverTabContent.database}}</h4>
                                ${this.generateMetricRows([
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.databaseType}}`, server.database?.type || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.status}}`, server.database?.status || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.version}}`, server.database?.version || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.connections}}`, `${server.database?.connections?.current || 0} / ${server.database?.connections?.available || 0}`],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.hostname}}`, server.database?.hostname || unknown],
                                ])}
                            </div>
                            <div class="jp-card">
                                <h4 class="jp-status-title">{{i18n.view.admin.systemStatus.serverTabContent.webSockets}}</h4>
                                ${this.generateMetricRows([
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.uptime}}`, server.uptimeFormatted || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.connections}}`, wsStats.localConnections],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.messages}}`, wsStats.localMessages],
                                ])}
                            </div>
                        </div>

                        <h3 style="margin-top: 2rem;">{{i18n.view.admin.systemStatus.instanceDetails.heading}}</h3>
                        <div class="jp-status-grid" style="gap: 1.5rem; margin-bottom: 2rem;">
                            ${ (server.instances || []).sort((a, b) => {
                                return a.instanceId.localeCompare(b.instanceId);
                            }).map(inst => `
                                <div class="jp-card">
                                    <h4 class="jp-status-title">${ `{{i18n.view.admin.systemStatus.instanceDetails.title}}`.replace('%INSTANCEID%', inst.instanceId).replace('%PID%', inst.pid) }</h4>
                                    ${this.generateMetricRows([
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.jPulseVersion}}`, inst?.jPulse?.version || unknown],
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.siteVersion}}`, inst?.site?.version || unknown],
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.environment}}`, inst.environment || unknown],
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.dbStatus}}`, inst.database?.status || unknown],
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.dbName}}`, inst.database?.name || unknown],
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.port}}`, inst.port || unknown],
                                        ['CPU Usage', inst.cpu ? `${inst.cpu}%` : unknown],
                                        ['Memory Usage', inst.memory?.percentage ? `${inst.memory.percentage}% (${inst.memory.used} MB)` : `${inst.memory?.used || unknown} MB`],
                                        ['Requests/min', inst.metrics?.requestsPerMin !== undefined ? inst.metrics.requestsPerMin : unknown],
                                        ['Errors/min', inst.metrics?.errorsPerMin !== undefined ? inst.metrics.errorsPerMin : unknown],
                                        ['Error Rate', inst.metrics?.errorRate !== undefined ? `${inst.metrics.errorRate}%` : unknown],
                                    ])}
                                </div>
                            `).join('')}
                        </div>

                        <h3 style="margin-top: 2rem;">{{i18n.view.admin.systemStatus.pm2Instances.heading}}</h3>
                        <div class="jp-table-responsive">
                            <table class="jp-table jp-table-hover">
                                <thead>
                                    <tr>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.processName}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.id}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.pid}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.status}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.restarts}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.cpu}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.memory}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.uptime}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pm2InstanceDetails || '<tr><td colspan="8">{{i18n.view.admin.systemStatus.pm2Instances.noInstances}}</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                    this.elements.serverTabContent.appendChild(panel);
                });

                // Initialize the tabs using the config
                if (tabsConfig.length > 0) {
                    jPulse.UI.tabs.register('serverTabs', {
                        tabs: tabsConfig
                    }, tabsConfig[0].id);
                }
            },

            generateMetricRows(rows) {
                return rows.map(row => {
                    if (Array.isArray(row)) {
                        return `<div class="jp-metric-row"><span class="jp-metric-label">${row[0]}</span><span class="jp-metric-value">${row[1]}</span></div>`;
                    } else if (row.type === 'progress') {
                        return `
                            <div class="jp-metric-row">
                                <span class="jp-metric-label">${row.label}</span>
                                <span class="jp-metric-value">${row.value}</span>
                            </div>
                            <div class="jp-progress-bar">
                                <div class="jp-progress-bar-inner" style="width: ${row.percentage}%;"></div>
                            </div>
                        `;
                    }
                    return '';
                }).join('');
            },

            formatDateTime(isoString) {
                if (!isoString) return `{{i18n.view.admin.systemStatus.unknown}}`;
                return new Date(isoString).toLocaleString();
            },

            formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },

            updateCardStatus(cardEl, indicatorEl, status) {
                cardEl.className = cardEl.className.replace(/jp-status-(ok|warning|error)/g, '');
                indicatorEl.className = indicatorEl.className.replace(/jp-(warning|error)/g, '');
                cardEl.classList.add(`jp-status-${status}`);
                if (status !== 'ok') {
                    indicatorEl.classList.add(`jp-${status}`);
                }
            },

            showLoading(isLoading) {
                if (this.elements.loadingState) {
                    this.elements.loadingState.style.display = isLoading ? 'inline' : 'none';
                }
            },

            showContent() {
                this.elements.statusContent.style.display = 'block';
                this.elements.errorState.style.display = 'none';
            },

            showError(message) {
                this.elements.errorMessage.textContent = message;
                this.elements.statusContent.style.display = 'none';
                this.elements.errorState.style.display = 'block';
            },

            hideError() {
                this.elements.errorState.style.display = 'none';
            }
        };

        jPulse.dom.ready(() => {
            app.initialize();
        });
    </script>
</body>
</html>

<!-- EOF webapp/view/admin/system-status.shtml -->
