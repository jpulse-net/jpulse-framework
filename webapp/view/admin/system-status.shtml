<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / Admin / System Status
 * @tagline         Admin system status interface
 * @description     System monitoring and health dashboard for site administrators
 * @file            webapp/view/admin/system-status.shtml
 * @version         0.9.6
 * @release         2025-10-10
 * @repository      https://github.com/peterthoeny/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         AGPL v3, see LICENSE file
 * @genai           60%, Cursor 1.2, Claude Sonnet 4
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{i18n.view.admin.systemStatus.title}} - {{app.shortName}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific styles only - common styles are in jpulse-common.css */

        .local-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .local-status-card {
            border-left: 4px solid #007bff;
        }

        .local-status-card.local-status-ok {
            border-left-color: #28a745;
        }

        .local-status-card.local-status-warning {
            border-left-color: #ffc107;
        }

        .local-status-card.local-status-error {
            border-left-color: #dc3545;
        }

        .local-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .local-status-title {
            font-size: 1.1em;
            font-weight: 600;
            margin: 0;
        }

        .local-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #28a745;
        }

        .local-status-indicator.local-warning {
            background-color: #ffc107;
        }

        .local-status-indicator.local-error {
            background-color: #dc3545;
        }

        .local-metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .local-metric-row:last-child {
            border-bottom: none;
        }

        .local-metric-label {
            font-weight: 500;
            color: #666;
        }

        .local-metric-value {
            font-weight: 600;
            color: #333;
        }

        .local-progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .local-progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }

        .local-progress-fill.local-warning {
            background-color: #ffc107;
        }

        .local-progress-fill.local-danger {
            background-color: #dc3545;
        }

        .local-refresh-info {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .local-timestamp {
            font-size: 0.85em;
            color: #999;
        }
    </style>
</head>

<body>
    {{file.include "jpulse-navigation.tmpl"}}

    <div class="jp-main">
        <div class="jp-container-1200">
            {{#if user.authenticated}}
                <div class="jp-page-header">
                    <h1>{{i18n.view.admin.systemStatus.title}}</h1>
                    <p class="jp-subtitle">{{i18n.view.admin.systemStatus.subtitle}}</p>
                    <div class="jp-page-header-actions">
                        <button id="refreshButton" class="jp-btn jp-btn-primary" onclick="refreshStatus()">
                            <i class="jp-icon jp-icon-refresh"></i>
                            {{i18n.view.admin.systemStatus.refresh}}
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="jp-loading-container">
                    <div class="jp-loading-spinner"></div>
                    <p>{{i18n.view.admin.systemStatus.loading}}</p>
                </div>

                <!-- Error State -->
                <div id="errorState" class="jp-alert jp-alert-danger" style="display: none;">
                    <strong>{{i18n.view.admin.systemStatus.errorTitle}}</strong>
                    <span id="errorMessage">{{i18n.view.admin.systemStatus.errorMessage}}</span>
                </div>

                <!-- Status Content -->
                <div id="statusContent" style="display: none;">
                    <!-- Status Overview Grid -->
                    <div class="local-status-grid">
                        <!-- System Status -->
                        <div class="jp-card local-status-card local-status-ok" id="systemCard">
                            <div class="local-status-header">
                                <h3 class="local-status-title">{{i18n.view.admin.systemStatus.systemStatus}}</h3>
                                <div class="local-status-indicator" id="systemIndicator"></div>
                            </div>
                            <div id="systemMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Memory Usage -->
                        <div class="jp-card local-status-card" id="memoryCard">
                            <div class="local-status-header">
                                <h3 class="local-status-title">{{i18n.view.admin.systemStatus.memoryUsage}}</h3>
                                <div class="local-status-indicator" id="memoryIndicator"></div>
                            </div>
                            <div id="memoryMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Database Status -->
                        <div class="jp-card local-status-card local-status-ok" id="databaseCard">
                            <div class="local-status-header">
                                <h3 class="local-status-title">{{i18n.view.admin.systemStatus.database}}</h3>
                                <div class="local-status-indicator" id="databaseIndicator"></div>
                            </div>
                            <div id="databaseMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- WebSockets -->
                        <div class="jp-card local-status-card local-status-ok" id="websocketCard">
                            <div class="local-status-header">
                                <h3 class="local-status-title">{{i18n.view.admin.systemStatus.websockets}}</h3>
                                <div class="local-status-indicator" id="websocketIndicator"></div>
                            </div>
                            <div id="websocketMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Load Average -->
                        <div class="jp-card local-status-card" id="loadCard">
                            <div class="local-status-header">
                                <h3 class="local-status-title">{{i18n.view.admin.systemStatus.loadAverage}}</h3>
                                <div class="local-status-indicator" id="loadIndicator"></div>
                            </div>
                            <div id="loadMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Host Information -->
                        <div class="jp-card local-status-card local-status-ok" id="hostCard">
                            <div class="local-status-header">
                                <h3 class="local-status-title">{{i18n.view.admin.systemStatus.hostInfo}}</h3>
                                <div class="local-status-indicator" id="hostIndicator"></div>
                            </div>
                            <div id="hostMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- WebSocket Namespaces Detail -->
                    <div class="jp-card" id="namespacesCard" style="display: none;">
                        <div class="jp-card-header">
                            <h4 class="jp-card-title">{{i18n.view.admin.systemStatus.websocketNamespaces}}</h4>
                        </div>
                        <div class="jp-card-body">
                            <div class="jp-table-responsive">
                                <table class="jp-table jp-table-hover" id="namespacesTable">
                                    <thead>
                                        <tr>
                                            <th>{{i18n.view.admin.systemStatus.namespace}}</th>
                                            <th>{{i18n.view.admin.systemStatus.status}}</th>
                                            <th>{{i18n.view.admin.systemStatus.connections}}</th>
                                            <th>{{i18n.view.admin.systemStatus.activeUsers}}</th>
                                            <th>{{i18n.view.admin.systemStatus.messagesPerMin}}</th>
                                            <th>{{i18n.view.admin.systemStatus.totalMessages}}</th>
                                            <th>{{i18n.view.admin.systemStatus.lastActivity}}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="namespacesTableBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Refresh Information -->
                    <div class="local-refresh-info">
                        <i class="jp-icon jp-icon-info"></i>
                        {{i18n.view.admin.systemStatus.refreshInfo}}
                        <br>
                        <strong>{{i18n.view.admin.systemStatus.apiEndpoints}}</strong>
                        <a href="/api/1/health" target="_blank">/api/1/health</a> |
                        <a href="/api/1/metrics" target="_blank">/api/1/metrics</a>
                    </div>
                </div>

            {{else}}
                <div class="jp-error-box">
                    <p>{{i18n.view.admin.accessDenied}}</p>
                </div>
            {{/if}}
        </div>
    </div>

    {{file.include "jpulse-footer.tmpl"}}

    <script>
        // System Status Page JavaScript
        let statusData = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadStatus();
        });

        // Load status data from API
        async function loadStatus() {
            try {
                showLoading(true);
                hideError();

                const response = await fetch('/api/1/metrics');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                statusData = await response.json();
                if (!statusData.success) {
                    throw new Error(statusData.error || 'API returned error');
                }

                renderStatus(statusData.data);
                showContent();

            } catch (error) {
                console.error('Failed to load status:', error);
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        // Render status data to page
        function renderStatus(data) {
            renderSystemMetrics(data);
            renderMemoryMetrics(data);
            renderDatabaseMetrics(data);
            renderWebSocketMetrics(data);
            renderLoadMetrics(data);
            renderHostMetrics(data);
            renderNamespaces(data);
        }

        function renderSystemMetrics(data) {
            const html = `
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.version}}</span>
                    <span class="local-metric-value">${data.version}</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.release}}</span>
                    <span class="local-metric-value">${data.release}</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.environment}}</span>
                    <span class="local-metric-value">${data.environment}</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.uptime}}</span>
                    <span class="local-metric-value">${data.uptimeFormatted}</span>
                </div>
                ${data.system ? `
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.platform}}</span>
                    <span class="local-metric-value">${data.system.platform} (${data.system.arch})</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.nodeVersion}}</span>
                    <span class="local-metric-value">${data.system.nodeVersion}</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.cpus}}</span>
                    <span class="local-metric-value">${data.system.cpus}</span>
                </div>
                ` : ''}
            `;
            document.getElementById('systemMetrics').innerHTML = html;
        }

        function renderMemoryMetrics(data) {
            const heapPercentage = Math.round((data.memory.used / data.memory.total) * 100);
            const systemPercentage = data.system ?
                Math.round(((data.system.totalMemory - data.system.freeMemory) / data.system.totalMemory) * 100) : 0;

            const html = `
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.heapUsed}}</span>
                    <span class="local-metric-value">${data.memory.used} MB</span>
                </div>
                <div class="local-progress-bar">
                    <div class="local-progress-fill ${heapPercentage > 80 ? 'local-warning' : ''}"
                         style="width: ${heapPercentage}%"></div>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.heapTotal}}</span>
                    <span class="local-metric-value">${data.memory.total} MB</span>
                </div>
                ${data.system ? `
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.systemMemory}}</span>
                    <span class="local-metric-value">${data.system.freeMemory} MB {{i18n.view.admin.systemStatus.free}} / ${data.system.totalMemory} MB {{i18n.view.admin.systemStatus.total}}</span>
                </div>
                <div class="local-progress-bar">
                    <div class="local-progress-fill ${systemPercentage > 90 ? 'local-danger' : systemPercentage > 75 ? 'local-warning' : ''}"
                         style="width: ${systemPercentage}%"></div>
                </div>
                ` : ''}
            `;
            document.getElementById('memoryMetrics').innerHTML = html;

            // Update card status
            updateCardStatus('memoryCard', 'memoryIndicator', heapPercentage > 80 ? 'warning' : 'ok');
        }

        function renderDatabaseMetrics(data) {
            const html = `
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.status}}</span>
                    <span class="local-metric-value">${data.database.status}</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.database}}</span>
                    <span class="local-metric-value">${data.database.name}</span>
                </div>
            `;
            document.getElementById('databaseMetrics').innerHTML = html;
        }

        function renderWebSocketMetrics(data) {
            const html = `
                ${data.websockets ? `
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.activeConnections}}</span>
                    <span class="local-metric-value">${data.websockets.activeConnections}</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.totalMessages}}</span>
                    <span class="local-metric-value">${data.websockets.totalMessages}</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.namespaces}}</span>
                    <span class="local-metric-value">${data.websockets.namespaces}</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.uptime}}</span>
                    <span class="local-metric-value">${formatUptime(data.websockets.uptime)}</span>
                </div>
                ` : `
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.status}}</span>
                    <span class="local-metric-value">{{i18n.view.admin.systemStatus.limitedInfo}}</span>
                </div>
                `}
            `;
            document.getElementById('websocketMetrics').innerHTML = html;
        }

        function renderLoadMetrics(data) {
            if (!data.system || !data.system.loadAverage) {
                document.getElementById('loadMetrics').innerHTML = `
                    <div class="local-metric-row">
                        <span class="local-metric-label">{{i18n.view.admin.systemStatus.status}}</span>
                        <span class="local-metric-value">{{i18n.view.admin.systemStatus.limitedInfo}}</span>
                    </div>
                `;
                return;
            }

            const load1 = data.system.loadAverage[0];
            const html = `
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.oneMinute}}</span>
                    <span class="local-metric-value">${load1.toFixed(2)}</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.fiveMinutes}}</span>
                    <span class="local-metric-value">${data.system.loadAverage[1].toFixed(2)}</span>
                </div>
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.fifteenMinutes}}</span>
                    <span class="local-metric-value">${data.system.loadAverage[2].toFixed(2)}</span>
                </div>
            `;
            document.getElementById('loadMetrics').innerHTML = html;

            // Update card status
            updateCardStatus('loadCard', 'loadIndicator', load1 > 2 ? 'warning' : 'ok');
        }

        function renderHostMetrics(data) {
            const html = `
                ${data.system ? `
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.hostname}}</span>
                    <span class="local-metric-value">${data.system.hostname}</span>
                </div>
                ` : ''}
                <div class="local-metric-row">
                    <span class="local-metric-label">{{i18n.view.admin.systemStatus.lastUpdated}}</span>
                    <span class="local-metric-value local-timestamp">${formatDateTime(data.timestamp)}</span>
                </div>
            `;
            document.getElementById('hostMetrics').innerHTML = html;
        }

        function renderNamespaces(data) {
            // This would be populated from WebSocket stats if available
            // For now, hide the namespaces section
            document.getElementById('namespacesCard').style.display = 'none';
        }

        // Utility functions
        function updateCardStatus(cardId, indicatorId, status) {
            const card = document.getElementById(cardId);
            const indicator = document.getElementById(indicatorId);

            card.className = card.className.replace(/local-status-\w+/g, '');
            indicator.className = indicator.className.replace(/local-\w+/g, '');

            card.classList.add(`local-status-${status}`);
            if (status !== 'ok') {
                indicator.classList.add(`local-${status}`);
            }
        }

        function formatUptime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m ${secs}s`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function formatDateTime(isoString) {
            return new Date(isoString).toLocaleString();
        }

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
        }

        function showContent() {
            document.getElementById('statusContent').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('statusContent').style.display = 'none';
        }

        function hideError() {
            document.getElementById('errorState').style.display = 'none';
        }

        function refreshStatus() {
            loadStatus();
        }
    </script>
</body>
</html>

<!-- EOF webapp/view/admin/system-status.shtml -->
