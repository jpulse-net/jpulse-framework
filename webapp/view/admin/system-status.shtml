<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / Admin / System Status
 * @tagline         Admin system status interface
 * @description     System monitoring and health dashboard for site administrators
 * @file            webapp/view/admin/system-status.shtml
 * @version         0.9.6
 * @release         2025-10-10
 * @repository      https://github.com/peterthoeny/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         AGPL v3, see LICENSE file
 * @genai           60%, Cursor 1.2, Claude Sonnet 4
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{i18n.view.admin.systemStatus.title}} - {{app.shortName}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific styles only - common styles are in jpulse-common.css */

        /* Page-specific styles only - status/metrics styles moved to jpulse-common.css */

        .jp-refresh-info {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .jp-timestamp {
            font-size: 0.85em;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="jp-main">
        <div class="jp-container-1200">
          {{#if user.isAdmin}}
            <div class="jp-page-header">
                <h1>{{i18n.view.admin.systemStatus.title}}</h1>
                <p class="jp-subtitle">{{i18n.view.admin.systemStatus.subtitle}}</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="jp-alert jp-alert-danger" style="display: none;">
                <strong>{{i18n.view.admin.systemStatus.errorTitle}}</strong>
                <span id="errorMessage">{{i18n.view.admin.systemStatus.errorMessage}}</span>
                </div>

            <!-- Status Content -->
            <div id="statusContent" style="display: none;">
                <!-- jPulse Application Status -->
                <div class="jp-card" style="margin-bottom: 30px;">
                    <h2 class="jp-card-title">{{i18n.view.admin.systemStatus.appSystemStatus}}
                        <span id="loadingState"><img src="/images/icons/spinner-16-bg.gif" alt="" width="16" height="16" /></span>
                    </h2>
                    <div class="jp-status-grid">

                        <!-- jPulse Status -->
                        <div class="jp-card jp-status-card jp-status-ok" id="systemCard">
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">{{appConfig.app.name}}</h3>
                                <div class="jp-status-indicator" id="systemIndicator"></div>
                            </div>
                            <div id="systemMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Database Status -->
                        <div class="jp-card jp-status-card jp-status-ok" id="databaseCard">
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">{{i18n.view.admin.systemStatus.database}}</h3>
                                <div class="jp-status-indicator" id="databaseIndicator"></div>
                            </div>
                            <div id="databaseMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- WebSockets -->
                        <div class="jp-card jp-status-card jp-status-ok" id="websocketCard">
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">{{i18n.view.admin.systemStatus.websockets}}</h3>
                                <div class="jp-status-indicator" id="websocketIndicator"></div>
                            </div>
                            <div id="websocketMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- PM2 Processes -->
                        <div class="jp-card jp-status-card jp-status-warning" id="pm2Card">
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">{{i18n.view.admin.systemStatus.pm2Processes}}</h3>
                                <div class="jp-status-indicator jp-warning" id="pm2Indicator"></div>
                            </div>
                            <div id="pm2Metrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Host Information -->
                        <div class="jp-card jp-status-card jp-status-ok" id="hostCard">
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">{{i18n.view.admin.systemStatus.hostInfo}}</h3>
                                <div class="jp-status-indicator" id="hostIndicator"></div>
                            </div>
                            <div id="hostMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Load Average -->
                        <div class="jp-card jp-status-card jp-status-ok" id="loadCard">
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">{{i18n.view.admin.systemStatus.loadAverage}}</h3>
                                <div class="jp-status-indicator" id="loadIndicator"></div>
                            </div>
                            <div id="loadMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- System Resources -->
                        <div class="jp-card jp-status-card jp-status-ok" id="systemResourcesCard">
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">{{i18n.view.admin.systemStatus.systemResourcesInfo}}</h3>
                                <div class="jp-status-indicator" id="systemResourcesIndicator"></div>
                            </div>
                            <div id="systemResourcesMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Memory Usage -->
                        <div class="jp-card jp-status-card jp-status-ok" id="memoryCard">
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">{{i18n.view.admin.systemStatus.memoryUsage}}</h3>
                                <div class="jp-status-indicator" id="memoryIndicator"></div>
                            </div>
                            <div id="memoryMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                    </div>
                </div>

                <!-- PM2 Processes Detail -->
                <div class="jp-card" id="pm2ProcessesCard" style="display: block;"> <!--FIXME-->
                    <h2 class="jp-card-title">{{i18n.view.admin.systemStatus.pm2ProcessDetails}}</h2>
                    <div class="jp-card-body">
                        <div class="jp-table-responsive">
                            <table class="jp-table jp-table-hover" id="pm2ProcessesTable">
                                <thead>
                                    <tr>
                                        <th>{{i18n.view.admin.systemStatus.processName}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pid}}</th>
                                        <th>{{i18n.view.admin.systemStatus.status}}</th>
                                        <th>{{i18n.view.admin.systemStatus.uptime}}</th>
                                        <th>{{i18n.view.admin.systemStatus.memory}}</th>
                                        <th>{{i18n.view.admin.systemStatus.cpu}}</th>
                                        <th>{{i18n.view.admin.systemStatus.restarts}}</th>
                                    </tr>
                                </thead>
                                <tbody id="pm2ProcessesTableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- WebSocket Namespaces Detail -->
                <div class="jp-card" id="wsNamespacesCard" style="display: block;"> <!--FIXME-->
                    <h2 class="jp-card-title">{{i18n.view.admin.systemStatus.websocketNamespaces}}</h2>
                    <div class="jp-card-body">
                        <div class="jp-table-responsive">
                            <table class="jp-table jp-table-hover" id="namespacesTable">
                                <thead>
                                    <tr>
                                        <th>{{i18n.view.admin.systemStatus.namespace}}</th>
                                        <th>{{i18n.view.admin.systemStatus.status}}</th>
                                        <th>{{i18n.view.admin.systemStatus.connections}}</th>
                                        <th>{{i18n.view.admin.systemStatus.activeUsers}}</th>
                                        <th>{{i18n.view.admin.systemStatus.messagesPerMin}}</th>
                                        <th>{{i18n.view.admin.systemStatus.totalMessages}}</th>
                                        <th>{{i18n.view.admin.systemStatus.lastActivity}}</th>
                                    </tr>
                                </thead>
                                <tbody id="namespacesTableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Refresh Information -->
                <div class="jp-refresh-info">
                    <i class="jp-icon jp-icon-info"></i>
                    {{i18n.view.admin.systemStatus.refreshInfo}}
                    <br/>
                    <strong>{{i18n.view.admin.systemStatus.apiEndpoints}}</strong>
                    <a href="/api/1/health" target="_blank">/api/1/health</a> |
                    <a href="/api/1/metrics" target="_blank">/api/1/metrics</a>
                </div>
            </div>

          {{else}}
            <div class="jp-error-box">
                <p>{{i18n.view.admin.accessDenied}}</p>
            </div>
          {{/if}}
        </div>
    </div>

    {{file.include "jpulse-footer.tmpl"}}

    <script>
        // System Status Page JavaScript

        let statusData = null;

        // Auto-refresh functionality with window focus detection
        let refreshIntervalTimer;
        const refreshIntervalMs = ({{appConfig.view.admin.systemStatus.refreshInterval}} || 30) * 1000;
        const refreshInBackground = {{appConfig.view.admin.systemStatus.refreshInBackground}} || false;

        function startAutoRefresh() {
            if (refreshIntervalTimer) {
                clearInterval(refreshIntervalTimer);
            }
            refreshIntervalTimer = setInterval(() => {
                loadStatus();
            }, refreshIntervalMs);
            loadStatus();
        }

        function stopAutoRefresh() {
            if (refreshIntervalTimer && !refreshInBackground) {
                clearInterval(refreshIntervalTimer);
                refreshIntervalTimer = null;
            }
        }

        // Register window focus callback for conditional refresh
        function initWindowFocusHandling() {
            jPulse.UI.windowFocus.register((hasFocus) => {
                if (hasFocus) {
                    // Window gained focus - start refreshing
                    startAutoRefresh();
                } else {
                    // Window lost focus - stop refreshing
                    stopAutoRefresh();
                }
            });
            startAutoRefresh();
        }

        // Load status data from API
        async function loadStatus() {
            try {
                showLoading(true);
                hideError();

                const response = await fetch('/api/1/metrics');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                statusData = await response.json();
                if (!statusData.success) {
                    throw new Error(statusData.error || 'API returned error');
                }

                renderStatus(statusData.data);
                showContent();

            } catch (error) {
                console.error('Failed to load status:', error);
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        // Render status data to page
        function renderStatus(data) {
            renderSystemMetrics(data);
            renderSystemResourcesMetrics(data);
            renderMemoryMetrics(data);
            renderDatabaseMetrics(data);
            renderWebSocketMetrics(data);
            renderLoadMetrics(data);
            renderHostMetrics(data);
            renderPM2Metrics(data);
            renderNamespaces(data);
        }

        // Utility function to generate metric rows HTML
        function generateStatusContent(rows) {
            return rows.map(row => {
                if (Array.isArray(row) && row.length === 2) {
                    // Simple [label, value] pair
                    const [label, value] = row;
                    return `<div class="jp-metric-row">
                        <span class="jp-metric-label">${label}</span>
                        <span class="jp-metric-value">${value}</span>
                    </div>`;
                } else if (typeof row === 'object' && row.type) {
                    // Special row types (progress bars, etc.)
                    switch (row.type) {
                        case 'progress':
                            return `<div class="jp-metric-row">
                                <span class="jp-metric-label">${row.label}</span>
                                <span class="jp-metric-value">${row.value}</span>
                            </div>
                            <div class="jp-metric-progress-bar">
                                <div class="jp-metric-progress-fill ${row.progressClass || ''}" style="width: ${row.percentage}%"></div>
                            </div>`;
                        case 'html':
                            // Raw HTML content
                            return row.content;
                        default:
                            return '';
                    }
                } else {
                    // Fallback for malformed data
                    return '';
                }
            }).join('');
        }

        function renderSystemMetrics(data) {
            const html = generateStatusContent([
                [ '{{i18n.view.admin.systemStatus.version}}',       data.version ],
                [ '{{i18n.view.admin.systemStatus.release}}',       data.release ],
                [ '{{i18n.view.admin.systemStatus.environment}}',   data.environment ],
                [ '{{i18n.view.admin.systemStatus.uptime}}',        data.uptimeFormatted ]
            ]);
            document.getElementById('systemMetrics').innerHTML = html;
        }

        function renderSystemResourcesMetrics(data) {
            if (!data.system) {
                document.getElementById('systemResourcesMetrics').innerHTML =
                    generateStatusContent([['{{i18n.view.admin.systemStatus.notAvailable}}', '']]);
                updateCardStatus('systemResourcesCard', 'systemResourcesIndicator', 'warning');
                return;
            }

            const html = generateStatusContent([
                [ '{{i18n.view.admin.systemStatus.platform}}', `${data.system.platform} (${data.system.arch})` ],
                [ '{{i18n.view.admin.systemStatus.nodeVersion}}', data.system.nodeVersion ],
                [ '{{i18n.view.admin.systemStatus.cpus}}', data.system.cpus ],
                [ '{{i18n.view.admin.systemStatus.totalMemory}}', formatBytes(data.system.totalMemory * 1024 * 1024) ],
                [ '{{i18n.view.admin.systemStatus.availableMemory}}', formatBytes(data.system.freeMemory * 1024 * 1024) ]
            ]);

            document.getElementById('systemResourcesMetrics').innerHTML = html;
            updateCardStatus('systemResourcesCard', 'systemResourcesIndicator', 'ok');
        }

        function renderMemoryMetrics(data) {
            const heapPercentage = Math.round((data.memory.used / data.memory.total) * 100);
            const systemPercentage = data.system ?
                Math.round(((data.system.totalMemory - data.system.freeMemory) / data.system.totalMemory) * 100) : 0;

            const rows = [
                {
                    type: 'progress',
                    label: '{{i18n.view.admin.systemStatus.heapUsed}}',
                    value: `${data.memory.used} MB`,
                    percentage: heapPercentage,
                    progressClass: heapPercentage > 80 ? 'jp-warning' : ''
                },
                [ '{{i18n.view.admin.systemStatus.heapTotal}}', `${data.memory.total} MB` ]
            ];

            if (data.system) {
                rows.push(
                    [ '{{i18n.view.admin.systemStatus.systemMemory}}', `${data.system.freeMemory} MB {{i18n.view.admin.systemStatus.free}} / ${data.system.totalMemory} MB {{i18n.view.admin.systemStatus.total}}` ],
                    {
                        type: 'progress',
                        label: '',
                        value: '',
                        percentage: systemPercentage,
                        progressClass: systemPercentage > 90 ? 'jp-danger' : systemPercentage > 75 ? 'jp-warning' : ''
                    }
                );
            }

            document.getElementById('memoryMetrics').innerHTML = generateStatusContent(rows);

            // Update card status
            updateCardStatus('memoryCard', 'memoryIndicator', heapPercentage > 80 ? 'warning' : 'ok');
        }

        function renderDatabaseMetrics(data) {
            const html = generateStatusContent([
                [ '{{i18n.view.admin.systemStatus.status}}', data.database.status ],
                [ '{{i18n.view.admin.systemStatus.database}}', data.database.name ]
            ]);
            document.getElementById('databaseMetrics').innerHTML = html;
        }

        function renderWebSocketMetrics(data) {
            if (!data.websockets) {
                const html = generateStatusContent([
                    [ '{{i18n.view.admin.systemStatus.status}}', '{{i18n.view.admin.systemStatus.limitedInfo}}' ]
                ]);
                document.getElementById('websocketMetrics').innerHTML = html;
                return;
            }

            const html = generateStatusContent([
                [ '{{i18n.view.admin.systemStatus.activeConnections}}', data.websockets.activeConnections ],
                [ '{{i18n.view.admin.systemStatus.totalMessages}}', data.websockets.totalMessages ],
                [ '{{i18n.view.admin.systemStatus.namespaces}}', data.websockets.namespaces ],
                [ '{{i18n.view.admin.systemStatus.uptime}}', formatUptime(data.websockets.uptime) ]
            ]);
            document.getElementById('websocketMetrics').innerHTML = html;
        }

        function renderLoadMetrics(data) {
            if (!data.system || !data.system.loadAverage) {
                const html = generateStatusContent([
                    [ '{{i18n.view.admin.systemStatus.status}}', '{{i18n.view.admin.systemStatus.limitedInfo}}' ]
                ]);
                document.getElementById('loadMetrics').innerHTML = html;
                return;
            }

            const load1 = data.system.loadAverage[0];
            const html = generateStatusContent([
                [ '{{i18n.view.admin.systemStatus.oneMinute}}', load1.toFixed(2) ],
                [ '{{i18n.view.admin.systemStatus.fiveMinutes}}', data.system.loadAverage[1].toFixed(2) ],
                [ '{{i18n.view.admin.systemStatus.fifteenMinutes}}', data.system.loadAverage[2].toFixed(2) ]
            ]);
            document.getElementById('loadMetrics').innerHTML = html;

            // Update card status based on load
            const status = load1 > 4.0 ? 'error' : (load1 > 2.0 ? 'warning' : 'ok');
            updateCardStatus('loadCard', 'loadIndicator', status);
        }

        function renderHostMetrics(data) {
            const rows = [];
            if (data.system) {
                rows.push([ '{{i18n.view.admin.systemStatus.hostname}}', data.system.hostname ]);
            }
            rows.push([ '{{i18n.view.admin.systemStatus.lastUpdated}}', `<span class="jp-timestamp">${formatDateTime(data.timestamp)}</span>` ]);

            document.getElementById('hostMetrics').innerHTML = generateStatusContent(rows);
        }

        function renderPM2Metrics(data) {
            // Always show PM2 card for admin users
            document.getElementById('pm2Card').style.display = 'block';

            if (!data.pm2) {
                // PM2 not available
                const html = generateStatusContent([
                    [ '{{i18n.view.admin.systemStatus.status}}', '{{i18n.view.admin.systemStatus.pm2NotAvailable}}' ],
                    [ '{{i18n.view.admin.systemStatus.reason}}', '{{i18n.view.admin.systemStatus.pm2NotInstalled}}' ]
                ]);
                document.getElementById('pm2Metrics').innerHTML = html;
                updateCardStatus('pm2Card', 'pm2Indicator', 'warning');
                //FIXME document.getElementById('pm2ProcessesCard').style.display = 'none';
                return;
            }

            const pm2 = data.pm2;
            const html = generateStatusContent([
                [ '{{i18n.view.admin.systemStatus.totalProcesses}}', pm2.totalProcesses ],
                [ '{{i18n.view.admin.systemStatus.running}}', pm2.running ],
                [ '{{i18n.view.admin.systemStatus.stopped}}', pm2.stopped ],
                [ '{{i18n.view.admin.systemStatus.errored}}', pm2.errored ]
            ]);
            document.getElementById('pm2Metrics').innerHTML = html;

            // Update status indicator
            const status = pm2.errored > 0 ? 'error' : pm2.stopped > 0 ? 'warning' : 'ok';
            updateCardStatus('pm2Card', 'pm2Indicator', status);

            // Show process details table if there are processes
            if (pm2.processes && pm2.processes.length > 0) {
                document.getElementById('pm2ProcessesCard').style.display = 'block';

                const processRows = pm2.processes.map(proc => `
                    <tr>
                        <td><code>${proc.name}</code></td>
                        <td>${proc.pid || 'N/A'}</td>
                        <td>
                            <span class="jp-badge jp-badge-${proc.status === 'online' ? 'success' : proc.status === 'stopped' ? 'warning' : 'danger'}">
                                ${proc.status}
                            </span>
                        </td>
                        <td>${proc.uptimeFormatted}</td>
                        <td>${proc.memory} MB</td>
                        <td>${proc.cpu}%</td>
                        <td>${proc.restarts}</td>
                    </tr>
                `).join('');

                document.getElementById('pm2ProcessesTableBody').innerHTML = processRows;
            } else {
                //FIXME document.getElementById('pm2ProcessesCard').style.display = 'none';
            }
        }

        function renderNamespaces(data) {
            // This would be populated from WebSocket stats if available
            //FIXME document.getElementById('wsNamespacesCard').style.display = 'none';
        }

        // Utility functions
        function updateCardStatus(cardId, indicatorId, status) {
            const card = document.getElementById(cardId);
            const indicator = document.getElementById(indicatorId);

            // Remove existing status classes
            card.className = card.className.replace(/jp-status-(ok|warning|error)/g, '');
            indicator.className = indicator.className.replace(/jp-(warning|error)/g, '');

            // Add new status classes
            card.classList.add(`jp-status-${status}`);
            if (status !== 'ok') {
                indicator.classList.add(`jp-${status}`);
            }
        }

        function formatUptime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m ${secs}s`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function formatDateTime(isoString) {
            return new Date(isoString).toLocaleString();
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
        }

        function showContent() {
            document.getElementById('statusContent').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('statusContent').style.display = 'none';
        }

        function hideError() {
            document.getElementById('errorState').style.display = 'none';
        }

        // Initialize page on page load
        jPulse.dom.ready(() => {
            loadStatus();

            // Setup focus-aware auto-refresh
            initWindowFocusHandling();
        });

        function refreshStatus() {
            loadStatus();
        }
    </script>
</body>
</html>

<!-- EOF webapp/view/admin/system-status.shtml -->
