<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / Admin / System Status
 * @tagline         Admin system status interface
 * @description     System monitoring and health dashboard for site administrators
 * @file            webapp/view/admin/system-status.shtml
 * @version         1.6.8
 * @release         2026-02-05
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 1.7, Claude Sonnet 4
-->
<html {{appConfig.system.htmlAttrs}}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{i18n.view.admin.systemStatus.title}} - {{app.site.shortName}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific styles only - common styles are in jpulse-common.css */
        .local-components-title {
            margin: 1rem 0 0.5rem 0;
        }
        .local-component-header {
            border-top: 1px solid var(--jp-theme-border-color, #c0c0c0);
            padding-top: 0.25rem;
            background-image: linear-gradient(
                to bottom,
                var(--jp-theme-bg-secondary, #f6f6f6) 0%,
                var(--jp-theme-bg-primary, #ffffff) 100%
            );
        }
        .local-component-header .jp-status-indicator {
            display: inline-block;
            vertical-align: middle;
        }
        .local-refresh-info {
            text-align: center;
            color: var(--jp-theme-text-muted, #aaa);
            font-size: 0.9em;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--jp-theme-bg-secondary, #f8f9fa);
            border-radius: 6px;
            border: 1px solid var(--jp-theme-border-light, #e9ecef);
        }
        .local-compliance-details {
            padding: 1rem;
            border: 1px solid var(--jp-theme-border-color, #ddd);
            border-radius: 6px;
            background: var(--jp-theme-bg-secondary, #f9f9f9);
        }

        .local-compliance-summary {
            cursor: pointer;
            font-weight: bold;
            user-select: none;
        }

        .local-compliance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .local-compliance-grid pre {
            max-height: 400px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .local-compliance-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    {{#component "adminCards.systemStatus" order=40}}
        {{!-- This card is automatically included in the admin dashboard at admin/index.shtml --}}
        <a href="/admin/system-status.shtml" class="jp-card-dashboard jp-icon-btn">
            <div class="jp-icon-container">{{components.jpIcons.systemStatusSvg size="64"}}</div>
            <h3 class="jp-card-title">{{i18n.view.admin.index.systemStatus}}</h3>
            <p class="jp-card-description">{{i18n.view.admin.index.systemStatusDesc}}</p>
        </a>
    {{/component}}

    <div class="jp-main">
        <div class="jp-container-1200">
          {{#if user.isAdmin}}
            <div class="jp-page-header">
                <h1>{{components.jpIcons.systemStatusSvg size="26"}} {{i18n.view.admin.systemStatus.title}}</h1>
                <span class="jp-subtitle">{{i18n.view.admin.systemStatus.subtitle}}</span>
            </div>

            <!-- Error State -->
            <div id="errorState" class="jp-alert jp-alert-danger jp-hidden">
                <strong>{{i18n.view.admin.systemStatus.errorTitle}}</strong>
                <span id="errorMessage">{{i18n.view.admin.systemStatus.errorMessage}}</span>
            </div>

            <!-- Status Content -->
            <div id="statusContent" class="jp-hidden">

                <!-- 1. Overall Cluster Health -->
                <div class="jp-card jp-mb-30">
                    <div id="clusterHealthGrid" class="jp-stats-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- 1.1. License Compliance Reporting (W-137) -->
                <div id="complianceSection" class="jp-hidden">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- 1.5. Component Health (Aggregated) -->
                <h2>{{i18n.view.admin.systemStatus.componentHealth.title}}</h2>
                <div id="componentHealthGrid" class="jp-status-grid">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- 2. Server Summary Cards -->
                <h2>{{i18n.view.admin.systemStatus.serverSummariesTitle}}</h2>
                <div id="serverSummariesGrid" class="jp-status-grid">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- 3. Detailed Server Tabs -->
                <h2>{{i18n.view.admin.systemStatus.serverDetailsTitle}}</h2>
                <!-- Tab Navigation -->
                <div id="serverTabs" class="jp-tabs">
                </div>
                <!-- Tab Content Panels -->
                <div id="serverTabContent" class="jp-tabs-panels">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Refresh Information -->
                <div class="jp-info-box local-refresh-info">
                    <i class="jp-icon jp-icon-info"></i>
                    {{i18n.view.admin.systemStatus.refreshInfo}}
                    <br/>
                    <strong>{{i18n.view.admin.systemStatus.apiEndpoints}}</strong>
                    <a href="/api/1/health/status" target="_blank">/api/1/health/status</a> |
                    <a href="/api/1/health/metrics" target="_blank">/api/1/health/metrics</a>
                </div>
            </div>

          {{else}}
            <div class="jp-error-box">
                <p>{{i18n.view.admin.accessDenied}}</p>
            </div>
          {{/if}}
        </div>
    </div>

    {{file.include "jpulse-footer.tmpl"}}

    <script>
        // System Status Page JavaScript (Cluster-Aware)
        const app = {
            elements: {},
            data: null,
            timers: {
                refresh: null
            },
            config: {
                refreshIntervalMs: ({{appConfig.view.admin.systemStatus.refreshInterval}} || 30) * 1000,
                refreshInBackground: {{appConfig.view.admin.systemStatus.refreshInBackground}} || false
            },

            initialize() {
                this.cacheDOMElements();
                this.initWindowFocusHandling();
            },

            cacheDOMElements() {
                this.elements.loadingState = document.getElementById('loadingState');
                this.elements.errorState = document.getElementById('errorState');
                this.elements.errorMessage = document.getElementById('errorMessage');
                this.elements.statusContent = document.getElementById('statusContent');
                this.elements.clusterHealthGrid = document.getElementById('clusterHealthGrid');
                this.elements.complianceSection = document.getElementById('complianceSection');
                this.elements.componentHealthGrid = document.getElementById('componentHealthGrid');
                this.elements.serverSummariesGrid = document.getElementById('serverSummariesGrid');
                this.elements.serverTabContent = document.getElementById('serverTabContent');
            },

            initWindowFocusHandling() {
                jPulse.UI.windowFocus.register((hasFocus) => {
                    if (hasFocus) {
                        this.startAutoRefresh();
                    } else {
                        this.stopAutoRefresh();
                    }
                });
                this.startAutoRefresh();
            },

            startAutoRefresh() {
                if (this.timers.refresh) {
                    clearInterval(this.timers.refresh);
                }
        //        this.timers.refresh = setInterval(() => this.loadStatus(), this.config.refreshIntervalMs);
                this.loadStatus();
            },

            stopAutoRefresh() {
                if (this.timers.refresh && !this.config.refreshInBackground) {
                    clearInterval(this.timers.refresh);
                    this.timers.refresh = null;
                }
            },

            async loadStatus() {
                try {
                    this.showLoading(true);
                    this.hideError();

                    const response = await fetch('/api/1/health/metrics?mode=cluster');
                    const result = await response.json();

                    if (!result.success || !result.data) {
                        throw new Error(result.error || result.message || 'API returned an invalid response');
                    }

                    this.data = result.data;
                    this.render();
                    this.showContent();

                } catch (error) {
                    console.error('- jPulse: Failed to load status:', error);
                    this.showError(error.message);
                } finally {
                    this.showLoading(false);
                }
            },

            render() {
                this.renderClusterHealth();
                this.renderCompliance();
                this.renderComponentHealth();
                this.renderServerSummaries();
                this.renderServerDetails();
            },

            renderClusterHealth() {
                if (!this.data) return;
                const stats = this.data.statistics || {};

                const cards = [
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.totalServers}}`, value: this.data.servers?.length || 0 },
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.totalInstances}}`, value: stats.totalInstances || 0 },
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.stopped}}`, value: stats.stoppedProcesses || 0 },
                    { label: `{{i18n.view.admin.systemStatus.clusterHealth.errored}}`, value: stats.erroredProcesses || 0 }
                ];

                this.elements.clusterHealthGrid.innerHTML = cards.map(card => `
                    <div class="jp-stat-card">
                        <div class="jp-stat-number">${card.value}</div>
                        <div class="jp-stat-label">${card.label}</div>
                    </div>
                `).join('');
            },

            _utcToLocalTime(reportTimeUtc) {
                // Convert scheduled HH:MM in UTC to local HH:MM (24-hour)
                const [schedHour, schedMin] = String(reportTimeUtc).split(':').map(Number);
                if (!Number.isFinite(schedHour) || !Number.isFinite(schedMin)) return '';
                const date = new Date();
                date.setUTCHours(schedHour, schedMin, 0, 0);
                return date.getHours().toString().padStart(2, '0') + ':'
                    +  date.getMinutes().toString().padStart(2, '0');
            },

            renderCompliance() {
                // W-137: Render license compliance section (admins only)
                const compliance = this.data?.compliance;
                if (!compliance || !compliance.status) {
                    this.elements.complianceSection.classList.add('jp-hidden');
                    return;
                }

                // Show section
                this.elements.complianceSection.classList.remove('jp-hidden');

                // Build status icon and text
                const statusMap = {
                    'compliant': { icon: '✓', text: '{{i18n.view.admin.systemStatus.licenseCompliance.status.compliant}}', class: 'success' },
                    'warning': { icon: '⚠️', text: '{{i18n.view.admin.systemStatus.licenseCompliance.status.warning}}', class: 'warning' },
                    'exempt-dev': { icon: 'ℹ️', text: '{{i18n.view.admin.systemStatus.licenseCompliance.status.exemptDev}}', class: 'info' },
                    'violation': { icon: '❌', text: '{{i18n.view.admin.systemStatus.licenseCompliance.status.violation}}', class: 'danger' },
                    'unknown': { icon: '', text: '{{i18n.view.admin.systemStatus.licenseCompliance.status.unknown}}', class: 'secondary' }
                };
                const statusInfo = statusMap[compliance.status] || statusMap.unknown;

                // Build HTML
                let html = '<h2>{{i18n.view.admin.systemStatus.licenseCompliance.heading}}</h2><div class="jp-card jp-mb-30">';

                // Warning banner (only if status is warning)
                if (compliance.status === 'warning') {
                    const warningMessage = compliance.message || '{{i18n.view.admin.systemStatus.licenseCompliance.warningBanner.defaultMessage}}';
                    html += `
                        <div class="jp-alert jp-alert-warning jp-mb-20">
                            <strong>⚠️ {{i18n.view.admin.systemStatus.licenseCompliance.warningBanner.title}}</strong>
                            <p>${warningMessage}</p>
                            <p>
                                <a href="mailto:team@jpulse.net" class="jp-btn jp-btn-secondary">
                                    {{i18n.view.admin.systemStatus.licenseCompliance.warningBanner.contactButton}}
                                </a>
                            </p>
                        </div>`;
                }

                // Reporting failed notice (only if >48h)
                if (compliance.reportingFailed) {
                    const hours = compliance.hoursSinceReport || '{{i18n.view.admin.systemStatus.unknown}}';
                    const retryHours = compliance.hoursUntilRetry || '{{i18n.view.admin.systemStatus.unknown}}';
                    const unableToSendText = '{{i18n.view.admin.systemStatus.licenseCompliance.reportingFailed.unableToSend}}'.replace('%HOURS%', hours);
                    const airGappedContactText = '{{i18n.view.admin.systemStatus.licenseCompliance.reportingFailed.airGappedContact}}'.replace('%EMAIL%', '<a href="mailto:team@jpulse.net">team@jpulse.net</a>');
                    const retryInfoText = '{{i18n.view.admin.systemStatus.licenseCompliance.reportingFailed.retryInfo}}'.replace('%HOURS%', retryHours);

                    html += `
                        <div class="jp-alert jp-alert-info jp-mb-20">
                            <strong>ℹ️ {{i18n.view.admin.systemStatus.licenseCompliance.reportingFailed.title}}</strong>
                            <p>${unableToSendText}</p>
                            <p><strong>{{i18n.view.admin.systemStatus.licenseCompliance.reportingFailed.airGappedQuestion}}</strong> ${airGappedContactText}</p>
                            <p><small>${retryInfoText}</small></p>
                        </div>`;
                }

                // Main compliance status
                html += '<div class="jp-status-metrics">';

                // Status
                html += `
                    <div class="jp-metric-row">
                        <span class="jp-metric-label"><strong>{{i18n.view.admin.systemStatus.licenseCompliance.statusLabel}}</strong></span>
                        <span class="jp-metric-value">
                            ${statusInfo.icon} <strong>${statusInfo.text}</strong>
                        </span>
                    </div>`;

                // Scheduled time
                if (compliance.reportTime) {
                    const scheduledLocalTime = this._utcToLocalTime(compliance.reportTime) || String(compliance.reportTime);
                    const scheduledLabel = '{{i18n.view.admin.systemStatus.licenseCompliance.localDaily}}'
                        .replace('%TIME%', scheduledLocalTime);
                    html += `
                        <div class="jp-metric-row">
                            <span class="jp-metric-label">{{i18n.view.admin.systemStatus.licenseCompliance.scheduledReportTime}}</span>
                            <span class="jp-metric-value">${scheduledLabel}</span>
                        </div>`;
                }

                // Last/next report timestamps
                if (compliance.lastReportTimestamp) {
                    const lastReport = jPulse.date.formatLocalDateAndTime(compliance.lastReportTimestamp);
                    const nextReport = jPulse.date.formatLocalDateAndTime(compliance.nextReportTimestamp);
                    html += `
                        <div class="jp-metric-row">
                            <span class="jp-metric-label">{{i18n.view.admin.systemStatus.licenseCompliance.lastReportSent}}</span>
                            <span class="jp-metric-value">${lastReport}</span>
                        </div>
                        <div class="jp-metric-row">
                            <span class="jp-metric-label">{{i18n.view.admin.systemStatus.licenseCompliance.nextReport}}</span>
                            <span class="jp-metric-value">${nextReport}</span>
                        </div>`;
                } else {
                    html += `
                        <div class="jp-metric-row">
                            <span class="jp-metric-label">Status</span>
                            <span class="jp-metric-value"><em>{{i18n.view.admin.systemStatus.licenseCompliance.noReportsSent}}</em></span>
                        </div>`;
                }

                // Monitor URL (if available)
                if (compliance.monitorUrl) {
                    html += `
                        <div class="jp-metric-row">
                            <span class="jp-metric-label">{{i18n.view.admin.systemStatus.licenseCompliance.deploymentDashboard}}</span>
                            <span class="jp-metric-value">
                                <a href="${compliance.monitorUrl}" target="_blank" class="jp-btn jp-btn-primary">
                                    {{i18n.view.admin.systemStatus.licenseCompliance.viewDashboard}}
                                </a>
                            </span>
                        </div>`;
                }

                // Manual report trigger button
                html += `
                    <div class="jp-metric-row">
                        <span class="jp-metric-label">{{i18n.view.admin.systemStatus.licenseCompliance.manualReport}}</span>
                        <span class="jp-metric-value">
                            <button id="send-compliance-report-btn" class="jp-btn jp-btn-secondary">
                                {{i18n.view.admin.systemStatus.licenseCompliance.sendReportNow}}
                            </button>
                        </span>
                    </div>`;

                html += '</div>'; // Close jp-status-metrics

                // Transparency: Show last report and response (collapsible)
                if (compliance.lastReport && Object.keys(compliance.lastReport).length > 0) {
                    const reportJson = JSON.stringify(compliance.lastReport, null, 2);
                    const responseJson = JSON.stringify(compliance.lastResponse, null, 2);
                    const privacyNoticeText = '{{i18n.view.admin.systemStatus.licenseCompliance.transparency.privacyNotice}}'.replace(
                        '%LINK%',
                        '<a href="https://jpulse.net/legal/privacy" target="_blank">{{i18n.view.admin.systemStatus.licenseCompliance.transparency.privacyPolicyLink}}</a>'
                    );

                    html += `
                        <details class="jp-card jp-mt-15 local-compliance-details">
                            <summary class="local-compliance-summary">
                                {{i18n.view.admin.systemStatus.licenseCompliance.transparency.summaryTitle}}
                            </summary>

                            <div class="local-compliance-grid jp-mt-15">
                                <!-- Request -->
                                <div>
                                    <h4 class="jp-mb-10 jp-text-primary">{{i18n.view.admin.systemStatus.licenseCompliance.transparency.requestSent}}</h4>
                                    <pre class="jp-pre jp-m-0">${reportJson}</pre>
                                </div>

                                <!-- Response -->
                                <div>
                                    <h4 class="jp-mb-10 jp-text-primary">{{i18n.view.admin.systemStatus.licenseCompliance.transparency.responseReceived}}</h4>
                                    <pre class="jp-pre jp-m-0">${responseJson}</pre>
                                </div>
                            </div>

                            <p class="jp-mt-15 jp-text-muted jp-text-small">
                                ${privacyNoticeText}
                            </p>
                        </details>`;
                }

                // Opt-in/opt-out information paragraph
                const adminEmailOptIn = compliance.adminEmailOptIn;
                if (adminEmailOptIn) {
                    // Opted-in
                    const dashboardLink = compliance.monitorUrl
                        ? `<a href="${compliance.monitorUrl}" target="_blank">jpulse.net/site-monitor/${compliance.siteUuid || '[uuid]'}</a>`
                        : 'jpulse.net/site-monitor/[uuid]';
                    const optInText = '{{i18n.view.admin.systemStatus.licenseCompliance.transparency.optedIn}}'.replace('%LINK%', dashboardLink);
                    html += `<p class="jp-mt-15 jp-text-small">${optInText}</p>`;
                } else {
                    // Opted-out
                    const optOutText = '{{i18n.view.admin.systemStatus.licenseCompliance.transparency.optedOut}}';
                    html += `<p class="jp-mt-15 jp-text-small">${optOutText}</p>`;
                }

                html += '</div>'; // Close jp-card

                this.elements.complianceSection.innerHTML = html;

                // Attach event listener for "Send Report Now" button
                const sendButton = document.getElementById('send-compliance-report-btn');
                if (sendButton) {
                    sendButton.addEventListener('click', () => this.sendComplianceReport());
                }
            },

            async sendComplianceReport() {
                const button = document.getElementById('send-compliance-report-btn');
                if (!button) return;

                try {
                    // Disable button and show loading
                    button.disabled = true;
                    button.textContent = '{{i18n.view.admin.systemStatus.licenseCompliance.sending}}';

                    const response = await fetch('/api/1/health/compliance/send-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();

                    if (result.success) {
                        jPulse.UI.toast.success(result.message || 'Compliance report sent');
                        // Reload data to show updated compliance status
                        await this.loadStatus();
                    } else {
                        // Display server's i18n message (already includes error details)
                        const errorMessage = result.error || result.message || 'Failed to send license compliance report';
                        console.error('- jPulse: Compliance report failed:', errorMessage);
                        jPulse.UI.toast.error(errorMessage, { duration: 10000 }); // Show for 10 seconds
                        button.disabled = false;
                        button.textContent = '{{i18n.view.admin.systemStatus.licenseCompliance.sendReportNow}}';
                    }
                } catch (error) {
                    console.error('- jPulse: Failed to send compliance report:', error);
                    // Network error - use generic message since we can't reach server for i18n
                    jPulse.UI.toast.error(error.error || error.message || 'Failed to send license compliance report', { duration: 10000 });
                    button.disabled = false;
                    button.textContent = '{{i18n.view.admin.systemStatus.licenseCompliance.sendReportNow}}';
                }
            },

            renderComponentHealth() {
                if (!this.data || !this.data.statistics || !this.data.statistics.components) {
                    this.elements.componentHealthGrid.innerHTML = '<p>{{i18n.view.admin.systemStatus.componentHealth.noComponents}}</p>';
                    return;
                }

                const components = this.data.statistics.components;
                this.elements.componentHealthGrid.innerHTML = '';

                // Get component data from first instance
                const getComponentFromInstance = (componentName) => {
                    if (!this.data.servers || this.data.servers.length === 0) return null;
                    for (const server of this.data.servers) {
                        if (server.instances && server.instances.length > 0) {
                            for (const instance of server.instances) {
                                if (instance.components && instance.components[componentName]) {
                                    return instance.components[componentName];
                                }
                            }
                        }
                    }
                    return null;
                };

                Object.entries(components).forEach(([componentName, component]) => {
                    const stats = component.stats || {};
                    const instanceComponent = getComponentFromInstance(componentName);
                    const status = instanceComponent?.status || 'unknown';
                    const statusClass = status === 'ok' ? 'success' : status === 'warning' ? 'warning' : 'danger';
                    const componentMeta = instanceComponent?.meta || {};
                    const fieldsMeta = componentMeta.fields || {};

                    // Helper to check if field should be visualized
                    const shouldVisualize = (fieldName) => {
                        const fieldMeta = fieldsMeta[fieldName] || {};
                        const effectiveVisualize = fieldMeta.visualize !== undefined ? fieldMeta.visualize :
                            (componentMeta.visualize !== undefined ? componentMeta.visualize : true);
                        return effectiveVisualize !== false;
                    };

                    // W-143: Special handling for Redis - split into two cards
                    if (componentName === 'redis' && stats.cache) {
                        // Card 1: RedisManager (connectivity/broker)
                        const redisCard = document.createElement('div');
                        redisCard.className = `jp-card jp-status-card jp-status-${status}`;

                        const redisStats = Object.entries(stats)
                            .filter(([key, value]) => {
                                return (typeof value !== 'object' || value === null) && shouldVisualize(key);
                            })
                            .map(([key, value]) => {
                                let displayValue = value;
                                if (typeof value === 'number') {
                                    if (key === 'uptime') {
                                        displayValue = jPulse.utils.formatUptime(value);
                                    } else {
                                        displayValue = value.toLocaleString();
                                    }
                                } else if (typeof value === 'boolean') {
                                    displayValue = value ? '{{i18n.view.admin.systemStatus.yes}}' : '{{i18n.view.admin.systemStatus.no}}';
                                } else if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(value)) {
                                    displayValue = jPulse.date.formatLocalDateAndTime(value);
                                }
                                return { key, value: displayValue };
                            });

                        const indicatorClass = status === 'ok' ? '' : status === 'warning' ? 'jp-warning' : 'jp-error';
                        const compDisplayName = instanceComponent?.component || componentName;
                        redisCard.innerHTML = `
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">${compDisplayName}</h3>
                                <span class="jp-status-indicator ${indicatorClass}"></span>
                            </div>
                            <div class="jp-status-metrics">
                                ${redisStats.map(stat => `
                                    <div class="jp-metric-row">
                                        <span class="jp-metric-label">${this.formatFieldName(stat.key)}</span>
                                        <span class="jp-metric-value">${stat.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        this.elements.componentHealthGrid.appendChild(redisCard);

                        // Card 2: Redis Cache (performance)
                        const cacheCard = document.createElement('div');
                        cacheCard.className = `jp-card jp-status-card jp-status-${status}`;

                        const cache = stats.cache;
                        const cacheStats = [];

                        if (cache.hitRate !== undefined) {
                            cacheStats.push({
                                key: 'cacheHitRate',
                                value: `${cache.hitRate}%`
                            });
                        }
                        if (cache.operations) {
                            cacheStats.push({
                                key: 'cacheGets',
                                value: (cache.operations.gets || 0).toLocaleString()
                            });
                            cacheStats.push({
                                key: 'cacheSets',
                                value: (cache.operations.sets || 0).toLocaleString()
                            });
                            cacheStats.push({
                                key: 'cacheDeletes',
                                value: (cache.operations.deletes || 0).toLocaleString()
                            });
                        }
                        if (cache.hits !== undefined) {
                            cacheStats.push({
                                key: 'cacheHits',
                                value: cache.hits.toLocaleString()
                            });
                        }
                        if (cache.misses !== undefined) {
                            cacheStats.push({
                                key: 'cacheMisses',
                                value: cache.misses.toLocaleString()
                            });
                        }

                        cacheCard.innerHTML = `
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">{{i18n.view.admin.systemStatus.componentHealth.redisCache}}</h3>
                                <span class="jp-status-indicator ${indicatorClass}"></span>
                            </div>
                            <div class="jp-status-metrics">
                                ${cacheStats.map(stat => `
                                    <div class="jp-metric-row">
                                        <span class="jp-metric-label">${this.formatFieldName(stat.key)}</span>
                                        <span class="jp-metric-value">${stat.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        this.elements.componentHealthGrid.appendChild(cacheCard);
                    } else {
                        // Standard card for non-Redis components
                        const card = document.createElement('div');
                        card.className = `jp-card jp-status-card jp-status-${status}`;

                        const keyStats = Object.entries(stats)
                            .filter(([key, value]) => {
                                return (typeof value !== 'object' || value === null) && shouldVisualize(key);
                            })
                            .map(([key, value]) => {
                                let displayValue = value;
                                if (typeof value === 'number') {
                                    if (key === 'uptime') {
                                        displayValue = jPulse.utils.formatUptime(value);
                                    } else {
                                        displayValue = value.toLocaleString();
                                    }
                                } else if (typeof value === 'boolean') {
                                    displayValue = value ? '{{i18n.view.admin.systemStatus.yes}}' : '{{i18n.view.admin.systemStatus.no}}';
                                } else if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(value)) {
                                    displayValue = jPulse.date.formatLocalDateAndTime(value);
                                }
                                return { key, value: displayValue };
                            });

                        const indicatorClass = status === 'ok' ? '' : status === 'warning' ? 'jp-warning' : 'jp-error';
                        const compDisplayName = instanceComponent?.component || componentName;
                        card.innerHTML = `
                            <div class="jp-status-header">
                                <h3 class="jp-status-title">${compDisplayName}</h3>
                                <span class="jp-status-indicator ${indicatorClass}"></span>
                            </div>
                            <div class="jp-status-metrics">
                                ${keyStats.map(stat => `
                                    <div class="jp-metric-row">
                                        <span class="jp-metric-label">${this.formatFieldName(stat.key)}</span>
                                        <span class="jp-metric-value">${stat.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        this.elements.componentHealthGrid.appendChild(card);
                    }
                });
            },

            formatFieldName(name) {
                // W-143: Special handling for cache metrics
                const cacheFieldMap = {
                    'cacheHitRate': 'Cache Hit Rate',
                    'cacheGets': 'Cache Gets',
                    'cacheSets': 'Cache Sets',
                    'cacheDeletes': 'Cache Deletes',
                    'cacheHits': 'Cache Hits',
                    'cacheMisses': 'Cache Misses'
                };

                if (cacheFieldMap[name]) {
                    return cacheFieldMap[name];
                }

                // Convert camelCase to Title Case
                // Add space before capital letters and before numbers after letters
                return name
                    .replace(/([A-Z])/g, ' $1')
                    .replace(/([a-zA-Z])(\d)/g, '$1 $2')  // Add space before numbers after letters
                    .replace(/^./, str => str.toUpperCase())
                    .trim();
            },

            renderServerSummaries() {
                this.elements.serverSummariesGrid.innerHTML = ''; // Clear previous
                if (!this.data || !this.data.servers || this.data.servers.length === 0) {
                    this.elements.serverSummariesGrid.innerHTML = '<p>{{i18n.view.admin.systemStatus.serverSummaries.noServers}}</p>';
                    return;
                }

                this.data.servers.forEach((server, index) => {
                    const serverId = `server-summary-${server.serverId || index}`;
                    const card = document.createElement('div');
                    card.className = 'jp-card jp-status-card';
                    card.innerHTML = `
                        <div class="jp-status-header">
                            <h3 class="jp-status-title">Server ${server.serverId}</h3>
                            <div class="jp-status-indicator" id="${serverId}-indicator"></div>
                        </div>
                        <div id="${serverId}-metrics"></div>
                    `;
                    this.elements.serverSummariesGrid.appendChild(card);

                    const loadAvg = server.loadAverage ? server.loadAverage[0] : 0;
                    const memPercentage = server.totalMemory ? Math.round(((server.totalMemory - server.freeMemory) / server.totalMemory) * 100) : 0;

                    const rows = [
                        [`{{i18n.view.admin.systemStatus.serverSummaries.serverName}}`, server.serverName],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.ipAddress}}`, server.ip],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.cpus}}`, server.cpus],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.instances}}`, server.instances?.length || 0],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.loadAverage}}`, loadAvg.toFixed(2)],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.memoryPercentage}}`, `${memPercentage}%`],
                        [`{{i18n.view.admin.systemStatus.serverSummaries.systemUptime}}`, server.uptimeFormatted || `{{i18n.view.admin.systemStatus.unknown}}`],
                    ];
                    document.getElementById(`${serverId}-metrics`).innerHTML = this.generateMetricRows(rows);

                    let status = 'ok';
                    if (memPercentage > 90 || loadAvg > 4.0) status = 'error';
                    else if (memPercentage > 75 || loadAvg > 2.0) status = 'warning';
                    this.updateCardStatus(card, document.getElementById(`${serverId}-indicator`), status);
                });
            },

            renderServerDetails() {
                this.elements.serverTabContent.innerHTML = '';

                if (!this.data || !this.data.servers || !this.data.servers.length === 0) return;

                const tabsConfig = [];

                this.data.servers.forEach((server, index) => {

                    // Add tab to the config
                    const serverId = server.serverId || index;
                    tabsConfig.push({
                        id: `server-nav-${serverId}`,
                        label: `{{i18n.view.admin.systemStatus.serverTabContent.tabLabel}}`.replace('%SERVERID%', serverId),
                        panelId: `server-panel-${serverId}`
                    });

                    // Create Tab Panel
                    const panel = document.createElement('div');
                    panel.id = `server-panel-${serverId}`;
                    panel.className = 'jp-tab-panel';
                    const unknown = `{{i18n.view.admin.systemStatus.unknown}}`;
                    const notApplicable = `{{i18n.view.admin.systemStatus.notApplicable}}`;

                    const pm2InstanceDetails = (server.instances || []).sort((a, b) => {
                        return a.instanceId.localeCompare(b.instanceId);
                    }).map(inst => `
                        <tr>
                            <td>${inst.pm2ProcessName ?? notApplicable}</td>
                            <td>${inst.instanceId ?? notApplicable}</td>
                            <td>${inst.pid}</td>
                            <td><span class="jp-badge jp-badge-${inst.status === 'online' ? 'success' : 'danger'}">${inst.status || notApplicable}</span></td>
                            <td>${inst.restarts ?? notApplicable}</td>
                            <td>${inst.cpu ? `${inst.cpu}%` : unknown}</td>
                            <td>${inst.memory ? `${inst.memory.used} MB` : unknown}</td>
                            <td>${inst.uptimeFormatted || unknown}</td>
                        </tr>
                    `).join('');

                    const wsStats = (server.instances || []).reduce((acc, inst) => {
                        acc.localConnections += inst.websockets?.localConnections || 0;
                        acc.localMessages += inst.websockets?.localMessages || 0;
                        return acc;
                    }, { localConnections: 0, localMessages: 0 });

                    panel.innerHTML = `<div class="jp-card">
                        <div class="jp-status-grid jp-gap-20 jp-mb-30">
                            <div class="jp-card jp-mb-0">
                                <h4 class="jp-status-title">{{i18n.view.admin.systemStatus.serverTabContent.systemInfo}}</h4>
                                ${this.generateMetricRows([
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.serverName}}`, server.serverName],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.ipAddress}}`, server.ip || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.platform}}`, `${server.platform} (${server.arch})`],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.cpus}}`, server.cpus],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.nodeVersion}}`, server.nodeVersion],
                                ])}
                            </div>
                            <div class="jp-card jp-mb-0">
                                <h4 class="jp-status-title">{{i18n.view.admin.systemStatus.serverTabContent.performance}}</h4>
                                ${this.generateMetricRows([
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.oneMinute}}`, server.loadAverage?.[0]?.toFixed(2) || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.fiveMinutes}}`, server.loadAverage?.[1]?.toFixed(2) || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.fifteenMinutes}}`, server.loadAverage?.[2]?.toFixed(2) || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.freeMemory}}`, this.formatBytes((server.freeMemory || 0) * 1024 * 1024)],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.totalMemory}}`, this.formatBytes((server.totalMemory || 0) * 1024 * 1024)],
                                ])}
                            </div>
                            <div class="jp-card jp-mb-0">
                                <h4 class="jp-status-title">{{i18n.view.admin.systemStatus.serverTabContent.database}}</h4>
                                ${this.generateMetricRows([
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.databaseType}}`, server.database?.type || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.status}}`, server.database?.status || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.version}}`, server.database?.version || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.connections}}`, `${server.database?.connections?.current || 0} / ${server.database?.connections?.available || 0}`],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.hostname}}`, server.database?.hostname || unknown],
                                ])}
                            </div>
                            <div class="jp-card jp-mb-0">
                                <h4 class="jp-status-title">{{i18n.view.admin.systemStatus.serverTabContent.webSockets}}</h4>
                                ${this.generateMetricRows([
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.uptime}}`, server.uptimeFormatted || unknown],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.connections}}`, wsStats.localConnections],
                                    [`{{i18n.view.admin.systemStatus.serverTabContent.messages}}`, wsStats.localMessages],
                                ])}
                            </div>
                        </div>

                        <h3 class="jp-title">{{i18n.view.admin.systemStatus.instanceDetails.heading}}</h3>
                        <div class="jp-status-grid">
                            ${ (server.instances || []).sort((a, b) => {
                                return a.instanceId.localeCompare(b.instanceId);
                            }).map(inst => {
                                const instanceComponents = inst.components || {};
                                const formatField = (name) => {
                                    // W-143: Special handling for cache metrics
                                    const cacheFieldMap = {
                                        'cacheHitRate': 'Cache Hit Rate',
                                        'cacheGets': 'Cache Gets',
                                        'cacheSets': 'Cache Sets',
                                        'cacheDeletes': 'Cache Deletes',
                                        'cacheHits': 'Cache Hits',
                                        'cacheMisses': 'Cache Misses'
                                    };

                                    if (cacheFieldMap[name]) {
                                        return cacheFieldMap[name];
                                    }

                                    // Convert camelCase to Title Case
                                    // Add space before capital letters and before numbers after letters
                                    return name
                                        .replace(/([A-Z])/g, ' $1')
                                        .replace(/([a-zA-Z])(\d)/g, '$1 $2')  // Add space before numbers after letters
                                        .replace(/^./, str => str.toUpperCase())
                                        .trim();
                                };

                                // Build component metrics as jp-metric-row elements
                                const componentMetrics = Object.keys(instanceComponents).length > 0 ?
                                    Object.entries(instanceComponents).flatMap(([compName, comp]) => {
                                        const compStats = comp.stats || {};
                                        const compStatus = comp.status || 'unknown';
                                        const compMeta = comp.meta || {};
                                        const fieldsMeta = compMeta.fields || {};

                                        // Helper to check if field should be visualized
                                        const shouldVisualize = (fieldName) => {
                                            const fieldMeta = fieldsMeta[fieldName] || {};
                                            const effectiveVisualize = fieldMeta.visualize !== undefined ? fieldMeta.visualize :
                                                (compMeta.visualize !== undefined ? compMeta.visualize : true);
                                            return effectiveVisualize !== false;
                                        };

                                        // Get all key stats (filter out complex objects/arrays and non-visualized fields)
                                        let keyStats = Object.entries(compStats)
                                            .filter(([key, value]) => {
                                                return (typeof value !== 'object' || value === null) && shouldVisualize(key);
                                            })
                                            .map(([key, value]) => {
                                                let displayValue = value;
                                                if (typeof value === 'number') {
                                                    // Special handling for uptime (in seconds) - format directly
                                                    if (key === 'uptime') {
                                                        displayValue = jPulse.utils.formatUptime(value);
                                                    } else {
                                                        displayValue = value.toLocaleString();
                                                    }
                                                } else if (typeof value === 'boolean') {
                                                    displayValue = value ? '{{i18n.view.admin.systemStatus.yes}}' : '{{i18n.view.admin.systemStatus.no}}';
                                                } else if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(value)) {
                                                    // ISO timestamp - format it
                                                    displayValue = jPulse.date.formatLocalDateAndTime(value);
                                                }
                                                return { key, value: displayValue };
                                            });

                                        // W-143: Special handling for Redis cache statistics (per-instance)
                                        if (compName === 'redis' && compStats.cache) {
                                            const cache = compStats.cache;
                                            // Add cache hit rate (most important metric)
                                            if (cache.hitRate !== undefined) {
                                                keyStats.push({
                                                    key: 'cacheHitRate',
                                                    value: `${cache.hitRate}%`
                                                });
                                            }
                                            // Add cache operations summary
                                            if (cache.operations) {
                                                keyStats.push({
                                                    key: 'cacheGets',
                                                    value: (cache.operations.gets || 0).toLocaleString()
                                                });
                                                keyStats.push({
                                                    key: 'cacheSets',
                                                    value: (cache.operations.sets || 0).toLocaleString()
                                                });
                                                keyStats.push({
                                                    key: 'cacheDeletes',
                                                    value: (cache.operations.deletes || 0).toLocaleString()
                                                });
                                            }
                                            // Add hit/miss counts
                                            if (cache.hits !== undefined) {
                                                keyStats.push({
                                                    key: 'cacheHits',
                                                    value: cache.hits.toLocaleString()
                                                });
                                            }
                                            if (cache.misses !== undefined) {
                                                keyStats.push({
                                                    key: 'cacheMisses',
                                                    value: cache.misses.toLocaleString()
                                                });
                                            }
                                        }

                                        // Return component header row and metric rows
                                        // Status indicator: ok = green (default), warning = yellow, error/unknown = red
                                        const indicatorClass = compStatus === 'ok' ? '' : compStatus === 'warning' ? 'jp-warning' : 'jp-error';
                                        const compDisplayName = comp.component || compName;
                                        const rows = [
                                            `<div class="jp-metric-row local-component-header">
                                                <span class="jp-metric-label"><strong>${compDisplayName}</strong></span>
                                                <span class="jp-metric-value"><span class="jp-status-indicator ${indicatorClass}"></span></span>
                                            </div>`
                                        ];

                                        keyStats.forEach(stat => {
                                            rows.push(`
                                                <div class="jp-metric-row">
                                                    <span class="jp-metric-label">${formatField(stat.key)}</span>
                                                    <span class="jp-metric-value">${stat.value}</span>
                                                </div>
                                            `);
                                        });

                                        return rows;
                                    }).join('') : '';

                                return `
                                <div class="jp-card">
                                    <h4 class="jp-status-title">${ `{{i18n.view.admin.systemStatus.instanceDetails.title}}`.replace('%INSTANCEID%', inst.instanceId).replace('%PID%', inst.pid) }</h4>
                                    ${this.generateMetricRows([
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.jPulseVersion}}`, inst?.jPulse?.version || unknown],
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.siteVersion}}`, inst?.site?.version || unknown],
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.environment}}`, inst.environment || unknown],
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.dbStatus}}`, inst.database?.status || unknown],
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.dbName}}`, inst.database?.name || unknown],
                                        [`{{i18n.view.admin.systemStatus.instanceDetails.port}}`, inst.port || unknown],
                                        ['CPU Usage', inst.cpu ? `${inst.cpu}%` : unknown],
                                        ['Memory Usage', inst.memory?.percentage ? `${inst.memory.percentage}% (${inst.memory.used} MB)` : `${inst.memory?.used || unknown} MB`],
                                        ['Requests/min', inst.metrics?.requestsPerMin !== undefined ? inst.metrics.requestsPerMin : unknown],
                                        ['Errors/min', inst.metrics?.errorsPerMin !== undefined ? inst.metrics.errorsPerMin : unknown],
                                        ['Error Rate', inst.metrics?.errorRate !== undefined ? `${inst.metrics.errorRate}%` : unknown],
                                    ])}
                                    ${componentMetrics ? `<h4 class="jp-status-title local-components-title">{{i18n.view.admin.systemStatus.instanceDetails.components}}</h4>${componentMetrics}` : ''}
                                </div>
                            `;
                            }).join('')}
                        </div>

                        <h3 class="jp-mt-15">{{i18n.view.admin.systemStatus.pm2Instances.heading}}</h3>
                        <div class="jp-table-responsive">
                            <table class="jp-table jp-table-hover">
                                <thead>
                                    <tr>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.processName}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.id}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.pid}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.status}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.restarts}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.cpu}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.memory}}</th>
                                        <th>{{i18n.view.admin.systemStatus.pm2Instances.uptime}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pm2InstanceDetails || '<tr><td colspan="8">{{i18n.view.admin.systemStatus.pm2Instances.noInstances}}</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                    this.elements.serverTabContent.appendChild(panel);
                });

                // Initialize the tabs using the config
                if (tabsConfig.length > 0) {
                    jPulse.UI.tabs.register('serverTabs', {
                        tabs: tabsConfig
                    }, tabsConfig[0].id);
                }
            },

            generateMetricRows(rows) {
                return rows.map(row => {
                    if (Array.isArray(row)) {
                        return `<div class="jp-metric-row"><span class="jp-metric-label">${row[0]}</span><span class="jp-metric-value">${row[1]}</span></div>`;
                    } else if (row.type === 'progress') {
                        return `
                            <div class="jp-metric-row">
                                <span class="jp-metric-label">${row.label}</span>
                                <span class="jp-metric-value">${row.value}</span>
                            </div>
                            <div class="jp-progress-bar">
                                <div class="jp-progress-bar-inner" style="width: ${row.percentage}%;"></div>
                            </div>
                        `;
                    }
                    return '';
                }).join('');
            },

            formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },

            updateCardStatus(cardEl, indicatorEl, status) {
                cardEl.className = cardEl.className.replace(/jp-status-(ok|warning|error)/g, '');
                indicatorEl.className = indicatorEl.className.replace(/jp-(warning|error)/g, '');
                cardEl.classList.add(`jp-status-${status}`);
                if (status !== 'ok') {
                    indicatorEl.classList.add(`jp-${status}`);
                }
            },

            showLoading(isLoading) {
                if (this.elements.loadingState) {
                    this.elements.loadingState.style.display = isLoading ? 'inline' : 'none';
                }
            },

            showContent() {
                this.elements.statusContent.classList.remove('jp-hidden');
                this.elements.errorState.classList.add('jp-hidden');
            },

            showError(message) {
                this.elements.errorMessage.textContent = message;
                this.elements.statusContent.classList.add('jp-hidden');
                this.elements.errorState.classList.remove('jp-hidden');
            },

            hideError() {
                this.elements.errorState.classList.add('jp-hidden');
            }
        };

        jPulse.dom.ready(() => {
            app.initialize();
        });
    </script>
</body>
</html>

<!-- EOF webapp/view/admin/system-status.shtml -->
