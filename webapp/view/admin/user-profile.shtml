<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / Admin / User Profile
 * @tagline         Admin user profile management with view and edit capabilities
 * @description     Admin user profile management with view and edit modes
 * @file            webapp/view/admin/user-profile.shtml
 * @version         1.3.4
 * @release         2025-12-02
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 2.0, Claude Sonnet 4.5
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{i18n.view.admin.userProfile.title}} - {{app.site.shortName}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific profile styles only */
        .local-profile-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007acc;
        }

        .local-profile-info h1 {
            margin: 0;
            color: #333;
        }

        .local-profile-info .jp-user-details {
            color: #666;
            margin: 5px 0;
        }

        .local-profile-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .local-profile-section.local-admin-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .local-profile-section h3 {
            margin-top: 0;
            color: #007acc;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .local-profile-section.local-admin-section h3 {
            color: #856404;
        }

        .local-profile-section p {
            color: #666;
            font-size: 0.9em;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .local-user-profile .jp-read-only-field {
            background: #f8f9fa;
            color: #6c757d;
        }

        .local-admin-section .jp-read-only-field {
            background: #fff3cd;
            color: #856404;
        }

        .local-roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .local-role-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .local-role-checkbox input[type="checkbox"] {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="jp-main">
      {{#if user.isAdmin}}
        <div class="jp-container-800 local-user-profile">
            <div class="jp-page-header">
                <h1>{{components.jpIcons.userSvg size="26"}} {{i18n.view.admin.userProfile.title}}</h1>
            </div>

            <div id="loadingState" class="jp-loading-state">
                {{i18n.view.admin.userProfile.loadingUser}}
            </div>

            <div id="userContent" style="display: none;">
                <div class="local-profile-header">
                    <div class="jp-user-avatar-large" id="userAvatar">
                        ?
                    </div>
                    <div class="local-profile-info">
                        <h1 id="userName">-</h1>
                        <div class="jp-user-details" id="userDetails">-</div>
                        <div class="jp-user-details">
                            <span class="jp-status-badge" id="userStatusBadge">-</span>
                        </div>
                    </div>
                </div>

                <!-- Administrative Settings Section -->
                <div class="local-profile-section local-admin-section">
                    <h3>{{i18n.view.admin.userProfile.adminSection}}</h3>
                    <p>{{i18n.view.admin.userProfile.adminSectionDesc}}</p>
                    <form id="adminForm" class="jp-form">
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="userId" class="jp-form-label">{{i18n.view.admin.userProfile.userIdReadOnly}}</label>
                                <input type="text" id="userId" name="userId" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                            <div class="jp-form-group">
                                <label for="uuid" class="jp-form-label">{{i18n.view.admin.userProfile.uuidReadOnly}}</label>
                                <input type="text" id="uuid" name="uuid" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                        </div>
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="email" class="jp-form-label">{{i18n.view.admin.userProfile.email}}</label>
                                <input type="email" id="email" name="email" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                        </div>
                        <div class="jp-form-group">
                            <label class="jp-form-label">{{i18n.view.admin.userProfile.roles}}</label>
                            <div id="rolesContainer" class="local-roles-grid">
                                <!-- Roles will be populated dynamically -->
                            </div>
                        </div>
                        <div class="jp-form-group">
                            <label for="status" class="jp-form-label">{{i18n.view.admin.userProfile.status}}</label>
                            <select id="status" name="status" class="jp-form-select" disabled>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </form>
                </div>

                <!-- Profile Information Section -->
                <div class="local-profile-section">
                    <h3>{{i18n.view.admin.userProfile.profileSection}}</h3>
                    <p>{{i18n.view.admin.userProfile.profileSectionDesc}}</p>
                    <form id="profileForm" class="jp-form">
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="firstName" class="jp-form-label">{{i18n.view.admin.userProfile.firstName}}</label>
                                <input type="text" id="firstName" name="firstName" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                            <div class="jp-form-group">
                                <label for="lastName" class="jp-form-label">{{i18n.view.admin.userProfile.lastName}}</label>
                                <input type="text" id="lastName" name="lastName" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                        </div>
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="nickName" class="jp-form-label">{{i18n.view.admin.userProfile.nickName}}</label>
                                <input type="text" id="nickName" name="nickName" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Preferences Section -->
                <div class="local-profile-section">
                    <h3>{{i18n.view.user.profile.preferences}}</h3>
                    <form id="preferencesForm" class="jp-form">
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="language" class="jp-form-label">{{i18n.view.admin.userProfile.language}}</label>
                                <select id="language" name="language" class="jp-form-select" disabled>
                                    <!-- Options will be replaced dynamically -->
                                </select>
                            </div>
                            <div class="jp-form-group">
                                <label for="theme" class="jp-form-label">{{i18n.view.admin.userProfile.theme}}</label>
                                <select id="theme" name="theme" class="jp-form-select" disabled>
                                    <!-- Options will be replaced dynamically -->
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="jp-btn-group">
                    <button id="editBtn" class="jp-btn jp-btn-primary" onclick="toggleEditMode()">{{i18n.view.admin.userProfile.edit}}</button>
                    <button id="saveBtn" class="jp-btn jp-btn-success jp-hidden" onclick="saveUser()">{{i18n.view.admin.userProfile.save}}</button>
                    <button id="cancelBtn" class="jp-btn jp-btn-secondary jp-hidden" onclick="cancelEdit()">{{i18n.view.admin.userProfile.cancel}}</button>
                </div>
            </div>

            <div id="errorState" class="jp-error-box" style="display: none;">
                {{i18n.view.admin.userProfile.failedToLoadUser}}
            </div>
        </div>
      {{else}}
        <div class="jp-error-box">
            {{i18n.view.auth.common.accessDenied}}
        </div>
      {{/if}}
    </div>

    <script>
        {{#if user.isAdmin}}
        let editMode = false;
        let originalValues = {};
        let currentUsername = null;
        let availableRoles = [];

        // Get username from query parameter
        function getUsernameFromQuery() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('username');
        }

        jPulse.dom.ready(async () => {
            currentUsername = getUsernameFromQuery();
            if (!currentUsername) {
                jPulse.UI.toast.error(`{{i18n.view.admin.userProfile.failedToLoadUser}}`);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                return;
            }

            await loadRoles();
            await loadStatuses();
            await loadLanguages();
            await loadThemes();
            await loadUser();
        });

        async function loadUser() {
            try {
                showLoading(true);
                const result = await jPulse.api.get(`/api/1/user?username=${encodeURIComponent(currentUsername)}`);

                if (result.success && result.data) {
                    const user = result.data;
                    displayUser(user);
                    showLoading(false);
                } else {
                    jPulse.UI.toast.error(result.error || `{{i18n.view.admin.userProfile.failedToLoadUser}}`);
                    showLoading(false);
                    document.getElementById('errorState').style.display = 'block';
                }
            } catch (error) {
                jPulse.UI.toast.error(`{{i18n.view.admin.userProfile.networkErrorLoading}}`.replace('%ERROR%', error.message));
                showLoading(false);
                document.getElementById('errorState').style.display = 'block';
            }
        }

        function displayUser(user) {
            // Update header
            const initials = (user.profile?.firstName?.[0] || '') + (user.profile?.lastName?.[0] || '') || '?';
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('userName').textContent = `${user.profile?.firstName || ''} ${user.profile?.lastName || ''}`.trim() || '-';
            document.getElementById('userDetails').textContent = `@${user.username || ''} â€¢ ${user.email || ''}`;

            const statusBadge = document.getElementById('userStatusBadge');
            if (user.status) {
                statusBadge.textContent = user.status.charAt(0).toUpperCase() + user.status.slice(1);
                statusBadge.className = `jp-status-badge jp-status-${user.status}`;
            }

            // Update admin fields
            document.getElementById('userId').value = user._id ? (typeof user._id === 'object' ? user._id.toString() : user._id) : '';
            document.getElementById('uuid').value = user.uuid || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('status').value = user.status || 'active';

            // Update roles checkboxes
            updateRolesCheckboxes(user.roles || []);

            // Update profile fields
            document.getElementById('firstName').value = user.profile?.firstName || '';
            document.getElementById('lastName').value = user.profile?.lastName || '';
            document.getElementById('nickName').value = user.profile?.nickName || '';

            // Update preferences
            document.getElementById('language').value = user.preferences?.language || 'en';
            document.getElementById('theme').value = user.preferences?.theme || 'light';

            // Show user content
            document.getElementById('userContent').style.display = 'block';
        }

        function updateRolesCheckboxes(userRoles) {
            const container = document.getElementById('rolesContainer');
            container.innerHTML = '';

            availableRoles.forEach(role => {
                const isChecked = userRoles.includes(role);
                const checkbox = document.createElement('div');
                checkbox.className = 'local-role-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="role_${role}" value="${role}" ${isChecked ? 'checked' : ''} disabled>
                    <label for="role_${role}">${role}</label>
                `;
                container.appendChild(checkbox);
            });
        }

        async function loadRoles() {
            try {
                const response = await jPulse.api.get('/api/1/user/enums?fields=roles');
                if (response.success && response.data && response.data.roles && Array.isArray(response.data.roles)) {
                    availableRoles = response.data.roles;
                }
            } catch (error) {
                console.error('Failed to load roles:', error);
            }
        }

        async function loadStatuses() {
            try {
                const response = await jPulse.api.get('/api/1/user/enums?fields=status');
                if (response.success && response.data && response.data.status) {
                    const statusSelect = document.getElementById('status');
                    const currentValue = statusSelect.value;
                    statusSelect.innerHTML = '';

                    const statuses = response.data.status;
                    if (Array.isArray(statuses)) {
                        statuses.forEach(status => {
                            const option = document.createElement('option');
                            option.value = status;
                            option.textContent = status;
                            statusSelect.appendChild(option);
                        });
                    }

                    // Restore selection if it was set
                    if (currentValue) {
                        statusSelect.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Failed to load statuses:', error);
            }
        }

        async function loadLanguages() {
            try {
                const response = await jPulse.api.get('/api/1/auth/languages');
                if (response.success) {
                    const languageSelect = document.getElementById('language');
                    const currentValue = languageSelect.value;
                    languageSelect.innerHTML = '';

                    const languages = response.data;
                    if (Array.isArray(languages)) {
                        languages.forEach(([code, name]) => {
                            const option = document.createElement('option');
                            option.value = code;
                            option.textContent = name;
                            languageSelect.appendChild(option);
                        });
                    }

                    languageSelect.value = currentValue;
                }
            } catch (error) {
                console.error('Failed to load languages:', error);
            }
        }

        async function loadThemes() {
            try {
                const response = await jPulse.api.get('/api/1/user/enums?fields=preferences.theme');
                if (response.success && response.data && response.data['preferences.theme']) {
                    const themeSelect = document.getElementById('theme');
                    const currentValue = themeSelect.value;
                    themeSelect.innerHTML = '';

                    const themes = response.data['preferences.theme'];
                    if (Array.isArray(themes)) {
                        themes.forEach(theme => {
                            const option = document.createElement('option');
                            option.value = theme;
                            option.textContent = theme;
                            themeSelect.appendChild(option);
                        });
                    }

                    themeSelect.value = currentValue;
                }
            } catch (error) {
                console.error('Failed to load themes:', error);
            }
        }

        function toggleEditMode() {
            editMode = !editMode;
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            if (editMode) {
                // Store original values
                originalValues = {
                    email: document.getElementById('email').value,
                    status: document.getElementById('status').value,
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    nickName: document.getElementById('nickName').value,
                    language: document.getElementById('language').value,
                    theme: document.getElementById('theme').value,
                    roles: getSelectedRoles()
                };

                // Enable editing for admin fields
                document.getElementById('email').readOnly = false;
                document.getElementById('email').classList.remove('jp-read-only-field');
                document.getElementById('status').disabled = false;

                // Enable role checkboxes
                availableRoles.forEach(role => {
                    const checkbox = document.getElementById(`role_${role}`);
                    if (checkbox) checkbox.disabled = false;
                });

                // Enable editing for profile fields
                ['firstName', 'lastName', 'nickName'].forEach(id => {
                    const field = document.getElementById(id);
                    field.readOnly = false;
                    field.classList.remove('jp-read-only-field');
                });

                // Enable editing for preference fields
                ['language', 'theme'].forEach(id => {
                    const field = document.getElementById(id);
                    field.disabled = false;
                });

                // Update buttons
                jPulse.dom.hide(editBtn);
                jPulse.dom.show(saveBtn);
                jPulse.dom.show(cancelBtn);
            } else {
                cancelEdit();
            }
        }

        function getSelectedRoles() {
            const roles = [];
            availableRoles.forEach(role => {
                const checkbox = document.getElementById(`role_${role}`);
                if (checkbox && checkbox.checked) {
                    roles.push(role);
                }
            });
            return roles;
        }

        function cancelEdit() {
            editMode = false;

            // Restore original values
            if (originalValues.email !== undefined) {
                document.getElementById('email').value = originalValues.email;
                document.getElementById('status').value = originalValues.status;
                document.getElementById('firstName').value = originalValues.firstName;
                document.getElementById('lastName').value = originalValues.lastName;
                document.getElementById('nickName').value = originalValues.nickName;
                document.getElementById('language').value = originalValues.language;
                document.getElementById('theme').value = originalValues.theme;

                // Restore roles
                if (originalValues.roles) {
                    availableRoles.forEach(role => {
                        const checkbox = document.getElementById(`role_${role}`);
                        if (checkbox) {
                            checkbox.checked = originalValues.roles.includes(role);
                        }
                    });
                }
            }

            // Disable editing for admin fields
            document.getElementById('email').readOnly = true;
            document.getElementById('email').classList.add('jp-read-only-field');
            document.getElementById('status').disabled = true;

            // Disable role checkboxes
            availableRoles.forEach(role => {
                const checkbox = document.getElementById(`role_${role}`);
                if (checkbox) checkbox.disabled = true;
            });

            // Disable editing for profile fields
            ['firstName', 'lastName', 'nickName'].forEach(id => {
                const field = document.getElementById(id);
                field.readOnly = true;
                field.classList.add('jp-read-only-field');
            });

            // Disable editing for preference fields
            ['language', 'theme'].forEach(id => {
                const field = document.getElementById(id);
                field.disabled = true;
            });

            // Update buttons
            jPulse.dom.show(document.getElementById('editBtn'));
            jPulse.dom.hide(document.getElementById('saveBtn'));
            jPulse.dom.hide(document.getElementById('cancelBtn'));
        }

        async function saveUser() {
            try {
                // Prepare update data
                const updateData = {
                    email: document.getElementById('email').value,
                    status: document.getElementById('status').value,
                    roles: getSelectedRoles(),
                    profile: {
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        nickName: document.getElementById('nickName').value
                    },
                    preferences: {
                        language: document.getElementById('language').value,
                        theme: document.getElementById('theme').value
                    }
                };

                const result = await jPulse.api.put(`/api/1/user?username=${encodeURIComponent(currentUsername)}`, updateData);

                if (result.success) {
                    jPulse.UI.toast.success(`{{i18n.view.admin.userProfile.userUpdatedSuccess}}`);
                    editMode = false;
                    cancelEdit();
                    await loadUser();
                } else {
                    jPulse.UI.toast.error(result.error || `{{i18n.view.admin.userProfile.failedToUpdateUser}}`);
                }
            } catch (error) {
                jPulse.UI.toast.error(`{{i18n.view.admin.userProfile.networkError}}`.replace('%ERROR%', error.message));
            }
        }

        function showLoading(show) {
            const loadingState = document.getElementById('loadingState');
            const userContent = document.getElementById('userContent');
            const errorState = document.getElementById('errorState');

            if (show) {
                loadingState.style.display = 'block';
                userContent.style.display = 'none';
                errorState.style.display = 'none';
            } else {
                loadingState.style.display = 'none';
            }
        }
        {{/if}}
    </script>

    {{file.include "jpulse-footer.tmpl"}}
</body>
</html>
