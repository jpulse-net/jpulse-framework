<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / Admin / User Profile
 * @tagline         Admin user profile management with view and edit capabilities
 * @description     Admin user profile management with view and edit modes
 * @file            webapp/view/admin/user-profile.shtml
 * @version         1.4.4
 * @release         2026-01-04
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 2.0, Claude Sonnet 4.5
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{i18n.view.admin.userProfile.title}} - {{app.site.shortName}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific profile styles only */
        .local-profile-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007acc;
        }

        .local-profile-info h1 {
            margin: 0;
            color: #333;
        }

        .local-profile-info .jp-user-details {
            color: #666;
            margin: 5px 0;
        }

        .local-profile-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .local-profile-section.local-admin-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .local-profile-section h3 {
            margin-top: 0;
            color: #007acc;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .local-profile-section.local-admin-section h3 {
            color: #856404;
        }

        .local-profile-section p {
            color: #666;
            font-size: 0.9em;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .local-user-profile .jp-read-only-field {
            background: #f8f9fa;
            color: #6c757d;
        }

        .local-admin-section .jp-read-only-field {
            background: #fff3cd;
            color: #856404;
        }

        .local-roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .local-role-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .local-role-checkbox input[type="checkbox"] {
            width: auto;
        }

        /* W-107: Plugin card styles */
        .local-plugin-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid transparent;
        }

        .local-plugin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .local-plugin-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .local-plugin-card-title h3 {
            margin: 0;
            color: #007acc;
        }

        .local-plugin-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .local-plugin-card-description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .local-plugin-field-grid {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 10px 15px;
        }

        .local-plugin-field-label {
            color: #555;
            font-weight: 500;
        }

        .local-plugin-field-value {
            color: #333;
        }

        .local-plugin-badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .local-plugin-badge-success {
            background: #d4edda;
            color: #155724;
        }

        .local-plugin-badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .local-plugin-badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .local-plugin-badge-info {
            background: #cce5ff;
            color: #004085;
        }
    </style>
</head>
<body>
    <div class="jp-main">
      {{#if user.isAdmin}}
        <div class="jp-container-800 local-user-profile">
            <div class="jp-page-header">
                <h1>{{components.jpIcons.userSvg size="26"}} {{i18n.view.admin.userProfile.title}}</h1>
            </div>

            <div id="loadingState" class="jp-loading-state">
                {{i18n.view.admin.userProfile.loadingUser}}
            </div>

            <div id="userContent" style="display: none;">
                <div class="local-profile-header">
                    <div class="jp-user-avatar-large" id="userAvatar">
                        ?
                    </div>
                    <div class="local-profile-info">
                        <h1 id="userName">-</h1>
                        <div class="jp-user-details" id="userDetails">-</div>
                        <div class="jp-user-details">
                            <span class="jp-status-badge" id="userStatusBadge">-</span>
                        </div>
                    </div>
                </div>

                <!-- Administrative Settings Section -->
                <div class="local-profile-section local-admin-section">
                    <h3>{{i18n.view.admin.userProfile.adminSection}}</h3>
                    <p>{{i18n.view.admin.userProfile.adminSectionDesc}}</p>
                    <form id="adminForm" class="jp-form">
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="userId" class="jp-form-label">{{i18n.view.admin.userProfile.userIdReadOnly}}</label>
                                <input type="text" id="userId" name="userId" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                            <div class="jp-form-group">
                                <label for="uuid" class="jp-form-label">{{i18n.view.admin.userProfile.uuidReadOnly}}</label>
                                <input type="text" id="uuid" name="uuid" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                        </div>
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="email" class="jp-form-label">{{i18n.view.admin.userProfile.email}}</label>
                                <input type="email" id="email" name="email" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                        </div>
                        <div class="jp-form-group">
                            <label class="jp-form-label">{{i18n.view.admin.userProfile.roles}}</label>
                            <div id="rolesContainer" class="local-roles-grid">
                                <!-- Roles will be populated dynamically -->
                            </div>
                        </div>
                        <div class="jp-form-group">
                            <label for="status" class="jp-form-label">{{i18n.view.admin.userProfile.status}}</label>
                            <select id="status" name="status" class="jp-form-select" disabled>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </form>
                </div>

                <!-- W-107: Plugin Cards Container (data-driven) - Before profile settings since these are admin config items -->
                <div id="pluginCardsContainer">
                    <!-- Plugin cards will be rendered dynamically based on schema extensions -->
                </div>

                <!-- Profile Information Section -->
                <div class="local-profile-section">
                    <h3>{{i18n.view.admin.userProfile.profileSection}}</h3>
                    <p>{{i18n.view.admin.userProfile.profileSectionDesc}}</p>
                    <form id="profileForm" class="jp-form">
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="firstName" class="jp-form-label">{{i18n.view.admin.userProfile.firstName}}</label>
                                <input type="text" id="firstName" name="firstName" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                            <div class="jp-form-group">
                                <label for="lastName" class="jp-form-label">{{i18n.view.admin.userProfile.lastName}}</label>
                                <input type="text" id="lastName" name="lastName" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                        </div>
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="nickName" class="jp-form-label">{{i18n.view.admin.userProfile.nickName}}</label>
                                <input type="text" id="nickName" name="nickName" class="jp-form-input jp-read-only-field" readonly>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Preferences Section -->
                <div class="local-profile-section">
                    <h3>{{i18n.view.user.profile.preferences}}</h3>
                    <form id="preferencesForm" class="jp-form">
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="language" class="jp-form-label">{{i18n.view.admin.userProfile.language}}</label>
                                <select id="language" name="language" class="jp-form-select" disabled>
                                    <!-- Options will be replaced dynamically -->
                                </select>
                            </div>
                            <div class="jp-form-group">
                                <label for="theme" class="jp-form-label">{{i18n.view.admin.userProfile.theme}}</label>
                                <select id="theme" name="theme" class="jp-form-select" disabled>
                                    <!-- Options will be replaced dynamically -->
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="jp-btn-group">
                    <button id="editBtn" class="jp-btn jp-btn-primary" onclick="toggleEditMode()">{{i18n.view.admin.userProfile.edit}}</button>
                    <button id="saveBtn" class="jp-btn jp-btn-success jp-hidden" onclick="saveUser()">{{i18n.view.admin.userProfile.save}}</button>
                    <button id="cancelBtn" class="jp-btn jp-btn-secondary jp-hidden" onclick="cancelEdit()">{{i18n.view.admin.userProfile.cancel}}</button>
                </div>
            </div>

            <div id="errorState" class="jp-error-box" style="display: none;">
                {{i18n.view.admin.userProfile.failedToLoadUser}}
            </div>
        </div>
      {{else}}
        <div class="jp-error-box">
            {{i18n.view.auth.common.accessDenied}}
        </div>
      {{/if}}
    </div>

    <script>
        {{#if user.isAdmin}}
        let editMode = false;
        let originalValues = {};
        let currentUsername = null;
        let availableRoles = [];
        let schemaMetadata = {};  // W-107: Schema extensions metadata
        let currentUserData = {}; // W-107: Current user data for plugin cards
        let pluginConfig = {};    // W-107: Plugin config from database

        // Warn user when navigating away with unsaved changes
        window.addEventListener('beforeunload', (event) => {
            // Only warn if in edit mode AND there are actual changes
            if (editMode && hasFormChanges()) {
                event.preventDefault();
                // Modern browsers ignore custom messages and show their own generic prompt
                // Setting returnValue to any truthy value triggers the dialog
                event.returnValue = true;
                return true;
            }
        });

        // Get username from query parameter
        function getUsernameFromQuery() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('username');
        }

        jPulse.dom.ready(async () => {
            currentUsername = getUsernameFromQuery();
            if (!currentUsername) {
                jPulse.UI.toast.error(`{{i18n.view.admin.userProfile.failedToLoadUser}}`);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                return;
            }

            await loadRoles();
            await loadStatuses();
            await loadLanguages();
            await loadThemes();
            await loadUser();
        });

        async function loadUser() {
            try {
                showLoading(true);
                // W-107: Request user data with schema extensions metadata
                const result = await jPulse.api.get(`/api/1/user?username=${encodeURIComponent(currentUsername)}&includeSchema=1`);

                if (result.success && result.data) {
                    const user = result.data;
                    currentUserData = user;  // W-107: Store for plugin cards

                    // W-107: Store schema metadata if provided
                    if (result.schema) {
                        schemaMetadata = result.schema;
                    }

                    displayUser(user);

                    // W-107: Render plugin cards based on schema
                    await loadPluginConfig();
                    renderPluginCards();

                    showLoading(false);
                } else {
                    jPulse.UI.toast.error(result.error || `{{i18n.view.admin.userProfile.failedToLoadUser}}`);
                    showLoading(false);
                    document.getElementById('errorState').style.display = 'block';
                }
            } catch (error) {
                jPulse.UI.toast.error(`{{i18n.view.admin.userProfile.networkErrorLoading}}`.replace('%ERROR%', error.message));
                showLoading(false);
                document.getElementById('errorState').style.display = 'block';
            }
        }

        // W-107: Load plugin configuration from database
        // TODO: Implement proper /api/1/plugin/config endpoint in future
        async function loadPluginConfig() {
            // For now, plugin config-based showIf conditions will use empty config
            // This means actions with showIf: { config: '...' } will default to hidden
            pluginConfig = {};
        }

        // W-107: Render plugin cards based on schema extensions
        function renderPluginCards() {
            const container = document.getElementById('pluginCardsContainer');
            container.innerHTML = '';

            if (!schemaMetadata || Object.keys(schemaMetadata).length === 0) {
                return;
            }

            // Sort plugins by order
            const sortedBlocks = Object.entries(schemaMetadata)
                .filter(([key, blockDef]) => blockDef._meta?.adminCard?.visible)
                .sort((a, b) => (a[1]._meta?.adminCard?.order || 999) - (b[1]._meta?.adminCard?.order || 999));

            sortedBlocks.forEach(([blockKey, blockDef]) => {
                const cardConfig = blockDef._meta.adminCard;
                const cardHtml = renderPluginCard(blockKey, blockDef, cardConfig);
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        // W-107: Render a single plugin card
        function renderPluginCard(blockKey, blockDef, cardConfig) {
            const userData = currentUserData[blockKey] || {};
            const bgColor = cardConfig.backgroundColor || '#f8f9fa';
            const icon = cardConfig.icon || 'üì¶';
            const label = cardConfig.label || blockKey;
            const description = cardConfig.description || '';

            // Build action buttons
            const actionsHtml = renderCardActions(blockKey, cardConfig.actions || [], userData);

            // Build fields display
            const fieldsHtml = renderCardFields(blockKey, blockDef, userData);

            return `
                <div class="local-plugin-card" id="card-${blockKey}" style="background-color: ${bgColor}; border-color: ${bgColor === '#f8f9fa' ? 'transparent' : bgColor};">
                    <div class="local-plugin-card-header">
                        <div class="local-plugin-card-title">
                            <span class="local-plugin-icon">${icon}</span>
                            <h3>${label}</h3>
                        </div>
                        <div class="local-plugin-card-actions">
                            ${actionsHtml}
                        </div>
                    </div>
                    ${description ? `<div class="local-plugin-card-description">${description}</div>` : ''}
                    <div class="local-plugin-field-grid">
                        ${fieldsHtml}
                    </div>
                </div>
            `;
        }

        // W-107: Render card action buttons
        function renderCardActions(blockKey, actions, userData) {
            if (!actions || actions.length === 0) return '';

            return actions
                .filter(action => evaluateShowIf(action.showIf, userData, blockKey))
                .map(action => {
                    const style = action.style || 'secondary';
                    const icon = action.icon ? `${action.icon} ` : '';
                    const btnClass = `jp-btn jp-btn-${style} jp-btn-sm`;
                    return `<button class="${btnClass}" onclick="handlePluginAction('${blockKey}', ${JSON.stringify(action).replace(/'/g, "\\'").replace(/"/g, '&quot;')})">${icon}${action.label}</button>`;
                })
                .join('');
        }

        // W-107: Evaluate showIf condition
        function evaluateShowIf(showIf, userData, blockKey) {
            if (!showIf) return true;

            // Simple conditions
            if (showIf === 'always') return true;
            if (showIf === 'hasValue') return false; // For action buttons, default to true if no showIf

            // Field-based condition: { field: 'mfa.enabled', equals: true }
            if (showIf.field) {
                let value = getNestedValue(currentUserData, showIf.field);

                // Apply default from schema if value is undefined
                if (value === undefined) {
                    const parts = showIf.field.split('.');
                    if (parts.length >= 2) {
                        const schemaBlock = schemaMetadata[parts[0]];
                        const fieldDef = schemaBlock?.[parts[1]];
                        if (fieldDef?.default !== undefined) {
                            value = fieldDef.default;
                        }
                    }
                }

                if (showIf.equals !== undefined) {
                    return value === showIf.equals;
                }
                if (showIf.condition === 'exists') {
                    return value !== null && value !== undefined;
                }
                if (showIf.condition === 'gt' && showIf.value !== undefined) {
                    return value > showIf.value;
                }
                return false;
            }

            // Config-based condition: { config: 'auth-mfa.allowUserDisable', equals: true }
            if (showIf.config) {
                const value = getNestedValue(pluginConfig, showIf.config);
                return value === showIf.equals;
            }

            // All condition: { all: [...conditions] }
            if (showIf.all && Array.isArray(showIf.all)) {
                return showIf.all.every(cond => evaluateShowIf(cond, userData, blockKey));
            }

            // Any condition: { any: [...conditions] }
            if (showIf.any && Array.isArray(showIf.any)) {
                return showIf.any.some(cond => evaluateShowIf(cond, userData, blockKey));
            }

            return true;
        }

        // W-107: Get nested value from object using dot notation
        function getNestedValue(obj, path) {
            if (!obj || !path) return undefined;
            return path.split('.').reduce((acc, part) => acc?.[part], obj);
        }

        // W-107: Set nested value in object using dot notation
        function setNestedValue(obj, path, value) {
            const parts = path.split('.');
            const last = parts.pop();
            const target = parts.reduce((acc, part) => {
                if (acc[part] === undefined) acc[part] = {};
                return acc[part];
            }, obj);
            target[last] = value;
        }

        // W-107: Render card fields
        function renderCardFields(blockKey, blockDef, userData) {
            const fields = [];

            for (const [fieldKey, fieldDef] of Object.entries(blockDef)) {
                if (fieldKey === '_meta') continue;
                if (!fieldDef.adminCard?.visible) continue;

                // Get value with fallback to default from schema
                let value = userData[fieldKey];
                if (value === undefined && fieldDef.default !== undefined) {
                    value = fieldDef.default;
                }

                // Check showIf
                const showIf = fieldDef.showIf;
                if (showIf === 'hasValue' && (value === null || value === undefined)) {
                    continue;
                }
                if (typeof showIf === 'object' && !evaluateShowIf(showIf, userData, blockKey)) {
                    continue;
                }

                const label = fieldDef.label || fieldKey;
                const displayValue = formatFieldValue(value, fieldDef);

                fields.push(`
                    <div class="local-plugin-field-label">${label}:</div>
                    <div class="local-plugin-field-value">${displayValue}</div>
                `);
            }

            return fields.join('');
        }

        // W-107: Format field value based on displayAs
        function formatFieldValue(value, fieldDef) {
            const displayAs = fieldDef.displayAs;

            if (value === null || value === undefined) {
                return '<span style="color: #999;">‚Äî</span>';
            }

            switch (displayAs) {
                case 'badge':
                    if (typeof value === 'boolean') {
                        const badgeClass = value ? 'local-plugin-badge-success' : 'local-plugin-badge-danger';
                        const badgeText = value ? '‚úÖ Enabled' : '‚ùå Disabled';
                        return `<span class="local-plugin-badge ${badgeClass}">${badgeText}</span>`;
                    }
                    return `<span class="local-plugin-badge local-plugin-badge-info">${value}</span>`;

                case 'date':
                    if (!value) return '<span style="color: #999;">‚Äî</span>';
                    return new Date(value).toLocaleDateString();

                case 'datetime':
                    if (!value) return '<span style="color: #999;">‚Äî</span>';
                    return new Date(value).toLocaleString();

                case 'count':
                    if (Array.isArray(value)) {
                        return `${value.length} remaining`;
                    }
                    return String(value);

                default:
                    if (typeof value === 'boolean') {
                        return value ? 'Yes' : 'No';
                    }
                    if (Array.isArray(value)) {
                        return value.join(', ');
                    }
                    return String(value);
            }
        }

        // W-107: Handle plugin action button click
        async function handlePluginAction(blockKey, action) {
            // Parse action if it's a string (from HTML attribute)
            if (typeof action === 'string') {
                action = JSON.parse(action.replace(/&quot;/g, '"'));
            }

            // Show confirmation dialog if required
            if (action.confirm) {
                const result = await jPulse.UI.confirmDialog({
                    title: action.label,
                    message: action.confirm,
                    buttons: ['Cancel', 'Continue']
                });
                if (result.button !== 'Continue') return;
            }

            // Handle different action types
            if (action.setFields) {
                // Enter edit mode FIRST to capture original values before modification
                if (!editMode) {
                    toggleEditMode();
                }

                // Apply setFields to currentUserData (local modification)
                for (const [path, value] of Object.entries(action.setFields)) {
                    setNestedValue(currentUserData, path, value);
                }

                // Re-render the card
                renderPluginCards();

                // Show toast
                if (action.toast) {
                    jPulse.UI.toast.info(action.toast);
                }
            } else if (action.navigate) {
                // Check for unsaved changes
                if (editMode) {
                    const result = await jPulse.UI.confirmDialog({
                        title: `{{i18n.view.admin.userProfile.unsavedChangesTitle}}`,
                        message: `{{i18n.view.admin.userProfile.unsavedChangesMessage}}`,
                        buttons: [`{{i18n.view.admin.userProfile.cancel}}`, `{{i18n.view.admin.userProfile.saveAndContinue}}`]
                    });
                    if (result.button === `{{i18n.view.admin.userProfile.cancel}}`) return;
                    await saveUser();
                }
                window.location.href = action.navigate;
            } else if (action.handler) {
                // Call registered handler
                const handler = window.jPulse?.schemaHandlers?.[action.handler];
                if (handler) {
                    const result = await handler(currentUserData, action);
                    if (result?.refresh) {
                        await loadUser();
                    }
                } else {
                    console.error(`- jPulse: Handler not found: ${action.handler}`);
                    jPulse.UI.toast.error(`Handler not available: ${action.handler}`);
                }
            }
        }

        function displayUser(user) {
            // Update header
            const initials = (user.profile?.firstName?.[0] || '') + (user.profile?.lastName?.[0] || '') || '?';
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('userName').textContent = `${user.profile?.firstName || ''} ${user.profile?.lastName || ''}`.trim() || '-';
            document.getElementById('userDetails').textContent = `@${user.username || ''} ‚Ä¢ ${user.email || ''}`;

            const statusBadge = document.getElementById('userStatusBadge');
            if (user.status) {
                statusBadge.textContent = user.status.charAt(0).toUpperCase() + user.status.slice(1);
                statusBadge.className = `jp-status-badge jp-status-${user.status}`;
            }

            // Update admin fields
            document.getElementById('userId').value = user._id ? (typeof user._id === 'object' ? user._id.toString() : user._id) : '';
            document.getElementById('uuid').value = user.uuid || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('status').value = user.status || 'active';

            // Update roles checkboxes
            updateRolesCheckboxes(user.roles || []);

            // Update profile fields
            document.getElementById('firstName').value = user.profile?.firstName || '';
            document.getElementById('lastName').value = user.profile?.lastName || '';
            document.getElementById('nickName').value = user.profile?.nickName || '';

            // Update preferences
            document.getElementById('language').value = user.preferences?.language || 'en';
            document.getElementById('theme').value = user.preferences?.theme || 'light';

            // Show user content
            document.getElementById('userContent').style.display = 'block';
        }

        function updateRolesCheckboxes(userRoles) {
            const container = document.getElementById('rolesContainer');
            container.innerHTML = '';

            availableRoles.forEach(role => {
                const isChecked = userRoles.includes(role);
                const checkbox = document.createElement('div');
                checkbox.className = 'local-role-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="role_${role}" value="${role}" ${isChecked ? 'checked' : ''} disabled>
                    <label for="role_${role}">${role}</label>
                `;
                container.appendChild(checkbox);
            });
        }

        async function loadRoles() {
            try {
                const response = await jPulse.api.get('/api/1/user/enums?fields=roles');
                if (response.success && response.data && response.data.roles && Array.isArray(response.data.roles)) {
                    availableRoles = response.data.roles;
                }
            } catch (error) {
                console.error('- jPulse: Failed to load roles:', error);
            }
        }

        async function loadStatuses() {
            try {
                const response = await jPulse.api.get('/api/1/user/enums?fields=status');
                if (response.success && response.data && response.data.status) {
                    const statusSelect = document.getElementById('status');
                    const currentValue = statusSelect.value;
                    statusSelect.innerHTML = '';

                    const statuses = response.data.status;
                    if (Array.isArray(statuses)) {
                        statuses.forEach(status => {
                            const option = document.createElement('option');
                            option.value = status;
                            option.textContent = status;
                            statusSelect.appendChild(option);
                        });
                    }

                    // Restore selection if it was set
                    if (currentValue) {
                        statusSelect.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('- jPulse: Failed to load statuses:', error);
            }
        }

        async function loadLanguages() {
            try {
                const response = await jPulse.api.get('/api/1/auth/languages');
                if (response.success) {
                    const languageSelect = document.getElementById('language');
                    const currentValue = languageSelect.value;
                    languageSelect.innerHTML = '';

                    const languages = response.data;
                    if (Array.isArray(languages)) {
                        languages.forEach(([code, name]) => {
                            const option = document.createElement('option');
                            option.value = code;
                            option.textContent = name;
                            languageSelect.appendChild(option);
                        });
                    }

                    languageSelect.value = currentValue;
                }
            } catch (error) {
                console.error('- jPulse: Failed to load languages:', error);
            }
        }

        async function loadThemes() {
            try {
                const response = await jPulse.api.get('/api/1/user/enums?fields=preferences.theme');
                if (response.success && response.data && response.data['preferences.theme']) {
                    const themeSelect = document.getElementById('theme');
                    const currentValue = themeSelect.value;
                    themeSelect.innerHTML = '';

                    const themes = response.data['preferences.theme'];
                    if (Array.isArray(themes)) {
                        themes.forEach(theme => {
                            const option = document.createElement('option');
                            option.value = theme;
                            option.textContent = theme;
                            themeSelect.appendChild(option);
                        });
                    }

                    themeSelect.value = currentValue;
                }
            } catch (error) {
                console.error('- jPulse: Failed to load themes:', error);
            }
        }

        function toggleEditMode() {
            editMode = !editMode;
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            if (editMode) {
                // Store original values at edit start (deep copy for comparison)
                originalValues = JSON.parse(JSON.stringify(getCurrentFormValues()));

                // Enable editing for admin fields
                document.getElementById('email').readOnly = false;
                document.getElementById('email').classList.remove('jp-read-only-field');
                document.getElementById('status').disabled = false;

                // Enable role checkboxes
                availableRoles.forEach(role => {
                    const checkbox = document.getElementById(`role_${role}`);
                    if (checkbox) checkbox.disabled = false;
                });

                // Enable editing for profile fields
                ['firstName', 'lastName', 'nickName'].forEach(id => {
                    const field = document.getElementById(id);
                    field.readOnly = false;
                    field.classList.remove('jp-read-only-field');
                });

                // Enable editing for preference fields
                ['language', 'theme'].forEach(id => {
                    const field = document.getElementById(id);
                    field.disabled = false;
                });

                // Update buttons
                jPulse.dom.hide(editBtn);
                jPulse.dom.show(saveBtn);
                jPulse.dom.show(cancelBtn);
            } else {
                cancelEdit();
            }
        }

        function getSelectedRoles() {
            const roles = [];
            availableRoles.forEach(role => {
                const checkbox = document.getElementById(`role_${role}`);
                if (checkbox && checkbox.checked) {
                    roles.push(role);
                }
            });
            return roles;
        }

        // Get current form values as an object (for comparison)
        function getCurrentFormValues() {
            const values = {
                email: document.getElementById('email').value,
                status: document.getElementById('status').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                nickName: document.getElementById('nickName').value,
                language: document.getElementById('language').value,
                theme: document.getElementById('theme').value,
                roles: getSelectedRoles()
            };
            // Include plugin data
            for (const key of Object.keys(schemaMetadata)) {
                if (currentUserData[key] !== undefined) {
                    values[key] = currentUserData[key];
                }
            }
            return values;
        }

        function hasFormChanges() {
            return !jPulse.utils.deepEqual(getCurrentFormValues(), originalValues);
        }

        async function cancelEdit() {
            // Check if form has actual changes (only show dialog if there are changes)
            if (editMode && hasFormChanges()) {
                const result = await jPulse.UI.confirmDialog({
                    title: `{{i18n.view.admin.userProfile.discardChangesTitle}}`,
                    message: `{{i18n.view.admin.userProfile.discardChangesMessage}}`,
                    buttons: [`{{i18n.view.admin.userProfile.backToEdit}}`, `{{i18n.view.admin.userProfile.discardChanges}}`]
                });
                if (result.button === `{{i18n.view.admin.userProfile.backToEdit}}`) {
                    return;
                }
            }

            editMode = false;

            // Restore original values
            if (originalValues.email !== undefined) {
                document.getElementById('email').value = originalValues.email;
                document.getElementById('status').value = originalValues.status;
                document.getElementById('firstName').value = originalValues.firstName;
                document.getElementById('lastName').value = originalValues.lastName;
                document.getElementById('nickName').value = originalValues.nickName;
                document.getElementById('language').value = originalValues.language;
                document.getElementById('theme').value = originalValues.theme;

                // Restore roles
                if (originalValues.roles) {
                    availableRoles.forEach(role => {
                        const checkbox = document.getElementById(`role_${role}`);
                        if (checkbox) {
                            checkbox.checked = originalValues.roles.includes(role);
                        }
                    });
                }
            }

            // Disable editing for admin fields
            document.getElementById('email').readOnly = true;
            document.getElementById('email').classList.add('jp-read-only-field');
            document.getElementById('status').disabled = true;

            // Disable role checkboxes
            availableRoles.forEach(role => {
                const checkbox = document.getElementById(`role_${role}`);
                if (checkbox) checkbox.disabled = true;
            });

            // Disable editing for profile fields
            ['firstName', 'lastName', 'nickName'].forEach(id => {
                const field = document.getElementById(id);
                field.readOnly = true;
                field.classList.add('jp-read-only-field');
            });

            // Disable editing for preference fields
            ['language', 'theme'].forEach(id => {
                const field = document.getElementById(id);
                field.disabled = true;
            });

            // Update buttons
            jPulse.dom.show(document.getElementById('editBtn'));
            jPulse.dom.hide(document.getElementById('saveBtn'));
            jPulse.dom.hide(document.getElementById('cancelBtn'));
        }

        async function saveUser() {
            try {
                // Prepare update data
                const updateData = {
                    email: document.getElementById('email').value,
                    status: document.getElementById('status').value,
                    roles: getSelectedRoles(),
                    profile: {
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        nickName: document.getElementById('nickName').value
                    },
                    preferences: {
                        language: document.getElementById('language').value,
                        theme: document.getElementById('theme').value
                    }
                };

                // W-107: Include plugin data from schema extensions
                for (const blockKey of Object.keys(schemaMetadata)) {
                    if (currentUserData[blockKey] !== undefined) {
                        updateData[blockKey] = currentUserData[blockKey];
                    }
                }

                const result = await jPulse.api.put(`/api/1/user?username=${encodeURIComponent(currentUsername)}`, updateData);

                if (result.success) {
                    jPulse.UI.toast.success(`{{i18n.view.admin.userProfile.userUpdatedSuccess}}`);
                    editMode = false;
                    cancelEdit();
                    await loadUser();
                } else {
                    jPulse.UI.toast.error(result.error || `{{i18n.view.admin.userProfile.failedToUpdateUser}}`);
                }
            } catch (error) {
                jPulse.UI.toast.error(`{{i18n.view.admin.userProfile.networkError}}`.replace('%ERROR%', error.message));
            }
        }

        function showLoading(show) {
            const loadingState = document.getElementById('loadingState');
            const userContent = document.getElementById('userContent');
            const errorState = document.getElementById('errorState');

            if (show) {
                loadingState.style.display = 'block';
                userContent.style.display = 'none';
                errorState.style.display = 'none';
            } else {
                loadingState.style.display = 'none';
            }
        }
        {{/if}}
    </script>

    {{file.include "jpulse-footer.tmpl"}}
</body>
</html>
