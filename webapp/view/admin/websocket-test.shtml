<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / Admin / WebSocket Test
 * @tagline         WebSocket testing and development tool
 * @description     Interactive test page for jPulse.ws.* client utilities
 * @file            webapp/view/admin/websocket-test.shtml
 * @version         1.0.3
 * @release         2025-11-02
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 1.7, Claude Sonnet 4
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test Tool - {{app.site.shortName}}</title>
    {{file.include "jpulse-header.tmpl"}}
    <style>
        .local-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .local-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.875rem;
        }
        .local-log-item {
            padding: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }
        .local-log-item:last-child {
            border-bottom: none;
        }
        .local-log-timestamp {
            color: #666;
            margin-right: 0.5rem;
        }
        .local-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .local-status.connected {
            background: #d4edda;
            color: #155724;
        }
        .local-status.connecting {
            background: #fff3cd;
            color: #856404;
        }
        .local-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .local-input {
            flex: 1;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="jp-main">
        <div class="jp-container-1200">
            <div class="jp-page-header">
                <h1>{{i18n.view.admin.websocketTest.title}}</h1>
                <span class="jp-subtitle">{{i18n.view.admin.websocketTest.subtitle}}</span>
            </div>

            <div class="jp-dashboard-grid">
                <!-- Connection Controls -->
                <div class="jp-card">
                    <h2 class="jp-card-dialog-heading">{{i18n.view.admin.websocketTest.connectionControls}}</h2>
                    <div class="local-controls">
                        <button id="btnConnect" class="jp-btn jp-btn-primary">{{i18n.view.admin.websocketTest.connect}}</button>
                        <button id="btnDisconnect" class="jp-btn jp-btn-secondary" disabled>{{i18n.view.admin.websocketTest.disconnect}}</button>
                    </div>
                </div>

                <!-- Connection Status -->
                <div class="jp-card">
                    <h2 class="jp-card-dialog-heading">{{i18n.view.admin.websocketTest.connectionStatus}}</h2>
                    <p>{{i18n.view.admin.websocketTest.status}}: <span id="connectionStatus" class="local-status disconnected">{{i18n.view.admin.websocketStatus.disconnected}}</span></p>
                    <p>{{i18n.view.admin.websocketTest.username}}: <code>{{user.username}}</code></p>
                    <p>{{i18n.view.admin.websocketTest.namespace}}: <code>/api/1/ws/jpulse-ws-test</code></p>
                    <p>{{i18n.view.admin.websocketTest.clientUuid}}: <code id="clientUuid">-</code></p>
                </div>
            </div>

            <!-- Send Custom Message -->
            <div class="jp-card">
                <h2 class="jp-card-dialog-heading">{{i18n.view.admin.websocketTest.sendCustom}}</h2>
                <div class="jp-card-subheading">{{i18n.view.admin.websocketTest.sendCustomDesc}}</div>
                <div class="local-controls">
                    <input type="text" id="customMessage" class="jp-form-input local-input" placeholder="{{i18n.view.admin.websocketTest.customPlaceholder}}">
                    <button id="btnSendCustom" class="jp-btn jp-btn-primary" disabled>{{i18n.view.admin.websocketTest.sendMessage}}</button>
                </div>
            </div>

            <!-- Send Test Message by Type -->
            <div class="jp-card">
                <h2 class="jp-card-dialog-heading">{{i18n.view.admin.websocketTest.sendTestType}}</h2>
                <div class="jp-card-subheading">{{i18n.view.admin.websocketTest.sendTestTypeDesc}}</div>
                <div class="local-controls">
                    <button id="btnSendInfo" class="jp-btn jp-btn-secondary" disabled>{{i18n.view.admin.websocketTest.infoMessage}}</button>
                    <button id="btnSendSuccess" class="jp-btn jp-btn-secondary" disabled>{{i18n.view.admin.websocketTest.successMessage}}</button>
                    <button id="btnSendWarning" class="jp-btn jp-btn-secondary" disabled>{{i18n.view.admin.websocketTest.warningMessage}}</button>
                    <button id="btnSendError" class="jp-btn jp-btn-secondary" disabled>{{i18n.view.admin.websocketTest.errorMessage}}</button>
                </div>
            </div>

            <!-- Message Log -->
            <div class="jp-card">
                <h2 class="jp-card-dialog-heading">{{i18n.view.admin.websocketTest.messageLog}}</h2>
                <div id="messageLog" class="local-log">
                    <div class="local-log-item">
                        <span class="local-log-timestamp">--:--:--</span>
                        <span>Ready to connect...</span>
                    </div>
                </div>
                <button id="btnClearLog" class="jp-btn jp-btn-secondary" style="margin-top: 1rem;">{{i18n.view.admin.websocketTest.clearLog}}</button>
            </div>

            <!-- Instructions -->
            <div class="jp-card">
                <h2 class="jp-card-dialog-heading">{{i18n.view.admin.websocketTest.instructions}}</h2>
                <ol>
                    <li>Click <strong>Connect</strong> to establish WebSocket connection</li>
                    <li>Send test messages using the buttons above</li>
                    <li>Open <a href="/admin/websocket-status.shtml" target="_blank">WebSocket Status</a> in another tab to see real-time activity log</li>
                    <li>Messages will appear in both the activity log and this test page</li>
                    <li>Try different message types to see color coding in action:
                        <ul>
                            <li><strong>Info</strong> → Blue border in activity log</li>
                            <li><strong>Success</strong> → Green border (messages containing "connect")</li>
                            <li><strong>Warning</strong> → Orange border (messages containing "warning")</li>
                            <li><strong>Error</strong> → Red border (messages containing "error")</li>
                        </ul>
                    </li>
                </ol>
                <p><strong>{{i18n.view.admin.websocketTest.note}}:</strong> {{{i18n.view.admin.websocketTest.noteText}}}</p>
            </div>
        </div>
    </div>

    {{#if file.exists "jpulse-footer.tmpl"}}
        {{file.include "jpulse-footer.tmpl"}}
    {{/if}}

    <script>
    (function() {
        let wsConnection = null;
        let messageCount = 0;

        // Current user
        const currentUsername = '{{user.username}}';

        // i18n strings
        const i18n = {
            connecting: '{{i18n.view.admin.websocketStatus.connecting}}',
            connected: '{{i18n.view.admin.websocketStatus.connected}}',
            reconnecting: '{{i18n.view.admin.websocketStatus.reconnecting}}',
            disconnected: '{{i18n.view.admin.websocketStatus.disconnected}}'
        };

        // DOM elements
        const statusEl = document.getElementById('connectionStatus');
        const uuidEl = document.getElementById('clientUuid');
        const logEl = document.getElementById('messageLog');
        const customMessageInput = document.getElementById('customMessage');

        const btnConnect = document.getElementById('btnConnect');
        const btnDisconnect = document.getElementById('btnDisconnect');
        const btnSendCustom = document.getElementById('btnSendCustom');
        const btnSendInfo = document.getElementById('btnSendInfo');
        const btnSendSuccess = document.getElementById('btnSendSuccess');
        const btnSendWarning = document.getElementById('btnSendWarning');
        const btnSendError = document.getElementById('btnSendError');
        const btnClearLog = document.getElementById('btnClearLog');

        // Helper: Truncate long messages (75 chars ... 75 chars)
        function truncateMessage(message) {
            const maxLength = 150;
            if (message.length <= maxLength) {
                return message;
            }
            const firstPart = message.substring(0, 75);
            const lastPart = message.substring(message.length - 75);
            return `${firstPart} ... ${lastPart}`;
        }

        // Helper: Add log entry
        function addLog(message, isReceived = false) {
            const timestamp = new Date().toLocaleTimeString();
            const direction = isReceived ? '← Received' : '→ Sent';
            const messageStr = JSON.stringify(message);
            const truncatedMessage = truncateMessage(messageStr);
            const logItem = document.createElement('div');
            logItem.className = 'local-log-item';
            logItem.innerHTML = `
                <span class="local-log-timestamp">${timestamp}</span>
                <strong>${direction}:</strong> ${truncatedMessage}
            `;
            logEl.appendChild(logItem);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Helper: Update connection status
        function updateStatus(status) {
            statusEl.textContent = i18n[status] || status;
            statusEl.className = `local-status ${status}`;

            const connected = status === 'connected';
            btnConnect.disabled = connected;
            btnDisconnect.disabled = !connected;
            btnSendCustom.disabled = !connected;
            btnSendInfo.disabled = !connected;
            btnSendSuccess.disabled = !connected;
            btnSendWarning.disabled = !connected;
            btnSendError.disabled = !connected;
        }

        // Connect to WebSocket
        btnConnect.addEventListener('click', () => {
            addLog({ action: 'Connecting to /api/1/ws/jpulse-ws-test...' });

            wsConnection = jPulse.ws.connect('/api/1/ws/jpulse-ws-test');

            // Show client UUID
            const uuid = localStorage.getItem('jPulse.ws.clientUUID');
            uuidEl.textContent = uuid;

            // Handle status changes
            wsConnection.onStatusChange((status) => {
                updateStatus(status);
                addLog({ status: status });

                // Send initial connected message
                if (status === 'connected') {
                    wsConnection.send({
                        type: 'test-connected',
                        message: 'Test page connected successfully',
                        username: '{{user.username}}',
                        timestamp: new Date().toISOString()
                    });
                }
            });

            // Handle incoming messages
            wsConnection.onMessage((data, message) => {
                addLog(data, true);
            });
        });

        // Disconnect
        btnDisconnect.addEventListener('click', () => {
            if (wsConnection) {
                addLog({ action: 'Disconnecting...' });
                wsConnection.disconnect();
                wsConnection = null;
                updateStatus('disconnected');
            }
        });

        // Send custom message
        btnSendCustom.addEventListener('click', () => {
            const message = customMessageInput.value.trim();
            if (message && wsConnection) {
                try {
                    wsConnection.send({
                        type: 'custom',
                        message: message,
                        username: currentUsername,
                        timestamp: new Date().toISOString(),
                        count: ++messageCount
                    });
                    addLog({ type: 'custom', message: message });
                    customMessageInput.value = '';
                    jPulse.UI.toast.show('Message sent successfully', 'success');
                } catch (error) {
                    jPulse.UI.toast.show('Failed to send message: ' + error.message, 'error');
                }
            } else if (!message) {
                jPulse.UI.toast.show('Please enter a message', 'error');
            } else {
                jPulse.UI.toast.show('Not connected to WebSocket', 'error');
            }
        });

        customMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !btnSendCustom.disabled) {
                btnSendCustom.click();
            }
        });

        // Send test messages
        btnSendInfo.addEventListener('click', () => {
            try {
                const msg = {
                    type: 'info',
                    message: 'This is an informational message',
                    username: currentUsername,
                    timestamp: new Date().toISOString(),
                    count: ++messageCount
                };
                wsConnection.send(msg);
                addLog(msg);
                jPulse.UI.toast.show('Info message sent', 'success');
            } catch (error) {
                jPulse.UI.toast.show('Failed to send message', 'error');
            }
        });

        btnSendSuccess.addEventListener('click', () => {
            try {
                const msg = {
                    type: 'success',
                    message: 'Connection established successfully',
                    username: currentUsername,
                    timestamp: new Date().toISOString(),
                    count: ++messageCount
                };
                wsConnection.send(msg);
                addLog(msg);
                jPulse.UI.toast.show('Success message sent', 'success');
            } catch (error) {
                jPulse.UI.toast.show('Failed to send message', 'error');
            }
        });

        btnSendWarning.addEventListener('click', () => {
            try {
                const msg = {
                    type: 'warning',
                    message: 'This is a warning message - reconnecting...',
                    username: currentUsername,
                    timestamp: new Date().toISOString(),
                    count: ++messageCount
                };
                wsConnection.send(msg);
                addLog(msg);
                jPulse.UI.toast.show('Warning message sent', 'success');
            } catch (error) {
                jPulse.UI.toast.show('Failed to send message', 'error');
            }
        });

        btnSendError.addEventListener('click', () => {
            try {
                const msg = {
                    type: 'error',
                    message: 'Error: Connection failed',
                    username: currentUsername,
                    timestamp: new Date().toISOString(),
                    count: ++messageCount
                };
                wsConnection.send(msg);
                addLog(msg);
                jPulse.UI.toast.show('Error message sent', 'success');
            } catch (error) {
                jPulse.UI.toast.show('Failed to send message', 'error');
            }
        });

        // Clear log
        btnClearLog.addEventListener('click', () => {
            logEl.innerHTML = '<div class="local-log-item"><span class="local-log-timestamp">--:--:--</span><span>Log cleared</span></div>';
        });

        // Initialize
        updateStatus('disconnected');
    })();
    </script>
</body>
</html>
