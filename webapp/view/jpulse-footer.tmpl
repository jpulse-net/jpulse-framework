<!-- Start webapp/view/jpulse-footer.tmpl -->
<!--
 * @name            jPulse Framework / WebApp / View / Footer Template
 * @tagline         Footer template for jPulse pages
 * @description     Footer included in all jPulse pages to provide a consistent page layout
 * @file            webapp/view/jpulse-footer.tmpl
 * @version         1.4.8
 * @release         2026-01-08
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 2.2, Claude Sonnet 4.5
-->
<!-- Visual Header Banner (positioned at top via CSS) -->
<header class="jp-header">
    <div class="jp-header-content">
        <!-- Mobile Hamburger Menu Icon (W-069) -->
        {{#if appConfig.view.pageDecoration.siteNavigation.enabled}}
        <button class="jp-hamburger" id="jp-hamburger" aria-label="{{i18n.view.pageDecoration.sidebar.menu}}" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
        </button>
        {{/if}}
        <a href="/" class="jp-logo">
            <img src="/images/jpulse-logo/jpulse-logo-reverse.svg" alt="jPulse" height="22" width="22">
            <span class="jp-logo-name">{{app.site.name}}</span>
            <span class="jp-logo-shortname">{{app.site.shortName}}</span>
        </a>
        <div class="jp-user-menu">
            <div class="jp-user-icon" id="jp-user-icon">
              {{#if user.isAuthenticated}}
                <span>{{user.initials}}</span>
              {{else}}
                <span>ðŸ‘¤</span>
              {{/if}}
            </div>
            <div class="jp-dropdown" id="userDropdown">
              {{#if user.isAuthenticated}}
                <a href="/user/">{{i18n.view.user.index.dashboard}}</a>
                <a href="/user/profile.shtml">{{i18n.view.auth.common.profile}}</a>
                <a href="/auth/logout.shtml">{{i18n.view.auth.common.signout}}</a>
              {{else}}
                {{#unless appConfig.view.auth.hideLogin}}
                <a href="/auth/login.shtml">{{i18n.view.auth.common.signin}}</a>
                {{/unless}}
                {{#unless appConfig.view.auth.hideSignup}}
                <a href="/auth/signup.shtml">{{i18n.view.auth.common.signup}}</a>
                {{/unless}}
              {{/if}}
              {{#if user.isAdmin}}
                <a href="/admin/">{{i18n.view.user.index.adminDashboard}}</a>
              {{/if}}
            </div>
        </div>
    </div>
</header>

<!-- Mobile Menu Overlay (W-069) -->
{{#if appConfig.view.pageDecoration.siteNavigation.enabled}}
<div class="jp-mobile-menu-overlay" id="jp-mobile-menu-overlay"></div>
<nav class="jp-mobile-menu" id="jp-mobile-menu" aria-label="{{i18n.view.pageDecoration.sidebar.mobileNavigation}}"></nav>
{{/if}}

<!-- Left Sidebar (W-068) -->
{{#if appConfig.view.pageDecoration.sidebar.left.enabled}}
<aside id="jp-sidebar-left" class="jp-sidebar jp-sidebar-left jp-sidebar-mode-{{appConfig.view.pageDecoration.sidebar.left.mode}} jp-sidebar-{{appConfig.view.pageDecoration.sidebar.left.behavior}}" data-sidebar="left">
    <div class="jp-sidebar-content">
        <div class="jp-sidebar-content-scroll">
            {{#each appConfig.view.pageDecoration.sidebar.left.components}}
                {{components name=(this)}}
            {{/each}}
            <div class="jp-sidebar-empty" id="jp-sidebar-empty-left" style="display: none;">
                {{i18n.view.pageDecoration.sidebar.empty}}
            </div>
        </div>
    </div>
    {{!-- Mobile close button (inside sidebar) --}}
    <button class="jp-sidebar-toggle jp-sidebar-toggle-close" id="jp-sidebar-toggle-close-left" aria-label="{{i18n.view.pageDecoration.sidebar.closeLeftSidebar}}" style="display:none;">â—„</button>
</aside>
<div id="jp-sidebar-separator-left" class="jp-sidebar-separator jp-sidebar-separator-left" data-sidebar="left">
    <button class="jp-sidebar-toggle jp-sidebar-toggle-left" aria-label="{{i18n.view.pageDecoration.sidebar.toggleLeftSidebar}}" title="{{i18n.view.pageDecoration.sidebar.toggleSidebar}}"></button>
</div>
{{/if}}

<!-- Right Sidebar (W-068) -->
{{#if appConfig.view.pageDecoration.sidebar.right.enabled}}
<aside id="jp-sidebar-right" class="jp-sidebar jp-sidebar-right jp-sidebar-mode-{{appConfig.view.pageDecoration.sidebar.right.mode}} jp-sidebar-{{appConfig.view.pageDecoration.sidebar.right.behavior}}" data-sidebar="right">
    <div class="jp-sidebar-content">
        <div class="jp-sidebar-content-scroll">
            {{#each appConfig.view.pageDecoration.sidebar.right.components}}
                {{components name=(this)}}
            {{/each}}
            <div class="jp-sidebar-empty" id="jp-sidebar-empty-right" style="display: none;">
                {{i18n.view.pageDecoration.sidebar.empty}}
            </div>
        </div>
    </div>
    {{!-- Mobile close button (inside sidebar) --}}
    <button class="jp-sidebar-toggle jp-sidebar-toggle-close" id="jp-sidebar-toggle-close-right" aria-label="{{i18n.view.pageDecoration.sidebar.closeRightSidebar}}" style="display:none;">â–º</button>
</aside>
<div id="jp-sidebar-separator-right" class="jp-sidebar-separator jp-sidebar-separator-right" data-sidebar="right">
    <button class="jp-sidebar-toggle jp-sidebar-toggle-right" aria-label="{{i18n.view.pageDecoration.sidebar.toggleRightSidebar}}" title="{{i18n.view.pageDecoration.sidebar.toggleSidebar}}"></button>
</div>
{{/if}}

{{!-- Mobile backdrop overlay (hidden by default, shown by JavaScript when sidebar opens on mobile) --}}
<div class="jp-sidebar-backdrop" id="jp-sidebar-backdrop"></div>

<!-- Footer -->
<footer class="jp-footer">
    <div class="jp-footer-content">
        <div class="jp-footer-left">
            <span>{{app.site.copyright}}</span>
        </div>
        <div class="jp-footer-right">
            <span class="jp-version"><a href="https://jpulse.net/" target="_blank">Powered by jPulse Framework {{app.jPulse.version}}</a></span>
        </div>
    </div>
</footer>

<!-- Site Navigation Initialization (W-069, W-098) -->
<style>
{{#if appConfig.view.pageDecoration.siteNavigation.enabled}}
:root {
    --jp-header-height: {{appConfig.view.pageDecoration.headerHeight}}px;
}
{{/if}}
</style>
<script>
jPulse.dom.ready(() => {
    // Move sidebar elements into .jp-main on DOM ready to avoid initial layout flash
    const main = document.querySelector('.jp-main');
    if (main) {
        let frag;
        {{#if appConfig.view.pageDecoration.sidebar.left.enabled}}
        frag = document.createDocumentFragment();
        [ 'jp-sidebar-left', 'jp-sidebar-separator-left' ].forEach(id => {
            const el = document.getElementById(id);
            if (el) frag.appendChild(el);
        });
        if (frag.childNodes.length) {
            main.insertBefore(frag, main.firstChild);
        }
        {{/if}}
        {{#if appConfig.view.pageDecoration.sidebar.right.enabled}}
        frag = document.createDocumentFragment();
        [ 'jp-sidebar-right', 'jp-sidebar-separator-right' ].forEach(id => {
            const el = document.getElementById(id);
            if (el) frag.appendChild(el);
        });
        if (frag.childNodes.length) {
            main.insertBefore(frag, main.firstChild);
        }
        {{/if}}
    }

    {{#if appConfig.view.pageDecoration.siteNavigation.enabled}}
    // Initialize site navigation when DOM is ready
    // Note: Handlebars values are strings, so convert to numbers
    jPulse.UI.navigation.init({
        currentUrl: `{{url.pathname}}`,
        userRoles: {{user.roles}},
        navigation: window.jPulseNavigation.site,
        openDelay: parseInt(`{{appConfig.view.pageDecoration.siteNavigation.openDelay}}`, 10),
        closeDelay: parseInt(`{{appConfig.view.pageDecoration.siteNavigation.closeDelay}}`, 10),
        submenuCloseDelay: parseInt(`{{appConfig.view.pageDecoration.siteNavigation.submenuCloseDelay}}`, 10)
    });
    {{/if}}
    {{#if appConfig.view.pageDecoration.breadcrumbs.enabled}}
    // Initialize breadcrumbs when DOM is ready
    jPulse.UI.breadcrumbs.init({
        currentUrl: `{{url.pathname}}`,
        navigation: window.jPulseNavigation.site,
        homeLabel: `{{i18n.view.home.title}}`
    });
    {{/if}}

    // Enhanced user menu - hover behavior like site navigation with mobile fallback
    const userIcon = document.getElementById('jp-user-icon');
    const dropdown = document.getElementById('userDropdown');
    const userMenu = document.querySelector('.jp-user-menu');

    if (userIcon && dropdown && userMenu) {
        let hideTimeout = null;
        const isMobileDevice = jPulse.device.isMobile() || jPulse.device.isTouchDevice();

        if (isMobileDevice) {
            // Mobile: tap to toggle behavior ONLY
            userIcon.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
                dropdown.classList.toggle('show');
            });

            // Close on outside tap
            document.addEventListener('click', (event) => {
                if (!userMenu.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Close on menu item selection
            dropdown.addEventListener('click', (event) => {
                if (event.target.tagName === 'A') {
                    dropdown.classList.remove('show');
                }
            });

            // Prevent mouse events from interfering on mobile
            userIcon.addEventListener('mouseenter', (e) => e.preventDefault());
            userIcon.addEventListener('mouseleave', (e) => e.preventDefault());
            dropdown.addEventListener('mouseenter', (e) => e.preventDefault());
            dropdown.addEventListener('mouseleave', (e) => e.preventDefault());

        } else {
            // Desktop: hover behavior like site navigation ONLY
            userIcon.addEventListener('mouseenter', () => {
                if (hideTimeout) {
                    clearTimeout(hideTimeout);
                    hideTimeout = null;
                }
                dropdown.classList.add('show');
            });

            userIcon.addEventListener('mouseleave', (e) => {
                if (!dropdown.contains(e.relatedTarget)) {
                    hideTimeout = setTimeout(() => {
                        dropdown.classList.remove('show');
                        hideTimeout = null;
                    }, 600); // Match site menu delay
                }
            });

            dropdown.addEventListener('mouseenter', () => {
                if (hideTimeout) {
                    clearTimeout(hideTimeout);
                    hideTimeout = null;
                }
                dropdown.classList.add('show');
            });

            dropdown.addEventListener('mouseleave', () => {
                hideTimeout = setTimeout(() => {
                    dropdown.classList.remove('show');
                    hideTimeout = null;
                }, 500); // Slightly shorter delay for dropdown
            });

            // Prevent click events from interfering on desktop hover
            userIcon.addEventListener('click', (e) => e.preventDefault());
        }
    }

    // W-118: Initialize heading anchors on page load
    const initHeadingAnchors = () => {
        if (jPulse.UI?.headingAnchors) {
            jPulse.UI.headingAnchors.init({{appConfig.view.jPulse.UI.headingAnchors}});
            return true;
        }
        return false;
    };

    // Try to initialize immediately
    if (!initHeadingAnchors()) {
        // If not available yet, wait a bit and try again
        let retries = 0;
        const maxRetries = 10;
        const checkInterval = setInterval(() => {
            retries++;
            if (initHeadingAnchors() || retries >= maxRetries) {
                clearInterval(checkInterval);
            }
        }, 50);
    }

    // Also initialize on window load (in case content loads after DOMContentLoaded)
    window.addEventListener('load', () => {
        initHeadingAnchors();
    });

    // W-118: Re-initialize after SPA navigation (for markdown docs and dynamic content)
    window.addEventListener('popstate', () => {
        if (jPulse.UI?.headingAnchors) {
            // Small delay to let content render
            setTimeout(() => {
                jPulse.UI.headingAnchors.init({{appConfig.view.jPulse.UI.headingAnchors}});
            }, 100);
        }
    });

    // W-068: Initialize sidebars
    if (jPulse.UI?.sidebars) {
        jPulse.UI.sidebars.init({
            left: JSON.parse('{{appConfig.view.pageDecoration.sidebar.left}}'),
            right: JSON.parse('{{appConfig.view.pageDecoration.sidebar.right}}'),
            mobile: JSON.parse('{{appConfig.view.pageDecoration.sidebar.mobile}}')
        });

        // Check for empty sidebar content and show empty message if needed
        ['left', 'right'].forEach(side => {
            const sidebarEl = document.getElementById(`jp-sidebar-${side}`);
            const emptyEl = document.getElementById(`jp-sidebar-empty-${side}`);
            if (sidebarEl && emptyEl) {
                const checkEmpty = () => {
                    const content = sidebarEl.querySelector('.jp-sidebar-content');
                    if (content) {
                        // Check if content is empty (only whitespace or only the empty message itself)
                        const children = Array.from(content.children).filter(child =>
                            child.id !== `jp-sidebar-empty-${side}` &&
                            child.textContent.trim() !== ''
                        );
                        if (children.length === 0) {
                            emptyEl.style.display = 'block';
                        } else {
                            emptyEl.style.display = 'none';
                        }
                    }
                };
                // Check immediately and after a short delay (for async component loading)
                checkEmpty();
                setTimeout(checkEmpty, 100);
                // Also check when sidebar content changes (for SPA navigation)
                if (window.MutationObserver) {
                    const observer = new MutationObserver(checkEmpty);
                    const content = sidebarEl.querySelector('.jp-sidebar-content');
                    if (content) {
                        observer.observe(content, { childList: true, subtree: true });
                    }
                }
            }
        });
    }

    // Keyboard shortcut: Home key (Fn+Left on Mac) or Cmd+Up to scroll to top
    const handleKeyDown = (e) => {
        // Home key (works with Fn+Left on Mac) when not in input/textarea
        const isHomeKey = e.key === 'Home' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName);
        // Command+Up Arrow (Mac native)
        const isCmdUp = e.key === 'ArrowUp' && (e.metaKey || e.ctrlKey);

        if (isHomeKey || isCmdUp) {
            e.preventDefault();
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            // Clear URL hash if present
            if (window.location.hash) {
                window.history.pushState(null, '', window.location.pathname);
            }
        }
    };

    // Add keyboard listener
    document.addEventListener('keydown', handleKeyDown);

    // Store handler for cleanup
    tocEl._keydownHandler = handleKeyDown;

    // Cleanup on regeneration (add this in the generateToc function cleanup section)
    if (tocEl._keydownHandler) {
        document.removeEventListener('keydown', tocEl._keydownHandler);
    }
});
</script>

<!-- EOF webapp/view/jpulse-footer.tmpl -->
