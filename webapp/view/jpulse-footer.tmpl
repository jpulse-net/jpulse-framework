<!-- Start webapp/view/jpulse-footer.tmpl -->
<!--
 * @name            jPulse Framework / WebApp / View / Footer Template
 * @tagline         Footer template for jPulse pages
 * @description     Footer included in all jPulse pages to provide a consistent page layout
 * @file            webapp/view/jpulse-footer.tmpl
 * @version         1.6.20
 * @release         2026-02-20
 * @repository      https://github.com/jpulse-net/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         BSL 1.1 -- see LICENSE file; for commercial use: team@jpulse.net
 * @genai           60%, Cursor 2.3, Claude Sonnet 4.5
-->
<!-- Visual Header Banner (positioned at top via CSS) -->
<header class="jp-header">
    <div class="jp-header-content">
        <!-- Mobile Hamburger Menu Icon (W-069) -->
        {{#if appConfig.view.pageDecoration.siteNavigation.enabled}}
        <button class="jp-hamburger" id="jp-hamburger" aria-label="{{i18n.view.pageDecoration.sidebar.menu}}" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
        </button>
        {{/if}}
        <a href="/" class="jp-logo">
            <img src="/images/jpulse-logo/jpulse-logo-reverse.svg" alt="jPulse" height="22" width="22">
            <span class="jp-logo-name">{{app.site.name}}</span>
            <span class="jp-logo-shortname">{{app.site.shortName}}</span>
        </a>
        <div class="jp-user-menu">
            <div class="jp-user-icon" id="jp-user-icon">
              {{#if user.isAuthenticated}}
                <span>{{user.initials}}</span>
              {{else}}
                <span>ðŸ‘¤</span>
              {{/if}}
            </div>
            <div class="jp-dropdown" id="userDropdown">
                <!-- populated by jPulse.UI.navigation.init() (W-134) -->
            </div>
        </div>
    </div>
</header>

<!-- W-131: Broadcast Message (positioned below header) -->
{{#if (and siteConfig.broadcast.enable siteConfig.broadcast.message)}}
  {{#if (or (eq siteConfig.broadcast.disableTime 0) (not siteConfig.broadcast.enabledAt) (lt (math.subtract (date.now) (date.parse siteConfig.broadcast.enabledAt)) (math.multiply siteConfig.broadcast.disableTime 3600000)))}}
    <button id="jp-broadcast-toggle" class="jp-broadcast-toggle" aria-label="Toggle broadcast message">ï¼‹</button>
    <div id="jp-broadcast-message" class="jp-broadcast-message jp-broadcast-hidden">
        <div class="jp-broadcast-content">{{appConfig.system.broadcastMessage}}</div>
    </div>
  {{/if}}
{{/if}}

<!-- Mobile Menu Overlay (W-069) -->
{{#if appConfig.view.pageDecoration.siteNavigation.enabled}}
<div class="jp-mobile-menu-overlay" id="jp-mobile-menu-overlay"></div>
<nav class="jp-mobile-menu" id="jp-mobile-menu" aria-label="{{i18n.view.pageDecoration.sidebar.mobileNavigation}}"></nav>
{{/if}}

{{!-- W-159: Omit sidebar markup when view sets data-jp-disable-sidebars (pageDisableSidebars from view load scan) --}}
{{#unless pageDisableSidebars}}
<!-- Left Sidebar (W-068) -->
{{#if appConfig.view.pageDecoration.sidebar.left.enabled}}
<aside id="jp-sidebar-left" class="jp-sidebar jp-sidebar-left jp-sidebar-mode-{{appConfig.view.pageDecoration.sidebar.left.mode}} jp-sidebar-{{appConfig.view.pageDecoration.sidebar.left.behavior}}" data-sidebar="left">
    <div class="jp-sidebar-content">
        <div class="jp-sidebar-content-scroll">
            {{#each appConfig.view.pageDecoration.sidebar.left.components}}
                {{components name=(this)}}
            {{/each}}
            <div class="jp-sidebar-empty" id="jp-sidebar-empty-left" style="display: none;">
                {{i18n.view.pageDecoration.sidebar.empty}}
            </div>
        </div>
    </div>
    {{!-- Mobile close button (inside sidebar) --}}
    <button class="jp-sidebar-toggle jp-sidebar-toggle-close" id="jp-sidebar-toggle-close-left" aria-label="{{i18n.view.pageDecoration.sidebar.closeLeftSidebar}}" style="display:none;">â—„</button>
</aside>
<div id="jp-sidebar-separator-left" class="jp-sidebar-separator jp-sidebar-separator-left" data-sidebar="left">
    <button class="jp-sidebar-toggle jp-sidebar-toggle-left" aria-label="{{i18n.view.pageDecoration.sidebar.toggleLeftSidebar}}" title="{{i18n.view.pageDecoration.sidebar.toggleSidebar}}"></button>
</div>
{{/if}}

<!-- Right Sidebar (W-068) -->
{{#if appConfig.view.pageDecoration.sidebar.right.enabled}}
<aside id="jp-sidebar-right" class="jp-sidebar jp-sidebar-right jp-sidebar-mode-{{appConfig.view.pageDecoration.sidebar.right.mode}} jp-sidebar-{{appConfig.view.pageDecoration.sidebar.right.behavior}}" data-sidebar="right">
    <div class="jp-sidebar-content">
        <div class="jp-sidebar-content-scroll">
            {{#each appConfig.view.pageDecoration.sidebar.right.components}}
                {{components name=(this)}}
            {{/each}}
            <div class="jp-sidebar-empty" id="jp-sidebar-empty-right" style="display: none;">
                {{i18n.view.pageDecoration.sidebar.empty}}
            </div>
        </div>
    </div>
    {{!-- Mobile close button (inside sidebar) --}}
    <button class="jp-sidebar-toggle jp-sidebar-toggle-close" id="jp-sidebar-toggle-close-right" aria-label="{{i18n.view.pageDecoration.sidebar.closeRightSidebar}}" style="display:none;">â–º</button>
</aside>
<div id="jp-sidebar-separator-right" class="jp-sidebar-separator jp-sidebar-separator-right" data-sidebar="right">
    <button class="jp-sidebar-toggle jp-sidebar-toggle-right" aria-label="{{i18n.view.pageDecoration.sidebar.toggleRightSidebar}}" title="{{i18n.view.pageDecoration.sidebar.toggleSidebar}}"></button>
</div>
{{/if}}

{{!-- Mobile backdrop overlay (hidden by default, shown by JavaScript when sidebar opens on mobile) --}}
<div class="jp-sidebar-backdrop" id="jp-sidebar-backdrop"></div>
{{/unless}}

<!-- Footer -->
<footer class="jp-footer">
    <div class="jp-footer-content">
        <div class="jp-footer-left">
            <span>{{app.site.copyright}}</span>
        </div>
        <div class="jp-footer-right">
            <span class="jp-version"><a href="https://jpulse.net/" target="_blank">Powered by jPulse Framework {{app.jPulse.version}}</a></span>
        </div>
    </div>
</footer>

<!-- Site Navigation Initialization (W-069, W-098) -->
<style>
{{#if appConfig.view.pageDecoration.siteNavigation.enabled}}
:root {
    --jp-header-height: {{appConfig.view.pageDecoration.headerHeight}}px;
}
{{/if}}
</style>
<script>
jPulse.dom.ready(() => {
    // W-159: Per-page sidebar disable via body data attribute
    const disableSidebars = document.body.getAttribute('data-jp-disable-sidebars') === 'true';

    // Move sidebar elements into .jp-main on DOM ready to avoid initial layout flash
    const main = document.querySelector('.jp-main');
    if (main && !disableSidebars) {
        let frag;
        {{#if appConfig.view.pageDecoration.sidebar.left.enabled}}
        frag = document.createDocumentFragment();
        [ 'jp-sidebar-left', 'jp-sidebar-separator-left' ].forEach(id => {
            const el = document.getElementById(id);
            if (el) frag.appendChild(el);
        });
        if (frag.childNodes.length) {
            main.insertBefore(frag, main.firstChild);
        }
        {{/if}}
        {{#if appConfig.view.pageDecoration.sidebar.right.enabled}}
        frag = document.createDocumentFragment();
        [ 'jp-sidebar-right', 'jp-sidebar-separator-right' ].forEach(id => {
            const el = document.getElementById(id);
            if (el) frag.appendChild(el);
        });
        if (frag.childNodes.length) {
            main.insertBefore(frag, main.firstChild);
        }
        {{/if}}
    }

    {{#if appConfig.view.pageDecoration.siteNavigation.enabled}}
    // Initialize site navigation when DOM is ready
    // Note: Handlebars values are strings, so convert to numbers
    jPulse.UI.navigation.init({
        currentUrl: `{{url.pathname}}`,
        userRoles: {{user.roles}},
        siteNavigation: window.jPulseNavigation.site,
        userNavigation: window.jPulseNavigation.user,
        openDelay: parseInt(`{{appConfig.view.pageDecoration.siteNavigation.openDelay}}`, 10),
        closeDelay: parseInt(`{{appConfig.view.pageDecoration.siteNavigation.closeDelay}}`, 10),
        submenuCloseDelay: parseInt(`{{appConfig.view.pageDecoration.siteNavigation.submenuCloseDelay}}`, 10)
    });
    {{/if}}
    {{#if appConfig.view.pageDecoration.breadcrumbs.enabled}}
    // Initialize breadcrumbs when DOM is ready
    jPulse.UI.breadcrumbs.init({
        currentUrl: `{{url.pathname}}`,
        navigation: window.jPulseNavigation.site,
        homeLabel: `{{i18n.view.home.title}}`
    });
    {{/if}}

    // W-118: Initialize heading anchors on page load
    const initHeadingAnchors = () => {
        if (jPulse.UI?.headingAnchors) {
            jPulse.UI.headingAnchors.init({{appConfig.view.jPulse.UI.headingAnchors}});
            return true;
        }
        return false;
    };

    // Try to initialize immediately
    if (!initHeadingAnchors()) {
        // If not available yet, wait a bit and try again
        let retries = 0;
        const maxRetries = 10;
        const checkInterval = setInterval(() => {
            retries++;
            if (initHeadingAnchors() || retries >= maxRetries) {
                clearInterval(checkInterval);
            }
        }, 50);
    }

    // Also initialize on window load (in case content loads after DOMContentLoaded)
    window.addEventListener('load', () => {
        initHeadingAnchors();
    });

    // W-118: Re-initialize after SPA navigation (for markdown docs and dynamic content)
    window.addEventListener('popstate', () => {
        if (jPulse.UI?.headingAnchors) {
            // Small delay to let content render
            setTimeout(() => {
                jPulse.UI.headingAnchors.init({{appConfig.view.jPulse.UI.headingAnchors}});
            }, 100);
        }
    });

    // W-068: Initialize sidebars (skipped when body has data-jp-disable-sidebars="true", W-159)
    if (!disableSidebars && jPulse.UI?.sidebars) {
        jPulse.UI.sidebars.init({
            left: JSON.parse('{{appConfig.view.pageDecoration.sidebar.left}}'),
            right: JSON.parse('{{appConfig.view.pageDecoration.sidebar.right}}'),
            mobile: JSON.parse('{{appConfig.view.pageDecoration.sidebar.mobile}}')
        });

        // Check for empty sidebar content and show empty message if needed
        ['left', 'right'].forEach(side => {
            const sidebarEl = document.getElementById(`jp-sidebar-${side}`);
            const emptyEl = document.getElementById(`jp-sidebar-empty-${side}`);
            if (sidebarEl && emptyEl) {
                const checkEmpty = () => {
                    const content = sidebarEl.querySelector('.jp-sidebar-content');
                    if (content) {
                        // Check if content is empty (only whitespace or only the empty message itself)
                        const children = Array.from(content.children).filter(child =>
                            child.id !== `jp-sidebar-empty-${side}` &&
                            child.textContent.trim() !== ''
                        );
                        if (children.length === 0) {
                            emptyEl.style.display = 'block';
                        } else {
                            emptyEl.style.display = 'none';
                        }
                    }
                };
                // Check immediately and after a short delay (for async component loading)
                checkEmpty();
                setTimeout(checkEmpty, 100);
                // Also check when sidebar content changes (for SPA navigation)
                if (window.MutationObserver) {
                    const observer = new MutationObserver(checkEmpty);
                    const content = sidebarEl.querySelector('.jp-sidebar-content');
                    if (content) {
                        observer.observe(content, { childList: true, subtree: true });
                    }
                }
            }
        });
    }

    // W-131: Initialize broadcast message
    const toggleBtn = document.getElementById('jp-broadcast-toggle');
    const broadcastEl = document.getElementById('jp-broadcast-message');

    if (toggleBtn && broadcastEl) {
        const localStorageKey = 'jpulse-broadcast-minimized';
        const nagTime = parseInt('{{siteConfig.broadcast.nagTime}}', 10) || 4; // hours, 0 to disable

        // Get minimize state from localStorage
        function getMinimizeState() {
            const stored = localStorage.getItem(localStorageKey);
            if (!stored) {
                return { minimized: false, timestamp: null };
            }
            try {
                return JSON.parse(stored);
            } catch (e) {
                return { minimized: false, timestamp: null };
            }
        }

        // Save minimize state to localStorage
        function setMinimizeState(minimized) {
            const state = {
                minimized: minimized,
                timestamp: minimized ? Date.now() : null
            };
            localStorage.setItem(localStorageKey, JSON.stringify(state));
        }

        // Check if nag time has elapsed
        function shouldAutoOpen(state) {
            if (!state.minimized || !state.timestamp) {
                return false;
            }
            if (nagTime === 0) {
                return false; // Nag time disabled
            }
            const elapsedHours = (Date.now() - state.timestamp) / (1000 * 60 * 60);
            return elapsedHours >= nagTime;
        }

        // Show/hide broadcast message with animation
        function showBroadcast() {
            broadcastEl.classList.remove('jp-broadcast-hidden');
            // Force reflow
            broadcastEl.offsetHeight;
            broadcastEl.classList.add('jp-broadcast-show');
            toggleBtn.textContent = 'ï¼';
        }

        function hideBroadcast() {
            broadcastEl.classList.remove('jp-broadcast-show');
            setTimeout(() => {
                if (!broadcastEl.classList.contains('jp-broadcast-show')) {
                    broadcastEl.classList.add('jp-broadcast-hidden');
                }
            }, 300); // Match CSS transition duration
            toggleBtn.textContent = 'ï¼‹';
        }

        // Initialize on page load
        const state = getMinimizeState();
        if (shouldAutoOpen(state)) {
            // Nag time elapsed, auto-open
            setMinimizeState(false);
            showBroadcast();
        } else if (state.minimized) {
            // Keep minimized
            hideBroadcast();
        } else {
            // Show message
            showBroadcast();
        }

        // Handle toggle button click
        toggleBtn.addEventListener('click', () => {
            const currentState = getMinimizeState();
            if (currentState.minimized) {
                // Currently minimized, restore
                setMinimizeState(false);
                showBroadcast();
            } else {
                // Currently shown, minimize
                setMinimizeState(true);
                hideBroadcast();
            }
        });
    }

    // Keyboard shortcut: Home key (Fn+Left on Mac) or Cmd+Up to scroll to top
    const handleKeyDown = (e) => {
        // Home key (works with Fn+Left on Mac) when not in input/textarea
        const isHomeKey = e.key === 'Home' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName);
        // Command+Up Arrow (Mac native)
        const isCmdUp = e.key === 'ArrowUp' && (e.metaKey || e.ctrlKey);

        if (isHomeKey || isCmdUp) {
            e.preventDefault();
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            // Clear URL hash if present
            if (window.location.hash) {
                window.history.pushState(null, '', window.location.pathname);
            }
        }
    };

    // Add keyboard listener
    document.addEventListener('keydown', handleKeyDown);

    // Store handler for cleanup (only if TOC element exists)
    const tocEl = document.getElementById('jp-sidebar-toc');
    if (tocEl) {
        // Cleanup on regeneration (add this in the generateToc function cleanup section)
        if (tocEl._keydownHandler) {
            document.removeEventListener('keydown', tocEl._keydownHandler);
        }
        tocEl._keydownHandler = handleKeyDown;
    }
});
</script>

<!-- EOF webapp/view/jpulse-footer.tmpl -->
