<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / User Directory
 * @tagline         User directory with search and statistics
 * @description     User management interface with role-based access control
 * @file            webapp/view/user/index.shtml
 * @version         0.4.2
 * @release         2025-09-03
 * @repository      https://github.com/peterthoeny/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         GPL v3, see LICENSE file
 * @genai           80%, Cursor 1.2, Claude Sonnet 4
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{app.version}} - {{i18n.view.user.index.title}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific styles only - common styles are in jpulse-common.css */
        .jp-users-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .jp-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .jp-stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #007acc;
        }

        .jp-stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007acc;
            margin-bottom: 5px;
        }

        .jp-stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .jp-search-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .jp-users-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .jp-users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .jp-users-table th,
        .jp-users-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .jp-users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }

        .jp-users-table tbody tr:hover {
            background: #f8f9fa;
        }

        .jp-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007acc, #005999);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
        }

        .jp-user-info {
            display: flex;
            align-items: center;
        }

        .jp-user-name {
            font-weight: 500;
        }

        .jp-user-login {
            color: #666;
            font-size: 0.9em;
        }

        .jp-status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .jp-status-active {
            background: #d4edda;
            color: #155724;
        }

        .jp-status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .jp-status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .jp-status-suspended {
            background: #f5c6cb;
            color: #721c24;
        }

        .jp-role-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-right: 4px;
        }

        .jp-role-root {
            background: #dc3545;
            color: white;
        }

        .jp-role-admin {
            background: #fd7e14;
            color: white;
        }

        .jp-role-user {
            background: #007acc;
            color: white;
        }

        .jp-role-guest {
            background: #6c757d;
            color: white;
        }

        .jp-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .jp-pagination button {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .jp-pagination button:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .jp-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .jp-pagination .jp-current-page {
            background: #007acc;
            color: white;
            border-color: #007acc;
        }

        .jp-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .jp-no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .jp-search-form {
                grid-template-columns: 1fr;
            }

            .jp-search-fields {
                grid-template-columns: 1fr;
            }

            .jp-users-table-container {
                overflow-x: auto;
            }

            .jp-users-table {
                min-width: 600px;
            }

            .jp-page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="jp-main">
        <div class="jp-users-container">
          {{#if user.authenticated}}
            <div class="jp-page-header">
                <h1>{{i18n.view.user.index.title}}</h1>
            </div>

            <!-- Admin content - will show/hide based on API access -->
            <div id="adminContent" style="display: none;">
              <div class="jp-stats-grid" id="statsGrid">
                  <div class="jp-stat-card">
                      <div class="jp-stat-number" id="totalUsers">-</div>
                      <div class="jp-stat-label">{{i18n.view.user.index.totalUsers}}</div>
                  </div>
                  <div class="jp-stat-card">
                      <div class="jp-stat-number" id="activeUsers">-</div>
                      <div class="jp-stat-label">{{i18n.view.user.index.activeUsers}}</div>
                  </div>
                  <div class="jp-stat-card">
                      <div class="jp-stat-number" id="adminUsers">-</div>
                      <div class="jp-stat-label">{{i18n.view.user.index.adminUsers}}</div>
                  </div>
                  <div class="jp-stat-card">
                      <div class="jp-stat-number" id="recentLogins">-</div>
                      <div class="jp-stat-label">{{i18n.view.user.index.recentLogins}}</div>
                  </div>
              </div>

              <div class="jp-search-section">
                  <form class="jp-search-form" id="searchForm" onsubmit="searchUsers(event)">
                      <div class="jp-search-fields">
                          <div class="jp-form-group">
                              <label for="searchName">{{i18n.view.user.index.searchName}}</label>
                              <input type="text" id="searchName" name="name" class="jp-form-input" placeholder="{{i18n.view.user.index.searchNamePlaceholder}}">
                          </div>
                          <div class="jp-form-group">
                              <label for="searchEmail">{{i18n.view.user.index.searchEmail}}</label>
                              <input type="text" id="searchEmail" name="email" class="jp-form-input" placeholder="{{i18n.view.user.index.searchEmailPlaceholder}}">
                          </div>
                          <div class="jp-form-group">
                              <label for="searchRole">{{i18n.view.user.index.searchRole}}</label>
                              <select id="searchRole" name="roles" class="jp-form-select">
                                  <option value="">{{i18n.view.user.index.allRoles}}</option>
                                  <!-- Options will be populated dynamically -->
                              </select>
                          </div>
                          <div class="jp-form-group">
                              <label for="searchStatus">{{i18n.view.user.index.searchStatus}}</label>
                              <select id="searchStatus" name="status" class="jp-form-select">
                                  <option value="">{{i18n.view.user.index.allStatuses}}</option>
                                  <!-- Options will be populated from schema -->
                              </select>
                          </div>
                          <div class="jp-form-group">
                              <label>&nbsp;</label> <!-- Empty label for alignment -->
                              <div class="jp-btn-group">
                                  <button type="submit" class="jp-btn jp-btn-primary">{{i18n.view.user.index.search}}</button>
                                  <button type="button" class="jp-btn jp-btn-secondary" onclick="clearSearch()">{{i18n.view.user.index.clear}}</button>
                              </div>
                          </div>
                      </div>
                  </form>
              </div>

              <div class="jp-users-table-container">
                  <div id="loadingIndicator" class="jp-loading">
                      {{i18n.view.user.index.loading}}
                  </div>
                  <table class="jp-users-table" id="usersTable" style="display: none;">
                      <thead>
                          <tr>
                              <th>{{i18n.view.user.index.user}}</th>
                              <th>{{i18n.view.user.index.email}}</th>
                              <th>{{i18n.view.user.index.roles}}</th>
                              <th>{{i18n.view.user.index.status}}</th>
                              <th>{{i18n.view.user.index.lastLogin}}</th>
                              <th>{{i18n.view.user.index.actions}}</th>
                          </tr>
                      </thead>
                      <tbody id="usersTableBody">
                      </tbody>
                  </table>
                  <div id="noResults" class="jp-no-results" style="display: none;">
                      {{i18n.view.user.index.noResults}}
                  </div>
              </div>

              <div class="jp-pagination" id="pagination" style="display: none;">
              </div>
            </div>

            <!-- Non-admin users see access denied message -->
            <div id="accessDeniedContent" style="display: block;">
              <div class="jp-warning-box">
                  <h3>{{i18n.view.user.index.accessDeniedTitle}}</h3>
                  <p>{{i18n.view.user.index.accessDeniedMessage}}</p>
                  <div class="jp-btn-group">
                      <a href="/user/profile.shtml" class="jp-btn jp-btn-primary">{{i18n.view.auth.common.profile}}</a>
                      <a href="/" class="jp-btn jp-btn-secondary">{{i18n.view.user.index.goHome}}</a>
                  </div>
              </div>
            </div>

          {{else}}
            <div class="jp-error-box">
                {{i18n.view.auth.common.notAuthenticated}}
            </div>
          {{/if}}
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentSearch = {};
        let totalPages = 1;

        // Initialize page using jPulseCommon with API-based access control
        jPulseCommon.dom.ready(() => {
            // Check admin access first
            checkAdminAccess();

            // Load dropdown options
            loadRoles();
            loadStatuses();
        });

        async function checkAdminAccess() {
            const adminContent = document.getElementById('adminContent');
            const accessDeniedContent = document.getElementById('accessDeniedContent');

            try {
                // Try to access admin-only API to determine if user has admin access
                const result = await jPulseCommon.api.get('/api/1/user/search?stats=true&limit=1');

                if (result.success) {
                    // User has admin access - show admin content and load data
                    accessDeniedContent.style.display = 'none';
                    adminContent.style.display = 'block';
                    loadUserStats();
                    loadUsers();
                } else {
                    // User doesn't have admin access - access denied content is already showing
                    accessDeniedContent.style.display = 'block';
                }
            } catch (error) {
                // API call failed - likely due to lack of permissions
                accessDeniedContent.style.display = 'block';
            }
        }

        async function loadUserStats() {
            try {
                // Get all users to calculate stats
                const result = await jPulseCommon.api.get('/api/1/user/search?limit=1000');
                if (result.success) {
                    const users = result.data || [];

                    // Calculate stats from user data
                    const stats = {
                        totalUsers: users.length,
                        activeUsers: users.filter(user => user.status === 'active').length,
                        adminUsers: users.filter(user => user.roles && (user.roles.includes('admin') || user.roles.includes('root'))).length,
                        recentLogins: 0
                    };

                    // Calculate recent logins (last 30 days)
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    stats.recentLogins = users.filter(user =>
                        user.lastLogin && new Date(user.lastLogin) > thirtyDaysAgo
                    ).length;

                    // Update stats display
                    document.getElementById('totalUsers').textContent = stats.totalUsers;
                    document.getElementById('activeUsers').textContent = stats.activeUsers;
                    document.getElementById('adminUsers').textContent = stats.adminUsers;
                    document.getElementById('recentLogins').textContent = stats.recentLogins;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadUsers(queryParams = {}) {
            try {
                const loadingDiv = document.getElementById('loadingIndicator');
                const tableBody = document.getElementById('usersTableBody');
                const noResults = document.getElementById('noResults');
                const paginationDiv = document.getElementById('pagination');

                // Show loading state
                loadingDiv.style.display = 'block';
                tableBody.style.display = 'none';
                noResults.style.display = 'none';

                // Build query parameters
                const params = new URLSearchParams();
                params.append('page', currentPage);
                params.append('limit', '20');

                Object.keys(queryParams).forEach(key => {
                    if (queryParams[key]) {
                        params.append(key, queryParams[key]);
                    }
                });

                const result = await jPulseCommon.api.get('/api/1/user/search?' + params.toString());

                if (result.success) {
                    const userData = result.data;
                    displayUsers(userData);
                    setupPagination(result.pagination);
                } else {
                    jPulseCommon.showError(result.error || '{{i18n.view.user.index.failedToLoadUsers}}');
                }
            } catch (error) {
                jPulseCommon.showError('{{i18n.view.user.index.networkError}}');
            } finally {
                // Hide loading state
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            const usersTable = document.getElementById('usersTable');
            const noResults = document.getElementById('noResults');

            if (!users || users.length === 0) {
                noResults.style.display = 'block';
                usersTable.style.display = 'none';
                tbody.style.display = 'none';
                return;
            }

            tbody.innerHTML = '';
            users.forEach(user => {
                const row = createUserRow(user);
                tbody.appendChild(row);
            });

            // Show the table and tbody
            usersTable.style.display = 'table';
            tbody.style.display = 'table-row-group';
            noResults.style.display = 'none';
        }

        function createUserRow(user) {
            const tr = document.createElement('tr');

            // User info with avatar
            const userCell = document.createElement('td');
            const initial = (user.profile?.firstName?.[0] || user.username?.[0] || '?').toUpperCase();
            userCell.innerHTML = `
                <div class="jp-user-info">
                    <div class="jp-user-avatar">${initial}</div>
                    <div>
                        <div class="jp-user-name">${jPulseCommon.string.escapeHtml(user.profile?.firstName || '')} ${jPulseCommon.string.escapeHtml(user.profile?.lastName || '')}</div>
                        <div class="jp-user-login">@${jPulseCommon.string.escapeHtml(user.username || '')}</div>
                    </div>
                </div>
            `;
            tr.appendChild(userCell);

            // Email
            const emailCell = document.createElement('td');
            emailCell.textContent = user.email;
            tr.appendChild(emailCell);

            // Roles - no i18n, keep in English
            const rolesCell = document.createElement('td');
            rolesCell.innerHTML = (user.roles || []).map(role =>
                `<span class="jp-role-badge jp-role-${role}">${role.toUpperCase()}</span>`
            ).join('');
            tr.appendChild(rolesCell);

            // Status - no i18n, keep in English
            const statusCell = document.createElement('td');
            statusCell.textContent = user.status.charAt(0).toUpperCase() + user.status.slice(1);
            tr.appendChild(statusCell);

            // Last login - use ISO date format (YYYY-MM-DD)
            const lastLoginCell = document.createElement('td');
            if (user.lastLogin) {
                const date = new Date(user.lastLogin);
                lastLoginCell.textContent = date.toISOString().split('T')[0]; // YYYY-MM-DD format
            } else {
                lastLoginCell.textContent = 'Never';
            }
            tr.appendChild(lastLoginCell);

            // Actions - change View to Profile and internationalize
            const actionsCell = document.createElement('td');
            actionsCell.innerHTML = `
                <button class="jp-btn jp-btn-sm" onclick="viewUser('${user._id}')">{{i18n.view.user.index.viewProfile}}</button>
            `;
            tr.appendChild(actionsCell);

            return tr;
        }

        function setupPagination(pagination) {
            const paginationDiv = document.getElementById('pagination');

            // Always show pagination if there's data, even for single page
            if (!pagination) {
                return;
            }

            totalPages = pagination.totalPages || 1;
            const currentPageNum = pagination.page || 1;

            let paginationHTML = '';

            // Previous button
            const prevDisabled = currentPageNum <= 1;
            paginationHTML += `<button onclick="changePage(${currentPageNum - 1})" ${prevDisabled ? 'disabled' : ''}>{{i18n.view.user.index.previous}}</button>`;

            // Page numbers (only show if more than 1 page)
            if (totalPages > 1) {
                for (let i = Math.max(1, currentPageNum - 2); i <= Math.min(totalPages, currentPageNum + 2); i++) {
                    paginationHTML += `<button onclick="changePage(${i})" ${i === currentPageNum ? 'class="jp-current-page"' : ''}>${i}</button>`;
                }
            } else {
                // Show current page even if only 1 page
                paginationHTML += `<button class="jp-current-page">1</button>`;
            }

            // Next button - fix the disable logic using pagination.totalPages
            const nextDisabled = currentPageNum >= totalPages;
            paginationHTML += `<button onclick="changePage(${currentPageNum + 1})" ${nextDisabled ? 'disabled' : ''}>{{i18n.view.user.index.next}}</button>`;

            paginationDiv.innerHTML = paginationHTML;
            paginationDiv.style.display = 'flex';
        }

        function searchUsers(event) {
            event.preventDefault();

            const formData = jPulseCommon.form.serialize(event.target);
            const searchParams = {};

            // Filter out empty values
            Object.keys(formData).forEach(key => {
                if (formData[key] && formData[key].toString().trim()) {
                    searchParams[key] = formData[key].toString().trim();
                }
            });

            // Store current search for pagination
            currentSearch = searchParams;
            // Reset to page 1 for new searches
            currentPage = 1;
            loadUsers(searchParams);
        }

        function clearSearch() {
            document.getElementById('searchForm').reset();
            currentSearch = {};
            currentPage = 1;
            loadUsers({});
        }

        function viewUser(userId) {
            window.location.href = `/user/profile.shtml?user=${userId}`;
        }

        // Add this JavaScript function to populate roles dynamically
        async function loadRoles() {
            try {
                const response = await jPulseCommon.api.get('/api/1/auth/roles');
                if (response.success) {
                    const roleSelect = document.getElementById('searchRole');
                    const currentValue = roleSelect.value; // Preserve current selection

                    // Clear existing options except "All Roles"
                    roleSelect.innerHTML = '<option value="">{{i18n.view.user.index.allRoles}}</option>';

                    // Fix: Use response.data directly (no double wrapping)
                    const roles = response.data;
                    if (Array.isArray(roles)) {
                        roles.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role;
                            option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
                            roleSelect.appendChild(option);
                        });
                    } else {
                        console.error('Roles data is not an array:', roles);
                        jPulseCommon.showError('Invalid role data format received from server');
                    }

                    // Restore selection
                    roleSelect.value = currentValue;
                } else {
                    jPulseCommon.showError('Failed to load role options: ' + (response.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load roles:', error);
                jPulseCommon.showError('Failed to load role options. Please refresh the page.');
            }
        }

        // Add function to load statuses from schema
        async function loadStatuses() {
            // Get statuses from UserModel schema enum
            const statuses = ['active', 'inactive', 'pending', 'suspended']; // From schema
            const statusSelect = document.getElementById('searchStatus');
            const currentValue = statusSelect.value;

            statusSelect.innerHTML = '<option value="">{{i18n.view.user.index.allStatuses}}</option>';

            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                statusSelect.appendChild(option);
            });

            statusSelect.value = currentValue;
        }
    </script>

    {{file.include "jpulse-footer.tmpl"}}
</body>
</html>
