<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / User Directory
 * @tagline         User directory with search and statistics
 * @description     User management interface with role-based access control
 * @file            webapp/view/user/index.shtml
 * @version         0.4.5
 * @release         2025-09-04
 * @repository      https://github.com/peterthoeny/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         GPL v3, see LICENSE file
 * @genai           80%, Cursor 1.2, Claude Sonnet 4
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{app.version}} - {{i18n.view.user.index.title}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific styles only - common styles are in jpulse-common.css */
        .jp-search-fields {
            grid-template-columns: 1fr 1fr auto auto auto;
            gap: 15px;
            align-items: end;
        }

        .jp-users-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .jp-user-actions button {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .jp-edit-btn {
            background: #007acc;
            color: white;
        }

        .jp-edit-btn:hover {
            background: #005999;
        }

        .jp-delete-btn {
            background: #dc3545;
            color: white;
        }

        .jp-delete-btn:hover {
            background: #c82333;
        }

        /* Status-specific font size adjustment for table */
        .jp-users-table .jp-status-badge {
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="jp-main">
        <div class="jp-container-1200">
          {{#if user.authenticated}}
            <div class="jp-page-header">
                <h1>{{i18n.view.user.index.title}}</h1>
            </div>

            <!-- Admin content - will show/hide based on JavaScript role check -->
            <div id="adminContent" style="display: none;">
              <div class="jp-stats-grid" id="statsGrid">
                  <div class="jp-stat-card">
                      <div class="jp-stat-number" id="totalUsers">-</div>
                      <div class="jp-stat-label">{{i18n.view.user.index.totalUsers}}</div>
                  </div>
                  <div class="jp-stat-card">
                      <div class="jp-stat-number" id="activeUsers">-</div>
                      <div class="jp-stat-label">{{i18n.view.user.index.activeUsers}}</div>
                  </div>
                  <div class="jp-stat-card">
                      <div class="jp-stat-number" id="adminUsers">-</div>
                      <div class="jp-stat-label">{{i18n.view.user.index.adminUsers}}</div>
                  </div>
                  <div class="jp-stat-card">
                      <div class="jp-stat-number" id="recentLogins">-</div>
                      <div class="jp-stat-label">{{i18n.view.user.index.recentLogins}}</div>
                  </div>
              </div>

              <div class="jp-search-section">
                  <form class="jp-search-form" id="searchForm">
                      <div class="jp-search-fields">
                          <div class="jp-form-group">
                              <label for="searchName" class="jp-form-label">{{i18n.view.user.index.searchName}}</label>
                              <input type="text" id="searchName" name="name" class="jp-form-input" placeholder="{{i18n.view.user.index.searchNamePlaceholder}}">
                          </div>
                          <div class="jp-form-group">
                              <label for="searchEmail" class="jp-form-label">{{i18n.view.user.index.searchEmail}}</label>
                              <input type="text" id="searchEmail" name="email" class="jp-form-input" placeholder="{{i18n.view.user.index.searchEmailPlaceholder}}">
                          </div>
                          <div class="jp-form-group">
                              <label for="searchRole" class="jp-form-label">{{i18n.view.user.index.searchRole}}</label>
                              <select id="searchRole" name="roles" class="jp-form-select">
                                  <option value="">{{i18n.view.user.index.allRoles}}</option>
                                  <!-- Options will be populated dynamically -->
                              </select>
                          </div>
                          <div class="jp-form-group">
                              <label for="searchStatus" class="jp-form-label">{{i18n.view.user.index.searchStatus}}</label>
                              <select id="searchStatus" name="status" class="jp-form-select">
                                  <option value="">{{i18n.view.user.index.allStatuses}}</option>
                                  <!-- Options will be populated from schema -->
                              </select>
                          </div>
                          <div class="jp-form-group">
                              <label>&nbsp;</label> <!-- Empty label for alignment -->
                              <div class="jp-btn-group">
                                  <button type="submit" class="jp-btn jp-btn-primary">{{i18n.view.user.index.search}}</button>
                                  <button type="button" class="jp-btn jp-btn-secondary" onclick="clearSearch()">{{i18n.view.user.index.clear}}</button>
                              </div>
                          </div>
                      </div>
                  </form>
              </div>

              <div class="jp-table-container" id="usersTableContainer">
                  <table class="jp-table" id="usersTable">
                      <thead>
                          <tr>
                              <th>{{i18n.view.user.index.user}}</th>
                              <th>{{i18n.view.user.index.email}}</th>
                              <th>{{i18n.view.user.index.roles}}</th>
                              <th>{{i18n.view.user.index.status}}</th>
                              <th>{{i18n.view.user.index.lastLogin}}</th>
                              <th>{{i18n.view.user.index.actions}}</th>
                          </tr>
                      </thead>
                      <tbody id="usersTableBody">
                          <!-- Users will be populated dynamically -->
                      </tbody>
                  </table>
              </div>

              <div class="jp-pagination" id="pagination" style="display: none;">
                  <button id="prevPage" disabled>{{i18n.view.user.index.previous}}</button>
                  <span id="pageInfo">{{i18n.view.user.index.pageInfo}}</span>
                  <button id="nextPage" disabled>{{i18n.view.user.index.next}}</button>
              </div>

              <div class="jp-loading-state" id="loadingState">
                  {{i18n.view.user.index.loading}}
              </div>

              <div class="jp-no-results" id="noResults" style="display: none;">
                  {{i18n.view.user.index.noResults}}
              </div>
            </div>

            <!-- Non-admin content -->
            <div id="userContent" style="display: none;">
                <div class="jp-info-box">
                    <h3>{{i18n.view.user.index.accessDeniedTitle}}</h3>
                    <p>{{i18n.view.user.index.accessDeniedMessage}}</p>
                    <div class="jp-btn-group">
                        <a href="/user/profile.shtml" class="jp-btn jp-btn-primary">{{i18n.view.auth.common.profile}}</a>
                        <a href="/" class="jp-btn jp-btn-secondary">{{i18n.view.user.index.goHome}}</a>
                    </div>
                </div>
            </div>

          {{else}}
            <div class="jp-error-box">
                {{i18n.view.auth.common.notAuthenticated}}
            </div>
          {{/if}}
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};
        let allUsers = [];
        let userSchema = null;

        // Enhanced user management using jPulseCommon utilities
        jPulseCommon.dom.ready(() => {
            checkUserAccess();
        });

        function checkUserAccess() {
            // Get user roles from server-side data (always a string, including empty)
            const userRoles = '{{user.roles}}'.split(',').map(role => role.trim()); // ["admin", "user"]
            console.log('User roles:', userRoles); // Debug log

            // Check if user has admin or root role
            const isAdmin = userRoles.includes('admin') || userRoles.includes('root');
            console.log('Is admin:', isAdmin); // Debug log

            if (isAdmin) {
                // User has admin access
                document.getElementById('adminContent').style.display = 'block';
                document.getElementById('userContent').style.display = 'none';

                // Initialize admin functionality (using original working functions)
                loadRoles();
                loadStatuses();
                loadUserStats();
                loadUsers();
                setupEventListeners();
            } else {
                // User has limited access
                document.getElementById('adminContent').style.display = 'none';
                document.getElementById('userContent').style.display = 'block';
            }
        }

        function setupEventListeners() {
            // Setup search form
            const searchForm = document.getElementById('searchForm');
            searchForm.addEventListener('submit', (event) => {
                event.preventDefault();
                searchUsers(event);
            });

            // Setup pagination
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadUsers(currentFilters);
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadUsers(currentFilters);
                }
            });
        }

        // Restore original working functions
        async function loadUserStats() {
            try {
                // Get all users to calculate stats (original approach)
                const result = await jPulseCommon.api.get('/api/1/user/search?limit=1000');
                if (result.success) {
                    const users = result.data || [];

                    // Calculate stats from user data
                    const stats = {
                        totalUsers: users.length,
                        activeUsers: users.filter(user => user.status === 'active').length,
                        adminUsers: users.filter(user => user.roles && (user.roles.includes('admin') || user.roles.includes('root'))).length,
                        recentLogins: 0
                    };

                    // Calculate recent logins (last 30 days)
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    stats.recentLogins = users.filter(user =>
                        user.lastLogin && new Date(user.lastLogin) > thirtyDaysAgo
                    ).length;

                    // Update stats display
                    document.getElementById('totalUsers').textContent = stats.totalUsers;
                    document.getElementById('activeUsers').textContent = stats.activeUsers;
                    document.getElementById('adminUsers').textContent = stats.adminUsers;
                    document.getElementById('recentLogins').textContent = stats.recentLogins;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadUsers(queryParams = {}) {
            try {
                showLoading(true);

                // Build query parameters (original approach)
                const params = new URLSearchParams();
                params.append('page', currentPage);
                params.append('limit', '20');

                Object.keys(queryParams).forEach(key => {
                    if (queryParams[key]) {
                        params.append(key, queryParams[key]);
                    }
                });

                const result = await jPulseCommon.api.get('/api/1/user/search?' + params.toString());

                if (result.success) {
                    const userData = result.data;
                    displayUsers(userData);
                    setupPagination(result.pagination);
                } else {
                    jPulseCommon.showSlideDownError(result.error || '{{i18n.view.user.index.failedToLoadUsers}}');
                }
            } catch (error) {
                jPulseCommon.showSlideDownError('{{i18n.view.user.index.networkError}}');
            } finally {
                showLoading(false);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            const usersTable = document.getElementById('usersTable');
            const noResults = document.getElementById('noResults');

            if (!users || users.length === 0) {
                noResults.style.display = 'block';
                usersTable.style.display = 'none';
                return;
            }

            tbody.innerHTML = '';
            users.forEach(user => {
                const row = createUserRow(user);
                tbody.appendChild(row);
            });

            // Show the table
            usersTable.style.display = 'table';
            noResults.style.display = 'none';
        }

        function createUserRow(user) {
            const tr = document.createElement('tr');

            // User info with avatar
            const userCell = document.createElement('td');
            const initial = (user.profile?.firstName?.[0] || user.username?.[0] || '?').toUpperCase();
            userCell.innerHTML = `
                <div class="jp-user-info">
                    <div class="jp-user-avatar">${initial}</div>
                    <div>
                        <div class="jp-user-name">${jPulseCommon.string.escapeHtml(user.profile?.firstName || '')} ${jPulseCommon.string.escapeHtml(user.profile?.lastName || '')}</div>
                        <div class="jp-user-login">@${jPulseCommon.string.escapeHtml(user.username || '')}</div>
                    </div>
                </div>
            `;
            tr.appendChild(userCell);

            // Email
            const emailCell = document.createElement('td');
            emailCell.textContent = user.email;
            tr.appendChild(emailCell);

            // Roles
            const rolesCell = document.createElement('td');
            rolesCell.innerHTML = (user.roles || []).map(role =>
                `<span class="jp-role-badge jp-role-${role}">${role.toUpperCase()}</span>`
            ).join('');
            tr.appendChild(rolesCell);

            // Status
            const statusCell = document.createElement('td');
            statusCell.innerHTML = `<span class="jp-status-badge jp-status-${user.status}">${user.status.charAt(0).toUpperCase() + user.status.slice(1)}</span>`;
            tr.appendChild(statusCell);

            // Last login - use ISO date format (YYYY-MM-DD)
            const lastLoginCell = document.createElement('td');
            if (user.lastLogin) {
                const date = new Date(user.lastLogin);
                lastLoginCell.textContent = date.toISOString().split('T')[0]; // YYYY-MM-DD format
            } else {
                lastLoginCell.textContent = 'Never';
            }
            tr.appendChild(lastLoginCell);

            // Actions
            const actionsCell = document.createElement('td');
            actionsCell.innerHTML = `
                <button class="jp-edit-btn" onclick="viewUser('${user.id}')">{{i18n.view.user.index.viewProfile}}</button>
            `;
            tr.appendChild(actionsCell);

            return tr;
        }

        function setupPagination(pagination) {
            const paginationDiv = document.getElementById('pagination');

            if (!pagination) {
                return;
            }

            totalPages = pagination.totalPages || 1;
            const currentPageNum = pagination.page || 1;

            let paginationHTML = '';

            // Previous button
            const prevDisabled = currentPageNum <= 1;
            paginationHTML += `<button onclick="changePage(${currentPageNum - 1})" ${prevDisabled ? 'disabled' : ''}>{{i18n.view.user.index.previous}}</button>`;

            // Page numbers (only show if more than 1 page)
            if (totalPages > 1) {
                for (let i = Math.max(1, currentPageNum - 2); i <= Math.min(totalPages, currentPageNum + 2); i++) {
                    paginationHTML += `<button onclick="changePage(${i})" ${i === currentPageNum ? 'class="jp-current-page"' : ''}>${i}</button>`;
                }
            } else {
                // Show current page even if only 1 page
                paginationHTML += `<button class="jp-current-page">1</button>`;
            }

            // Next button
            const nextDisabled = currentPageNum >= totalPages;
            paginationHTML += `<button onclick="changePage(${currentPageNum + 1})" ${nextDisabled ? 'disabled' : ''}>{{i18n.view.user.index.next}}</button>`;

            paginationDiv.innerHTML = paginationHTML;
            paginationDiv.style.display = 'flex';
        }

        function searchUsers(event) {
            event.preventDefault();

            const formData = jPulseCommon.form.serialize(event.target);
            const searchParams = {};

            // Filter out empty values
            Object.keys(formData).forEach(key => {
                if (formData[key] && formData[key].toString().trim()) {
                    searchParams[key] = formData[key].toString().trim();
                }
            });

            // Store current search for pagination
            currentFilters = searchParams;
            // Reset to page 1 for new searches
            currentPage = 1;
            loadUsers(searchParams);
        }

        function changePage(newPage) {
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadUsers(currentFilters);
            }
        }

        function viewUser(userId) {
            window.location.href = `/user/profile.shtml?user=${userId}`;
        }

        // Restore original working functions
        async function loadRoles() {
            try {
                const response = await jPulseCommon.api.get('/api/1/auth/roles');
                if (response.success) {
                    const roleSelect = document.getElementById('searchRole');
                    const currentValue = roleSelect.value; // Preserve current selection

                    // Clear existing options except "All Roles"
                    roleSelect.innerHTML = '<option value="">{{i18n.view.user.index.allRoles}}</option>';

                    const roles = response.data;
                    if (Array.isArray(roles)) {
                        roles.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role;
                            option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
                            roleSelect.appendChild(option);
                        });
                    }

                    // Restore selection
                    roleSelect.value = currentValue;
                } else {
                    jPulseCommon.showSlideDownError('Failed to load role options: ' + (response.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load roles:', error);
                jPulseCommon.showSlideDownError('Failed to load role options. Please refresh the page.');
            }
        }

        async function loadStatuses() {
            // Get statuses from UserModel schema enum (original approach)
            const statuses = ['active', 'inactive', 'pending', 'suspended'];
            const statusSelect = document.getElementById('searchStatus');
            const currentValue = statusSelect.value;

            statusSelect.innerHTML = '<option value="">{{i18n.view.user.index.allStatuses}}</option>';

            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                statusSelect.appendChild(option);
            });

            statusSelect.value = currentValue;
        }

        function showLoading(show) {
            const loadingState = document.getElementById('loadingState');
            const tableContainer = document.getElementById('usersTableContainer');

            if (show) {
                loadingState.style.display = 'block';
                tableContainer.style.display = 'none';
            } else {
                loadingState.style.display = 'none';
                tableContainer.style.display = 'block';
            }
        }

        function showNoResults() {
            document.getElementById('noResults').style.display = 'block';
            document.getElementById('usersTableContainer').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
        }

        // Clear search functionality
        function clearSearch() {
            // Reset form fields
            document.getElementById('searchName').value = '';
            document.getElementById('searchEmail').value = '';
            document.getElementById('searchRole').value = '';
            document.getElementById('searchStatus').value = '';

            // Reset current filters
            currentFilters = {};
            currentPage = 1;

            // Reload all users
            loadUsers();
        }
    </script>

    {{file.include "jpulse-footer.tmpl"}}
</body>
</html>
