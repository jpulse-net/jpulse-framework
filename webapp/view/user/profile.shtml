<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / User Profile
 * @tagline         User profile view with edit capabilities
 * @description     User profile management with view and edit modes
 * @file            webapp/view/user/profile.shtml
 * @version         0.7.10
 * @release         2025-09-17
 * @repository      https://github.com/peterthoeny/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         AGPL v3, see LICENSE file
 * @genai           80%, Cursor 1.2, Claude Sonnet 4
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{app.version}} - {{i18n.view.user.profile.title}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific profile styles only */
        .local-profile-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007acc;
        }

        .local-profile-info h1 {
            margin: 0;
            color: #333;
        }

        .local-profile-info .jp-user-details {
            color: #666;
            margin: 5px 0;
        }

        .local-profile-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .local-profile-section h3 {
            margin-top: 0;
            color: #007acc;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .local-profile-section h3.local-no-content-header {
            margin-bottom: -5px;
            border-bottom: 0 none;
            padding-bottom: 0;
        }

        .local-user-profile .jp-read-only-field {
            background: #f8f9fa;
            color: #6c757d;
        }

    </style>
</head>
<body>
    <div class="jp-main">
        <div class="jp-container-800 local-user-profile">
          {{#if user.authenticated}}
            <div class="local-profile-header">
                <div class="jp-user-avatar-large">
                    {{user.initials}}
                </div>
                <div class="local-profile-info">
                    <h1>{{user.firstName}} {{user.lastName}}</h1>
                    <div class="jp-user-details">@{{user.username}} â€¢ {{user.email}}</div>
                    <div class="jp-user-details">
                        <span class="jp-status-badge jp-status-{{user.status}}">{{user.status}}</span>
                    </div>
                </div>
            </div>

            <div class="local-profile-section">
                <h3>{{i18n.view.user.profile.personalInfo}}</h3>
                <form id="profileForm" class="jp-form">
                    <div class="jp-form-grid">
                        <div class="jp-form-group">
                            <label for="firstName" class="jp-form-label">{{i18n.view.user.profile.firstName}}</label>
                            <input type="text" id="firstName" name="firstName" class="jp-form-input jp-read-only-field" value="{{user.firstName}}" readonly>
                        </div>
                        <div class="jp-form-group">
                            <label for="lastName" class="jp-form-label">{{i18n.view.user.profile.lastName}}</label>
                            <input type="text" id="lastName" name="lastName" class="jp-form-input jp-read-only-field" value="{{user.lastName}}" readonly>
                        </div>
                    </div>
                    <div class="jp-form-grid">
                        <div class="jp-form-group">
                            <label for="nickName" class="jp-form-label">{{i18n.view.user.profile.nickName}}</label>
                            <input type="text" id="nickName" name="nickName" class="jp-form-input jp-read-only-field" value="{{user.nickName}}" readonly>
                        </div>
                        <div class="jp-form-group">
                            <label for="email" class="jp-form-label">{{i18n.view.user.profile.email}}</label>
                            <input type="email" id="email" name="email" class="jp-form-input jp-read-only-field" value="{{user.email}}" readonly>
                        </div>
                    </div>
                </form>
            </div>

            <div class="local-profile-section">
                <h3>{{i18n.view.user.profile.preferences}}</h3>
                <form id="preferencesForm" class="jp-form">
                    <div class="jp-form-grid">
                        <div class="jp-form-group">
                            <label for="language" class="jp-form-label">{{i18n.view.user.profile.language}}</label>
                            <select id="language" name="language" class="jp-form-select" disabled>
                                <!-- Options will be populated dynamically -->
                            </select>

                            <label for="theme" class="jp-form-label">{{i18n.view.user.profile.theme}}</label>
                            <select id="theme" name="theme" class="jp-form-select" disabled>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="local-profile-section jp-view-mode-only">
                <h3 class="local-no-content-header">{{i18n.view.user.profile.security}}</h3>
            </div>

            <div id="securitySection" class="jp-collapsible jp-edit-mode-only">
                <h3>{{i18n.view.user.profile.security}}</h3>
                <div class="jp-collapsible-content">
                    <div class="jp-alert jp-alert-info">
                        {{i18n.view.user.profile.securityNote}}
                    </div>

                    <!-- Password fields (shown when section is expanded in edit mode) -->
                    <div id="passwordFields" class="jp-hidden jp-password-form">
                        <div class="jp-form-group">
                            <label for="currentPassword" class="jp-form-label">{{i18n.view.user.profile.currentPassword}}</label>
                            <input type="password" id="currentPassword" name="currentPassword" class="jp-form-input">
                        </div>
                        <div class="jp-form-grid">
                            <div class="jp-form-group">
                                <label for="newPassword" class="jp-form-label">{{i18n.view.user.profile.newPassword}}</label>
                                <input type="password" id="newPassword" name="newPassword" class="jp-form-input">
                            </div>
                            <div class="jp-form-group">
                                <label for="confirmPassword" class="jp-form-label">{{i18n.view.user.profile.confirmPassword}}</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" class="jp-form-input">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="jp-btn-group">
                <button id="editBtn" class="jp-btn jp-btn-primary" onclick="toggleEditMode()">{{i18n.view.user.profile.edit}}</button>
                <button id="saveBtn" class="jp-btn jp-btn-success jp-hidden" onclick="saveProfile()">{{i18n.view.user.profile.save}}</button>
                <button id="cancelBtn" class="jp-btn jp-btn-secondary jp-hidden" onclick="cancelEdit()">{{i18n.view.user.profile.cancel}}</button>
            </div>
          {{else}}
            <div class="jp-alert jp-alert-error">
                {{i18n.view.auth.common.notAuthenticated}}
            </div>
          {{/if}}
        </div>
    </div>

    <script>
        let editMode = false;
        let originalValues = {};

        // Enhanced profile management using jPulse utilities
        let securityCollapsible = null;

        jPulse.dom.ready(() => {
            loadProfile();
            loadLanguages();
            loadThemes();

            // Register the collapsible security section with handle
            securityCollapsible = jPulse.UI.collapsible.register('securitySection', {
                initOpen: false,
                onOpen: () => {
                    // Show password fields when opened
                    const passwordFields = document.getElementById('passwordFields');
                    jPulse.dom.show(passwordFields);
                },
                onClose: () => {
                    // Hide password fields and clear them when closed
                    const passwordFields = document.getElementById('passwordFields');
                    jPulse.dom.hide(passwordFields);
                    ['currentPassword', 'newPassword', 'confirmPassword'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                }
            });
        });

        function toggleEditMode() {
            editMode = !editMode;
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const passwordFields = document.getElementById('passwordFields');

            if (editMode) {
                // Add edit mode class to container to show/hide sections
                const container = document.querySelector('.jp-container-800');
                container.classList.add('jp-edit-mode');

                // Ensure security section starts collapsed when entering edit mode
                if (securityCollapsible && securityCollapsible.isExpanded()) {
                    securityCollapsible.collapse();
                }

                // Store original values
                originalValues = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    nickName: document.getElementById('nickName').value,
                    language: document.getElementById('language').value,
                    theme: document.getElementById('theme').value
                };

                // Enable editing for profile fields
                ['firstName', 'lastName', 'nickName'].forEach(id => {
                    const field = document.getElementById(id);
                    field.readOnly = false;
                    field.classList.remove('jp-read-only-field');
                });

                // Enable editing for preference fields
                ['language', 'theme'].forEach(id => {
                    const field = document.getElementById(id);
                    field.disabled = false;
                    field.classList.remove('jp-read-only-field');
                });

                // Update buttons
                jPulse.dom.hide(editBtn);
                jPulse.dom.show(saveBtn);
                jPulse.dom.show(cancelBtn);
            } else {
                cancelEdit();
            }
        }

        function cancelEdit() {
            editMode = false;

            // Remove edit mode class from container
            const container = document.querySelector('.jp-container-800');
            container.classList.remove('jp-edit-mode');

            // Restore original values
            Object.keys(originalValues).forEach(key => {
                const field = document.getElementById(key);
                if (field) {
                    field.value = originalValues[key];
                }
            });

            // Disable editing for profile fields
            ['firstName', 'lastName', 'nickName'].forEach(id => {
                const field = document.getElementById(id);
                field.readOnly = true;
                field.classList.add('jp-read-only-field');
            });

            // Disable editing for preference fields
            ['language', 'theme'].forEach(id => {
                const field = document.getElementById(id);
                field.disabled = true;
                field.classList.add('jp-read-only-field');
            });

            // Hide password fields and clear them
            jPulse.dom.hide(document.getElementById('passwordFields'));
            ['currentPassword', 'newPassword', 'confirmPassword'].forEach(id => {
                document.getElementById(id).value = '';
            });

            // Update buttons
            jPulse.dom.show(document.getElementById('editBtn'));
            jPulse.dom.hide(document.getElementById('saveBtn'));
            jPulse.dom.hide(document.getElementById('cancelBtn'));
        }

        async function saveProfile() {
            // Check if user wants to change password (security section expanded and password fields filled)
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            const isChangingPassword = securityCollapsible && securityCollapsible.isExpanded() &&
                                     (currentPassword || newPassword || confirmPassword);

            // Prepare profile and preferences data
            const profileData = {
                profile: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    nickName: document.getElementById('nickName').value
                },
                preferences: {
                    language: document.getElementById('language').value,
                    theme: document.getElementById('theme').value
                }
            };

            try {
                // Always save profile and preferences first
                const profileResult = await jPulse.api.put('/api/1/user/profile', profileData);

                if (!profileResult.success) {
                    jPulse.showSlideDownError(profileResult.error || '{{i18n.view.user.profile.failedToUpdateProfile}}');
                    return;
                }

                // If user wants to change password, handle that too
                if (isChangingPassword) {

                    // Validate password fields
                    if (!currentPassword || !newPassword || !confirmPassword) {
                        jPulse.showSlideDownError('{{i18n.view.user.profile.allPasswordFieldsRequired}}');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        jPulse.showSlideDownError('{{i18n.view.user.profile.passwordsDoNotMatch}}');
                        return;
                    }

                    if (newPassword.length < 8) {
                        jPulse.showSlideDownError('{{i18n.view.user.profile.passwordTooShort}}');
                        return;
                    }

                    // Save password
                    const passwordData = {
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    };

                    const passwordResult = await jPulse.api.put('/api/1/user/password', passwordData);

                    if (!passwordResult.success) {
                        jPulse.showSlideDownError(passwordResult.error || '{{i18n.view.user.profile.failedToUpdatePassword}}');
                        return;
                    }
                }

                // Success - show appropriate message
                const successMessage = isChangingPassword
                    ? '{{i18n.view.user.profile.profileAndPasswordUpdatedSuccess}}'
                    : '{{i18n.view.user.profile.profileUpdatedSuccess}}';

                jPulse.showSlideDownSuccess(successMessage);

                // Exit edit mode and reload data
                editMode = false;
                cancelEdit();
                await loadProfile();

            } catch (error) {
                jPulse.showSlideDownError('{{i18n.view.user.profile.networkError}}: ' + error.message);
            }
        }


        async function loadProfile() {
            try {
                const result = await jPulse.api.get('/api/1/user/profile');
                if (result.success && result.data) {
                    const user = result.data;

                    // Update form fields
                    document.getElementById('firstName').value = user.profile?.firstName || '';
                    document.getElementById('lastName').value = user.profile?.lastName || '';
                    document.getElementById('nickName').value = user.profile?.nickName || '';
                    document.getElementById('email').value = user.email || '';

                    // Update preferences
                    document.getElementById('language').value = user.preferences?.language || 'en';
                    document.getElementById('theme').value = user.preferences?.theme || 'light';

                    // Update status badge
                    const statusBadge = document.querySelector('.jp-status-badge');
                    if (statusBadge && user.status) {
                        statusBadge.textContent = user.status.charAt(0).toUpperCase() + user.status.slice(1);
                        statusBadge.className = `jp-status-badge jp-status-${user.status}`;
                    }
                } else {
                    jPulse.showSlideDownError(result.error || '{{i18n.view.user.profile.failedToLoadProfile}}');
                }
            } catch (error) {
                jPulse.showSlideDownError('{{i18n.view.user.profile.networkErrorLoadingProfile}}: ' + error.message);
            }
        }

        async function loadLanguages() {
            try {
                const response = await jPulse.api.get('/api/1/auth/languages');

                if (response.success) {
                    const languageSelect = document.getElementById('language');
                    const currentValue = languageSelect.value;

                    languageSelect.innerHTML = '';

                    const languages = response.data;
                    if (Array.isArray(languages)) {
                        languages.forEach(([code, name]) => {
                            const option = document.createElement('option');
                            option.value = code;
                            option.textContent = name;
                            languageSelect.appendChild(option);
                        });
                    } else {
                        console.error('Languages data is not an array:', languages);
                        jPulse.showSlideDownError('Invalid language data format received from server');
                    }

                    languageSelect.value = currentValue;
                } else {
                    jPulse.showSlideDownError('Failed to load language options: ' + (response.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load languages:', error);
                jPulse.showSlideDownError('Failed to load language options. Please refresh the page.');
            }
        }

        async function loadThemes() {
            try {
                const response = await jPulse.api.get('/api/1/auth/themes');

                if (response.success) {
                    const themeSelect = document.getElementById('theme');
                    const currentValue = themeSelect.value;

                    themeSelect.innerHTML = '';

                    const themes = response.data;
                    if (Array.isArray(themes)) {
                        themes.forEach(theme => {
                            const option = document.createElement('option');
                            option.value = theme;
                            option.textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
                            themeSelect.appendChild(option);
                        });
                    } else {
                        console.error('Themes data is not an array:', themes);
                        jPulse.showSlideDownError('Invalid theme data format received from server');
                    }

                    themeSelect.value = currentValue;
                } else {
                    jPulse.showSlideDownError('Failed to load theme options: ' + (response.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load themes:', error);
                jPulse.showSlideDownError('Failed to load theme options. Please refresh the page.');
            }
        }

        // Update initialization
        document.addEventListener('DOMContentLoaded', function() {
            loadProfile();
            loadLanguages();
            loadThemes();
        });
    </script>

    {{file.include "jpulse-footer.tmpl"}}
</body>
</html>
