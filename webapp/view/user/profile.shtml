<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / User Profile
 * @tagline         User profile view with edit capabilities
 * @description     User profile management with view and edit modes
 * @file            webapp/view/user/profile.shtml
 * @version         0.4.4
 * @release         2025-09-04
 * @repository      https://github.com/peterthoeny/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         GPL v3, see LICENSE file
 * @genai           80%, Cursor 1.2, Claude Sonnet 4
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{app.version}} - {{i18n.view.user.profile.title}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Page-specific profile styles only */
        .jp-profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007acc;
        }

        .jp-profile-info h1 {
            margin: 0;
            color: #333;
        }

        .jp-profile-info .jp-user-details {
            color: #666;
            margin: 5px 0;
        }

        .jp-profile-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .jp-profile-section h3 {
            margin-top: 0;
            color: #007acc;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .jp-read-only-field {
            background: #f8f9fa;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="jp-main">
        <div class="jp-container-800">
          {{#if user.authenticated}}
            <div class="jp-profile-header">
                <div class="jp-user-avatar-large">
                    {{user.initials}}
                </div>
                <div class="jp-profile-info">
                    <h1>{{user.firstName}} {{user.lastName}}</h1>
                    <div class="jp-user-details">@{{user.username}} â€¢ {{user.email}}</div>
                    <div class="jp-user-details">
                        <span class="jp-status-badge jp-status-active">{{i18n.view.user.profile.statusActive}}</span>
                    </div>
                </div>
            </div>

            <div class="jp-profile-section">
                <h3>{{i18n.view.user.profile.personalInfo}}</h3>
                <form id="profileForm" class="jp-form">
                    <div class="jp-form-grid">
                        <div class="jp-form-group">
                            <label for="firstName" class="jp-form-label">{{i18n.view.user.profile.firstName}}</label>
                            <input type="text" id="firstName" name="firstName" class="jp-form-input jp-read-only-field" value="{{user.firstName}}" readonly>
                        </div>
                        <div class="jp-form-group">
                            <label for="lastName" class="jp-form-label">{{i18n.view.user.profile.lastName}}</label>
                            <input type="text" id="lastName" name="lastName" class="jp-form-input jp-read-only-field" value="{{user.lastName}}" readonly>
                        </div>
                    </div>
                    <div class="jp-form-grid">
                        <div class="jp-form-group">
                            <label for="nickName" class="jp-form-label">{{i18n.view.user.profile.nickName}}</label>
                            <input type="text" id="nickName" name="nickName" class="jp-form-input jp-read-only-field" value="{{user.nickName}}" readonly>
                        </div>
                        <div class="jp-form-group">
                            <label for="email" class="jp-form-label">{{i18n.view.user.profile.email}}</label>
                            <input type="email" id="email" name="email" class="jp-form-input jp-read-only-field" value="{{user.email}}" readonly>
                        </div>
                    </div>
                </form>
            </div>

            <div class="jp-profile-section">
                <h3>{{i18n.view.user.profile.preferences}}</h3>
                <form id="preferencesForm" class="jp-form">
                    <div class="jp-form-grid">
                        <div class="jp-form-group">
                            <label for="language" class="jp-form-label">{{i18n.view.user.profile.language}}</label>
                            <select id="language" name="language" class="jp-form-select" disabled>
                                <!-- Options will be populated dynamically -->
                            </select>

                            <label for="theme" class="jp-form-label">{{i18n.view.user.profile.theme}}</label>
                            <select id="theme" name="theme" class="jp-form-select" disabled>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="jp-profile-section">
                <h3>{{i18n.view.user.profile.security}}</h3>
                <div class="jp-alert jp-alert-info">
                    {{i18n.view.user.profile.securityNote}}
                </div>
                <form id="passwordForm" class="jp-form jp-hidden jp-password-form">
                    <div class="jp-form-group">
                        <label for="currentPassword" class="jp-form-label">{{i18n.view.user.profile.currentPassword}}</label>
                        <input type="password" id="currentPassword" name="currentPassword" class="jp-form-input" required>
                    </div>
                    <div class="jp-form-grid">
                        <div class="jp-form-group">
                            <label for="newPassword" class="jp-form-label">{{i18n.view.user.profile.newPassword}}</label>
                            <input type="password" id="newPassword" name="newPassword" class="jp-form-input" required>
                        </div>
                        <div class="jp-form-group">
                            <label for="confirmPassword" class="jp-form-label">{{i18n.view.user.profile.confirmPassword}}</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" class="jp-form-input" required>
                        </div>
                    </div>
                    <button type="submit" class="jp-btn jp-btn-success jp-btn-submit">
                        {{i18n.view.user.profile.updatePassword}}
                    </button>
                </form>
            </div>

            <div class="jp-btn-group">
                <button id="editBtn" class="jp-btn jp-btn-primary" onclick="toggleEditMode()">{{i18n.view.user.profile.edit}}</button>
                <button id="saveBtn" class="jp-btn jp-btn-success jp-hidden" onclick="saveProfile()">{{i18n.view.user.profile.save}}</button>
                <button id="cancelBtn" class="jp-btn jp-btn-secondary jp-hidden" onclick="cancelEdit()">{{i18n.view.user.profile.cancel}}</button>
                <button id="changePasswordBtn" class="jp-btn jp-btn-secondary" onclick="togglePasswordForm()">{{i18n.view.user.profile.changePassword}}</button>
            </div>
          {{else}}
            <div class="jp-alert jp-alert-error">
                {{i18n.view.auth.common.notAuthenticated}}
            </div>
          {{/if}}
        </div>
    </div>

    <script>
        let editMode = false;
        let originalValues = {};

        // Enhanced profile management using jPulseCommon utilities
        document.addEventListener('DOMContentLoaded', function() {
            loadProfile();

            // Setup password form submission
            const passwordForm = document.getElementById('passwordForm');
            passwordForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                const result = await jPulseCommon.form.handleSubmission(passwordForm, '/api/1/user/password', {
                    method: 'PUT',
                    successMessage: '{{i18n.view.user.profile.passwordUpdatedSuccess}}',
                    loadingText: '{{i18n.view.user.profile.updatingPassword}}',
                    clearOnSuccess: true,
                    beforeSubmit: validatePasswordForm,
                    onSuccess: () => {
                        togglePasswordForm(); // Hide form after success
                    }
                });
            });
        });

        function toggleEditMode() {
            editMode = !editMode;
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const passwordForm = document.getElementById('passwordForm');

            if (editMode) {
                // If password form is open, close it first
                if (!passwordForm.classList.contains('jp-hidden')) {
                    togglePasswordForm();
                }

                // Store original values
                originalValues = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    nickName: document.getElementById('nickName').value,
                    language: document.getElementById('language').value,
                    theme: document.getElementById('theme').value
                };

                // Enable editing
                ['firstName', 'lastName', 'nickName'].forEach(id => {
                    const field = document.getElementById(id);
                    field.readOnly = false;
                    field.classList.remove('jp-read-only-field');
                });

                ['language', 'theme'].forEach(id => {
                    const field = document.getElementById(id);
                    field.disabled = false;
                    field.classList.remove('jp-read-only-field');
                });

                // Update buttons
                jPulseCommon.dom.hide(editBtn);
                jPulseCommon.dom.show(saveBtn);
                jPulseCommon.dom.show(cancelBtn);

                // Disable change password button during edit mode
                changePasswordBtn.disabled = true;
            } else {
                cancelEdit();
            }
        }

        function cancelEdit() {
            editMode = false;

            // Restore original values
            Object.keys(originalValues).forEach(key => {
                const field = document.getElementById(key);
                if (field) {
                    field.value = originalValues[key];
                }
            });

            // Disable editing
            ['firstName', 'lastName', 'nickName'].forEach(id => {
                const field = document.getElementById(id);
                field.readOnly = true;
                field.classList.add('jp-read-only-field');
            });

            ['language', 'theme'].forEach(id => {
                const field = document.getElementById(id);
                field.disabled = true;
                field.classList.add('jp-read-only-field');
            });

            // Update buttons
            jPulseCommon.dom.show(document.getElementById('editBtn'));
            jPulseCommon.dom.hide(document.getElementById('saveBtn'));
            jPulseCommon.dom.hide(document.getElementById('cancelBtn'));

            // Re-enable change password button
            document.getElementById('changePasswordBtn').disabled = false;
        }

        async function saveProfile() {
            const profileData = {
                profile: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    nickName: document.getElementById('nickName').value
                },
                preferences: {
                    language: document.getElementById('language').value,
                    theme: document.getElementById('theme').value
                }
            };

            const result = await jPulseCommon.api.put('/api/1/user/profile', profileData);

            if (result.success) {
                jPulseCommon.showSlideDownSuccess('{{i18n.view.user.profile.profileUpdatedSuccess}}');
                editMode = false;
                cancelEdit();
                // Reload fresh data from API
                await loadProfile();
            } else {
                jPulseCommon.showSlideDownError(result.error || '{{i18n.view.user.profile.failedToUpdateProfile}}');
            }
        }

        function togglePasswordForm() {
            const form = document.getElementById('passwordForm');
            const btn = document.getElementById('changePasswordBtn');
            const editBtn = document.getElementById('editBtn');

            if (form.classList.contains('jp-hidden')) {
                // If profile is in edit mode, exit edit mode first
                if (editMode) {
                    cancelEdit();
                }

                jPulseCommon.dom.show(form);
                btn.textContent = '{{i18n.view.user.profile.cancelPasswordChange}}';

                // Disable edit profile button while password form is active
                editBtn.disabled = true;
            } else {
                jPulseCommon.dom.hide(form);
                btn.textContent = '{{i18n.view.user.profile.changePassword}}';
                // Clear form
                form.reset();
                jPulseCommon.form.clearErrors(form);

                // Re-enable edit profile button
                editBtn.disabled = false;
            }
        }

        function validatePasswordForm(formElement) {
            const currentPassword = formElement.querySelector('#currentPassword').value;
            const newPassword = formElement.querySelector('#newPassword').value;
            const confirmPassword = formElement.querySelector('#confirmPassword').value;

            // Validate required fields
            if (!jPulseCommon.form.validate.required(currentPassword)) {
                jPulseCommon.showSlideDownError('{{i18n.view.user.profile.currentPasswordRequired}}');
                return false;
            }

            if (!jPulseCommon.form.validate.password(newPassword)) {
                jPulseCommon.showSlideDownError('{{i18n.view.user.profile.newPasswordTooShort}}');
                return false;
            }

            if (!jPulseCommon.form.validate.match(newPassword, confirmPassword)) {
                jPulseCommon.showSlideDownError('{{i18n.view.user.profile.passwordsDoNotMatch}}');
                formElement.querySelector('#confirmPassword').classList.add('jp-field-error');
                return false;
            }

            return true;
        }

        async function loadProfile() {
            try {
                const result = await jPulseCommon.api.get('/api/1/user/profile');
                if (result.success && result.data) {
                    const user = result.data;

                    // Update form fields
                    document.getElementById('firstName').value = user.profile?.firstName || '';
                    document.getElementById('lastName').value = user.profile?.lastName || '';
                    document.getElementById('nickName').value = user.profile?.nickName || '';
                    document.getElementById('email').value = user.email || '';

                    // Update preferences
                    document.getElementById('language').value = user.preferences?.language || 'en';
                    document.getElementById('theme').value = user.preferences?.theme || 'light';

                    // Update status badge
                    const statusBadge = document.querySelector('.jp-status-badge');
                    if (statusBadge && user.status) {
                        statusBadge.textContent = user.status.charAt(0).toUpperCase() + user.status.slice(1);
                        statusBadge.className = `jp-status-badge jp-status-${user.status}`;
                    }
                } else {
                    jPulseCommon.showSlideDownError(result.error || '{{i18n.view.user.profile.failedToLoadProfile}}');
                }
            } catch (error) {
                jPulseCommon.showSlideDownError('{{i18n.view.user.profile.networkErrorLoadingProfile}}: ' + error.message);
            }
        }

        async function loadLanguages() {
            try {
                const response = await jPulseCommon.api.get('/api/1/auth/languages');

                if (response.success) {
                    const languageSelect = document.getElementById('language');
                    const currentValue = languageSelect.value;

                    languageSelect.innerHTML = '';

                    const languages = response.data;
                    if (Array.isArray(languages)) {
                        languages.forEach(([code, name]) => {
                            const option = document.createElement('option');
                            option.value = code;
                            option.textContent = name;
                            languageSelect.appendChild(option);
                        });
                    } else {
                        console.error('Languages data is not an array:', languages);
                        jPulseCommon.showSlideDownError('Invalid language data format received from server');
                    }

                    languageSelect.value = currentValue;
                } else {
                    jPulseCommon.showSlideDownError('Failed to load language options: ' + (response.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load languages:', error);
                jPulseCommon.showSlideDownError('Failed to load language options. Please refresh the page.');
            }
        }

        async function loadThemes() {
            try {
                const response = await jPulseCommon.api.get('/api/1/auth/themes');

                if (response.success) {
                    const themeSelect = document.getElementById('theme');
                    const currentValue = themeSelect.value;

                    themeSelect.innerHTML = '';

                    const themes = response.data;
                    if (Array.isArray(themes)) {
                        themes.forEach(theme => {
                            const option = document.createElement('option');
                            option.value = theme;
                            option.textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
                            themeSelect.appendChild(option);
                        });
                    } else {
                        console.error('Themes data is not an array:', themes);
                        jPulseCommon.showSlideDownError('Invalid theme data format received from server');
                    }

                    themeSelect.value = currentValue;
                } else {
                    jPulseCommon.showSlideDownError('Failed to load theme options: ' + (response.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load themes:', error);
                jPulseCommon.showSlideDownError('Failed to load theme options. Please refresh the page.');
            }
        }

        // Update initialization
        document.addEventListener('DOMContentLoaded', function() {
            loadProfile();
            loadLanguages();
            loadThemes();
        });
    </script>

    {{file.include "jpulse-footer.tmpl"}}
</body>
</html>
