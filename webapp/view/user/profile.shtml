<!DOCTYPE html>
<!--
 * @name            jPulse Framework / WebApp / View / User Profile
 * @tagline         User profile view with edit capabilities
 * @description     User profile management with view and edit modes
 * @file            webapp/view/user/profile.shtml
 * @version         0.3.1
 * @release         2025-08-30
 * @repository      https://github.com/peterthoeny/jpulse-framework
 * @author          Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @copyright       2025 Peter Thoeny, https://twiki.org & https://github.com/peterthoeny/
 * @license         GPL v3, see LICENSE file
 * @genai           80%, Cursor 1.2, Claude Sonnet 4
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{app.version}} - {{i18n.user.profile.title}}</title>

    {{file.include "jpulse-header.tmpl"}}
    <style>
        /* Profile-specific styles */
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007acc;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007acc, #005999);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        .profile-info h1 {
            margin: 0;
            color: #333;
        }

        .profile-info .user-details {
            color: #666;
            margin: 5px 0;
        }

        .profile-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .profile-section h3 {
            margin-top: 0;
            color: #007acc;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #007acc;
            color: white;
        }

        .btn-primary:hover {
            background: #005999;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .read-only-field {
            background: #f8f9fa;
            color: #6c757d;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-suspended {
            background: #f5c6cb;
            color: #721c24;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="jpulse-main">
        <div class="profile-container">
          {{#if user.authenticated}}
            <div class="profile-header">
                <div class="profile-avatar">
                    {{user.initials}}
                </div>
                <div class="profile-info">
                    <h1>{{user.firstName}} {{user.lastName}}</h1>
                    <div class="user-details">@{{user.loginId}} • {{user.email}}</div>
                    <div class="user-details">
                        <span class="status-badge status-active">Active</span>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3>{{i18n.user.profile.personalInfo}}</h3>
                <form id="profileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">{{i18n.user.profile.firstName}}</label>
                            <input type="text" id="firstName" name="firstName" value="{{user.firstName}}" readonly class="read-only-field">
                        </div>
                        <div class="form-group">
                            <label for="lastName">{{i18n.user.profile.lastName}}</label>
                            <input type="text" id="lastName" name="lastName" value="{{user.lastName}}" readonly class="read-only-field">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nickName">{{i18n.user.profile.nickName}}</label>
                            <input type="text" id="nickName" name="nickName" value="{{user.nickName}}" readonly class="read-only-field">
                        </div>
                        <div class="form-group">
                            <label for="email">{{i18n.user.profile.email}}</label>
                            <input type="email" id="email" name="email" value="{{user.email}}" readonly class="read-only-field">
                        </div>
                    </div>
                </form>
            </div>

            <div class="profile-section">
                <h3>{{i18n.user.profile.preferences}}</h3>
                <form id="preferencesForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="language">{{i18n.user.profile.language}}</label>
                            <select id="language" name="language" disabled class="read-only-field">
                                <option value="en">English</option>
                                <option value="de">Deutsch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="theme">{{i18n.user.profile.theme}}</label>
                            <select id="theme" name="theme" disabled class="read-only-field">
                                <option value="light">{{i18n.user.profile.themeLight}}</option>
                                <option value="dark">{{i18n.user.profile.themeDark}}</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="profile-section">
                <h3>{{i18n.user.profile.security}}</h3>
                <div class="alert alert-info">
                    {{i18n.user.profile.securityNote}}
                </div>
                <form id="passwordForm" class="hidden">
                    <div class="form-group">
                        <label for="currentPassword">{{i18n.user.profile.currentPassword}}</label>
                        <input type="password" id="currentPassword" name="currentPassword" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newPassword">{{i18n.user.profile.newPassword}}</label>
                            <input type="password" id="newPassword" name="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">{{i18n.user.profile.confirmPassword}}</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required>
                        </div>
                    </div>
                </form>
            </div>

            <div class="btn-group">
                <button id="editBtn" class="btn btn-primary" onclick="toggleEditMode()">Edit Profile</button>
                <button id="saveBtn" class="btn btn-success hidden" onclick="saveProfile()">Save Changes</button>
                <button id="cancelBtn" class="btn btn-secondary hidden" onclick="cancelEdit()">Cancel</button>
                <button id="changePasswordBtn" class="btn btn-secondary" onclick="togglePasswordForm()">Change Password</button>
            </div>
          {{else}}
            <div class="alert alert-error">
                {{i18n.login.notAuthenticated}}
            </div>
          {{/if}}
        </div>
    </div>

    <script>
        let editMode = false;
        let originalValues = {};

        function toggleEditMode() {
            editMode = !editMode;
            const form = document.getElementById('profileForm');
            const prefsForm = document.getElementById('preferencesForm');
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            if (editMode) {
                // Store original values
                originalValues = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    nickName: document.getElementById('nickName').value,
                    language: document.getElementById('language').value,
                    theme: document.getElementById('theme').value
                };

                // Enable editing
                ['firstName', 'lastName', 'nickName'].forEach(id => {
                    const field = document.getElementById(id);
                    field.readOnly = false;
                    field.classList.remove('read-only-field');
                });

                ['language', 'theme'].forEach(id => {
                    const field = document.getElementById(id);
                    field.disabled = false;
                    field.classList.remove('read-only-field');
                });

                // Update buttons
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
            } else {
                cancelEdit();
            }
        }

        function cancelEdit() {
            editMode = false;

            // Restore original values
            Object.keys(originalValues).forEach(key => {
                const field = document.getElementById(key);
                if (field) {
                    field.value = originalValues[key];
                }
            });

            // Disable editing
            ['firstName', 'lastName', 'nickName'].forEach(id => {
                const field = document.getElementById(id);
                field.readOnly = true;
                field.classList.add('read-only-field');
            });

            ['language', 'theme'].forEach(id => {
                const field = document.getElementById(id);
                field.disabled = true;
                field.classList.add('read-only-field');
            });

            // Update buttons
            document.getElementById('editBtn').classList.remove('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
        }

        async function saveProfile() {
            const formData = {
                profile: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    nickName: document.getElementById('nickName').value
                },
                preferences: {
                    language: document.getElementById('language').value,
                    theme: document.getElementById('theme').value
                }
            };

            try {
                const response = await fetch('/api/1/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('Profile updated successfully!', 'success');
                    editMode = false;
                    cancelEdit();
                    // Reload fresh data from API
                    await loadProfileData();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'error');
            }
        }

        function togglePasswordForm() {
            const form = document.getElementById('passwordForm');
            const btn = document.getElementById('changePasswordBtn');

            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.textContent = 'Cancel Password Change';
            } else {
                form.classList.add('hidden');
                btn.textContent = '{{i18n.user.profile.changePassword}}';
                // Clear form
                form.reset();
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            const container = document.querySelector('.profile-container');
            container.insertBefore(alertDiv, container.firstChild);

            // Remove alert after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Load user profile data from API
        document.addEventListener('DOMContentLoaded', function() {
            loadProfileData();
        });

        async function loadProfileData() {
            try {
                const response = await fetch('/api/1/user/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const user = result.data;

                    // Update profile header
                    const initials = (user.profile?.firstName?.charAt(0) || '?') + (user.profile?.lastName?.charAt(0) || '');
                    document.querySelector('.profile-avatar').textContent = initials;
                    document.querySelector('.profile-info h1').textContent = `${user.profile?.firstName || ''} ${user.profile?.lastName || ''}`;
                    document.querySelector('.user-details').innerHTML = `@${user.loginId} • ${user.email}`;

                    // Update form fields
                    document.getElementById('firstName').value = user.profile?.firstName || '';
                    document.getElementById('lastName').value = user.profile?.lastName || '';
                    document.getElementById('nickName').value = user.profile?.nickName || '';
                    document.getElementById('email').value = user.email || '';

                    // Update preferences
                    document.getElementById('language').value = user.preferences?.language || 'en';
                    document.getElementById('theme').value = user.preferences?.theme || 'light';

                    // Update status badge if needed
                    const statusBadge = document.querySelector('.status-badge');
                    if (statusBadge && user.status) {
                        statusBadge.textContent = user.status.charAt(0).toUpperCase() + user.status.slice(1);
                        statusBadge.className = `status-badge status-${user.status}`;
                    }
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to load profile data', 'error');
                }
            } catch (error) {
                showAlert('Network error while loading profile: ' + error.message, 'error');
            }
        }
    </script>

    {{file.include "jpulse-footer.tmpl"}}
</body>
</html>
